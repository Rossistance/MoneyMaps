<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Maps - Web</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .main-container { display: flex; height: 100vh; }
        #map-container { flex-grow: 1; position: relative; }
        #sidebar { width: 450px; flex-shrink: 0; background-color: #ffffff; border-left: 1px solid #d1d5db; display: flex; flex-direction: column; }
        #sidebar-content { flex-grow: 1; overflow-y: auto; }
        .sidebar-view { display: none; }
        .sidebar-view.active { display: block; }
        #map { width: 100%; height: 100%; z-index: 10; background-color: #e5e7eb; }
        
        .custom-pin {
            width: 32px; height: 32px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .custom-pin:hover { transform: rotate(-45deg) scale(1.15); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .custom-pin svg { transform: rotate(45deg); width: 16px; height: 16px; color: white; }
        
        .leaflet-control-attribution { display: none !important; }
        .nav-btn { color: #4b5563; }
        .nav-btn.active { background-color: #e5e7eb; color: #111827; }
        .keypad-btn:active { background-color: #d1d5db; }
        #sidebar-content::-webkit-scrollbar, .category-filters::-webkit-scrollbar, #autocomplete-results::-webkit-scrollbar, .account-transactions::-webkit-scrollbar { width: 6px; height: 6px; }
        #sidebar-content::-webkit-scrollbar-thumb, .category-filters::-webkit-scrollbar-thumb, #autocomplete-results::-webkit-scrollbar-thumb, .account-transactions::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        #sidebar-content::-webkit-scrollbar-track, .category-filters::-webkit-scrollbar-track, #autocomplete-results::-webkit-scrollbar-track, .account-transactions::-webkit-scrollbar-track { background: #e5e7eb; }

        .loader { border: 4px solid #d1d5db; border-radius: 50%; border-top: 4px solid #4f46e5; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sankey-link { fill: none; stroke-opacity: 0.5; } .sankey-link:hover { stroke-opacity: 0.8; } .sankey-node rect { stroke: #ffffff; stroke-width: 2px; }
        .sub-budget-list, .account-transactions { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="map-container">
            <div id="map"></div>
            <div class="absolute top-0 left-0 right-0 p-4 z-20 space-y-2">
                <div class="max-w-xl mx-auto">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search city, state, or business..." class="w-full pl-10 pr-4 py-3 bg-white/90 backdrop-blur-sm border border-gray-300 rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 placeholder-gray-500">
                        <div class="absolute top-1/2 left-3 -translate-y-1/2 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <div id="autocomplete-results" class="absolute top-full left-0 right-0 mt-2 bg-white/95 backdrop-blur-sm border border-gray-300 rounded-xl shadow-lg z-30 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
                    </div>
                    <div id="category-filters-container" class="category-filters flex items-center space-x-2 overflow-x-auto p-2 bg-white/90 backdrop-blur-sm rounded-xl mt-2 shadow-lg border border-gray-200"></div>
                </div>
            </div>
            <div id="map-loader" class="absolute inset-0 bg-white/50 z-30 items-center justify-center hidden"><div class="loader"></div></div>
        </div>

        <div id="sidebar">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-3xl font-bold text-indigo-600">Money Maps</h1>
            </div>
            <div id="sidebar-nav" class="grid grid-cols-3 gap-2 p-2 border-b border-gray-200">
                <button class="nav-btn active flex items-center justify-center p-2 rounded-lg font-semibold text-sm transition-colors" data-view="budget-view">Budget</button>
                <button class="nav-btn flex items-center justify-center p-2 rounded-lg font-semibold text-sm transition-colors" data-view="transactions-view">Transactions</button>
                <button class="nav-btn flex items-center justify-center p-2 rounded-lg font-semibold text-sm transition-colors" data-view="accounts-view">Accounts</button>
            </div>

            <div id="sidebar-content">
                <!-- Budget View -->
                <div id="budget-view" class="sidebar-view active p-4">
                    <div id="prediction-view" class="mb-4"></div>
                    <div id="sankey-hero-container" class="mt-2 p-2 h-48 cursor-pointer flex items-center justify-center bg-gray-100 rounded-xl"><svg id="sankey-hero" class="w-full h-full"></svg></div>
                    <h2 class="text-xl font-bold text-gray-800 px-2 mt-6">Fund Flows</h2>
                    <div id="budget-list" class="mt-2 space-y-1 px-2"></div>
                    <h2 class="text-xl font-bold text-gray-800 px-2 mt-6">Savings</h2>
                    <div id="savings-list" class="mt-2 space-y-3 px-2"></div>
                </div>

                <!-- Transactions View -->
                <div id="transactions-view" class="sidebar-view">
                     <div class="p-4 bg-gray-50 border-b border-gray-200 sticky top-0">
                        <div class="flex justify-between items-end mt-2">
                             <div><p class="text-sm text-gray-500">Net Flow (Family Checking)</p><p id="net-flow-display" class="text-2xl font-bold"></p></div>
                             <div class="text-right"><p class="text-sm text-gray-500">Total Spent (Family Checking)</p><p id="total-spent" class="text-2xl font-bold text-red-600"></p></div>
                        </div>
                    </div>
                    <div id="transactions-by-account-list" class="p-4 space-y-4"></div>
                </div>
                
                <!-- Accounts View -->
                <div id="accounts-view" class="sidebar-view p-4">
                    <div id="accounts-list" class="space-y-4"></div>
                </div>

                <!-- Place Detail View -->
                <div id="place-detail-view" class="sidebar-view"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // =================================================================================
        // API KEY & DATA INITIALIZATION
        // =================================================================================
        const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';

        let map, currentPlace = null, currentAmountString = "0", mapMarkers = [], searchTimeout, activeCategory = 'all';

        let accountsData = {};
        let budgetStructure = {};
        let allTransactions = [];

        const tailwindColors = { 'red-500': '#ef4444', 'green-500': '#22c55e', 'yellow-500': '#eab308', 'purple-500': '#a855f7', 'blue-500': '#3b82f6', 'cyan-500': '#06b6d4', 'indigo-500': '#6366f1', 'pink-500': '#ec4899', 'teal-500': '#14b8a6', 'amber-500': '#f59e0b', 'emerald-500': '#10b981', 'gray-500': '#6b7280', 'green-600': '#16a34a', 'lime-500': '#84cc16' };
        const categoryIcons = { 'dining': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6v8h3v8h-3v-2h-2v2H6v-2H3v2H0v-8h3V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2zM6 6v8h8V6H6z"/></svg>`, 'groceries': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zm-1.45-5c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0 0 20.25 4H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.24 17 6.5 17H20v-2H7.42c-.13 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45z"/></svg>`, 'shopping': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v12z"/></svg>`, 'gas': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C10.34 3 9 4.34 9 6H5v12h14V6h-4c0-1.66-1.34-3-3-3zm0 2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-3 5H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>`, 'entertainment': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>`, 'health': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 11h-3v3h-2v-3H8v-2h3V8h2v3h3v2z"/></svg>`, 'default': `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>` };
        const hereCategoryMap = { 'dining': '100-1000', 'groceries': '100-1011-0052,700-7000-0000', 'gas': '100-1019,400-4000-0000', 'shopping': '600-6000-0000', 'entertainment': '300-3000-0000', 'health': '500-5000-0000' };

        // --- UTILITIES ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const debounce = (func, delay) => { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; };
        const slugify = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

        // --- DATA PROCESSING & CATEGORIZATION ---
        function processAndLoadData() {
            const accountsCsv = `Family Checking,3087.09\nBusiness Expense Checking,307.42\nFamily Savings,17358.16\nMortgage Contingency,2870`;
            accountsCsv.split('\n').forEach(row => {
                const [name, balance] = row.split(',');
                const id = slugify(name);
                accountsData[id] = { name, type: name.toLowerCase().includes('savings') ? 'Savings' : 'Checking', initialBalance: parseFloat(balance) };
            });

            const budgetItemToParentMap = {
                'mortgage-rent': 'household', 'home-warranty': 'household', 'diapers': 'household', 'pet-care': 'household',
                'electricity-epb': 'utilities', 'gas-chattanoogagasco': 'utilities', 'water-eastside-utility': 'utilities', 'internet-epb': 'utilities', 'trash-c-m-disposal': 'utilities', 'phone-payment': 'utilities',
                'car-payment': 'transportation', 'gasoline': 'transportation',
                'dining-out-restaurant-fast-food': 'food', 'groceries': 'food',
                'subscriptions': 'entertainment-shopping', 'entertainment-shopping-main': 'entertainment-shopping',
                'medical-copays-pharmacy': 'health-medical', 'therapist': 'health-medical', 'care-payment-hospital': 'health-medical',
                'insurance-farmers': 'insurance',
                'childcare-school-fees': 'fees'
            };
            
            budgetStructure = {
                'household': { name: 'Household Expenses', items: {} }, 'utilities': { name: 'Utilities', items: {} }, 'transportation': { name: 'Transportation', items: {} }, 'food': { name: 'Food & Dining', items: {} }, 'entertainment-shopping': { name: 'Entertainment & Shopping', items: {} }, 'health-medical': { name: 'Health & Medical', items: {} }, 'insurance': { name: 'Insurance', items: {} }, 'fees': { name: 'Fees & Childcare', items: {} },
                'income': { name: 'Income', items: {}, total: 7684 }, 'transfers': { name: 'Transfers', items: {} }, 'miscellaneous': { name: 'Miscellaneous', items: {} }
            };

            const familyBudgetCsv = `Category,Estimated Monthly Cost ($)\nMortgage/Rent,2900\nCar Payment,900\nElectricity (EPB),161\nGas (ChattanoogaGasCo),133\nWater (Eastside Utility),32.64\nInternet(EPB),67.99\nTrash (C&M Disposal),64\nInsurance (Farmers),327.7\nHome Warranty,45\nCare Payment(Hospital),45\nDiapers,60\nTherapist,100\nPhone Payment,120\nPet Care,50\nGroceries,525\nGasoline,50\nDining Out (Restaurant/Fast Food),100\n"Medical (Copays, Pharmacy)",65\nSubscriptions,50\nChildcare/School Fees,1584\nEntertainment/Shopping,100\nMiscellaneous,50`;
            const budgetRows = familyBudgetCsv.split('\n').slice(1);
            budgetRows.forEach(row => {
                const [name, totalStr] = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const cleanName = name.trim().replace(/"/g, '');
                const itemKey = slugify(cleanName);
                const parentKey = budgetItemToParentMap[itemKey];
                if (parentKey && budgetStructure[parentKey]) {
                    budgetStructure[parentKey].items[itemKey] = { name: cleanName, total: parseFloat(totalStr) };
                } else {
                    if (!budgetStructure.miscellaneous.items.miscellaneous) budgetStructure.miscellaneous.items.miscellaneous = { name: 'Miscellaneous', total: 0, spent: 0 };
                    budgetStructure.miscellaneous.items[itemKey] = { name: cleanName, total: parseFloat(totalStr) || 0 };
                }
            });
             budgetStructure['entertainment-shopping'].items['entertainment-shopping-main'] = { name: 'Entertainment/Shopping', total: 100 };
            
            const fullTransactionData = {
                'family-checking': `"Transaction ID","Posting Date","Effective Date","Transaction Type","Amount","Check Number","Reference Number","Description","Transaction Category","Type","Balance","Memo","Extended Description"\n"202510143714726904916026","10/14/2025","10/14/2025","Debit","-69.04000","","293031916","Withdrawal Debit Card Consumer Debit  CHATTANOOGA GOODWILL CHATTANOOGA TN Date 10/13/25 24073145287900016200297 5931","","Card","3096.88000","",""\n"2025010137147250001243240","1/1/2025","1/1/2025","Debit","-50.00000","","237843426","Withdrawal Consumer Debit VENMO *Jeremy O'Rear Visa Direct NY Date XX 4829","Transfers","Card","4086.62000","",""\n"20250101371472125001208312","1/1/2025","1/1/2025","Debit","-125.00000","","237843425","Withdrawal at ATM #XX4044 ATM TVFCU 7442 COMMONS BLVD CHATTANOOGA TN","ATM/Cash Withdrawals","ATM","4136.62000","haircut and color",""\n"20251010371472214567910749","10/10/2025","10/10/2025","Credit","2145.67","","292541138","Axis Energy Payroll Deposit",,"ACH","5000.00000","",""`,
                'business-expense-checking': `"Transaction ID","Posting Date","Effective Date","Transaction Type","Amount","Check Number","Reference Number","Description","Transaction Category","Type","Balance","Memo","Extended Description"\n"202510145226632100908630","10/14/2025","10/14/2025","Debit","-21.00000","","293031850","Withdrawal Debit Card Consumer Debit  RDUAA PUBLIC PARKING MORRISVILLE NC Date 10/13/25 24015145287111550019546 7523","","Card","434.04000","",""\n"2025092252266342550772193","9/22/2025","9/21/2025","Debit","-425.50000","","288626304","Turo","Travel & Commute","POS","1387.07000","",""\n"202509205226635900785595","9/20/2025","9/20/2025","Debit","-59.00000","","288351860","Payment to Allianz Global Assistance","Insurance","Card","1812.57000","",""`,
                'family-savings': `"Transaction ID","Posting Date","Effective Date","Transaction Type","Amount","Check Number","Reference Number","Description","Transaction Category","Type","Balance","Memo","Extended Description"\n"202510137436150000230002","10/13/2025","10/13/2025","Debit","-500.00000","","292753845","Withdrawal Home Banking Transfer To Share 0012 Work trip payback","Transfers","Retail ACH","17358.16000","",""\n"202504017436189145002","4/1/2025","4/1/2025","Credit","0.89000","","254701279","Deposit Dividend 0.300%",Investment Income,Dividends,"4299.86000","",""`,
                'mortgage-contingency': `"Transaction ID","Posting Date","Effective Date","Transaction Type","Amount","Check Number","Reference Number","Description","Transaction Category","Type","Balance","Memo","Extended Description"\n"20251003527840287000928687","10/3/2025","10/3/2025","Credit","2870.00000","","290927726","Deposit EXTRA MORTGAGE",Deposits,"Transfer","2870.00000","",""`
            };

            const categoryKeywords = {
                'mortgage-rent': ['MORTGAGE'], 'car-payment': ['CAR PAYMENT'], 'electricity-epb': ['EPB'], 'gas-chattanoogagasco': ['GASCO'], 'water-eastside-utility': ['EASTSIDE UTILITY'], 'internet-epb': ['EPB INTERNET'], 'trash-c-m-disposal': ['C&M DISPOSAL'], 'insurance-farmers': ['FARMERS', 'ALLIANZ'], 'home-warranty': ['HOME WARRANTY'], 'care-payment-hospital': ['HOSPITAL'], 'diapers': ['DIAPERS'], 'therapist': ['THERAPIST'], 'phone-payment': ['VERIZON', 'AT&T', 'T-MOBILE'], 'pet-care': ['PETCO', 'PETSMART'], 'groceries': ['KROGER', 'PUBLIX', 'WHOLE FOODS', 'TRADER JOE'], 'gasoline': ['SHELL', 'EXXON', 'BP', 'GAS', 'REFUEL', 'RDUAA'], 'dining-out-restaurant-fast-food': ['RESTAURANT', 'CAFE', 'STARBUCKS', 'MCDONALD'], 'medical-copays-pharmacy': ['CVS', 'WALGREENS', 'PHARMACY'], 'subscriptions': ['NETFLIX', 'SPOTIFY', 'AMAZON PRIME'], 'childcare-school-fees': ['CHILDCARE', 'SCHOOL'], 'entertainment-shopping-main': ['TARGET', 'WALMART', 'AMAZON', 'GOODWILL', 'REGAL', 'TURO'], 'transfers': ['VENMO', 'TRANSFER', 'ZELLE'], 'income': ['PAYROLL', 'DEPOSIT', 'AXIS ENERGY'],
            };
            
            function getCategoryForTransaction(description, bankCategory) {
                const desc = description.toUpperCase();
                for (const itemKey in categoryKeywords) {
                    for (const keyword of categoryKeywords[itemKey]) {
                        if (desc.includes(keyword)) return itemKey;
                    }
                }
                if (bankCategory && bankCategory.toLowerCase().includes('insurance')) return 'insurance-farmers';
                if (bankCategory && bankCategory.toLowerCase().includes('transfer')) return 'transfers';
                return 'miscellaneous';
            }

            const descriptionCleaners = ["Withdrawal Debit Card Consumer Debit", "Withdrawal Consumer Debit", "Withdrawal at ATM", "Payment to", "Deposit"];
            
            for (const accountId in fullTransactionData) {
                const rows = fullTransactionData[accountId].trim().split('\n').slice(1);
                rows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
                    if (cols.length < 11) return;
                    const [ , postDate, , txType, amountStr, , , desc, origCat, , balanceStr] = cols;
                    
                    let cleanDesc = desc;
                    descriptionCleaners.forEach(cleaner => {
                        if (cleanDesc.startsWith(cleaner)) {
                            cleanDesc = cleanDesc.substring(cleaner.length).trim();
                        }
                    });
                    cleanDesc = cleanDesc.replace(/Date .*/, '').trim();

                    const transaction = {
                        accountId: accountId, name: cleanDesc || desc, amount: Math.abs(parseFloat(amountStr)), type: txType.toLowerCase(), date: new Date(postDate).toISOString().split('T')[0], category: getCategoryForTransaction(desc, origCat), balance: parseFloat(balanceStr)
                    };
                    allTransactions.push(transaction);
                });
            }
        }
        
        // --- MAP & API LOGIC ---
        function clearMarkers() { if(map) { mapMarkers.forEach(({ marker }) => marker.removeFrom(map)); mapMarkers = []; } }
        function categoryForHereResult(item) { if (!item || !Array.isArray(item.categories)) return 'uncategorized'; for (const c of item.categories) { if (c && c.id) for (const appCat in hereCategoryMap) { const hereKeys = hereCategoryMap[appCat].split(','); if (hereKeys.some(key => c.id.startsWith(key))) return appCat; } } return 'uncategorized'; }
        async function searchPlaces() { /* Unchanged */ }
        async function getAutocompleteSuggestions() { /* Unchanged */ }
        async function selectSuggestion(id, resultType) { /* Unchanged */ }
        function addPlacesToMap(items) { /* Unchanged */ }

        // --- RENDERING & CALCULATION ---
        function renderAllViews() {
            calculateAllBudgets();
            if (document.getElementById('budget-view').classList.contains('active')) renderBudgetView();
            if (document.getElementById('transactions-view').classList.contains('active')) renderTransactionsView();
            if (document.getElementById('accounts-view').classList.contains('active')) renderAccountsView();
            if (document.getElementById('place-detail-view').classList.contains('active') && currentPlace) renderPlaceDetailView(currentPlace);
        }
        
        function calculateAllBudgets() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const familyCheckingTxs = allTransactions.filter(t => t.accountId === 'family-checking');
            
            for (const parentKey in budgetStructure) {
                let parentSpent = 0;
                const parent = budgetStructure[parentKey];
                if (!parent.items) continue;

                for (const itemKey in parent.items) {
                    const item = parent.items[itemKey];
                    const spent = familyCheckingTxs
                        .filter(t => {
                            const txDate = new Date(t.date);
                            return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && t.category === itemKey && t.type === 'debit';
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                    item.spent = spent;
                    parentSpent += spent;
                }
                parent.spent = parentSpent;
                parent.total = Object.values(parent.items).reduce((sum, item) => sum + (item.total || 0), 0);
            }
        }
        
        function getAccountBalance(accountId) {
            const accountTransactions = allTransactions.filter(t => t.accountId === accountId);
            if (accountTransactions.length > 0) {
                return accountTransactions.sort((a,b) => new Date(b.date) - new Date(a.date))[0].balance;
            }
            return accountsData[accountId].initialBalance;
        }

        function renderBudgetView() {
            renderPredictionView();
            const bList = document.getElementById('budget-list');
            bList.innerHTML = Object.entries(budgetStructure).filter(([_, p]) => p.total > 0 && p.name !== 'Income').map(([parentKey, parent]) => {
                const parentProgress = parent.total > 0 ? Math.min(100, (parent.spent / parent.total) * 100) : 0;
                const subItemsHtml = Object.entries(parent.items).map(([itemKey, item]) => {
                    const itemProgress = item.total > 0 ? Math.min(100, (item.spent / item.total) * 100) : 0;
                    return `
                        <div class="ml-4 pl-4 border-l-2 border-gray-200 py-2">
                            <div class="flex justify-between items-center text-xs mb-1">
                                <span class="font-medium text-gray-700">${item.name}</span>
                                <span class="text-gray-500">${formatCurrency(item.spent)} / ${formatCurrency(item.total)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-indigo-600 h-1.5 rounded-full" style="width: ${itemProgress}%"></div></div>
                        </div>`;
                }).join('');

                return `
                    <div class="bg-white rounded-lg border border-gray-200">
                        <button class="w-full text-left p-3 flex justify-between items-center budget-parent-toggle" data-target="${parentKey}-items">
                            <div>
                                <p class="font-semibold text-gray-800">${parent.name}</p>
                                <p class="text-sm text-gray-500">${formatCurrency(parent.spent)} of ${formatCurrency(parent.total)}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="w-full bg-gray-200 h-2 mx-auto" style="width: 95%;"><div class="bg-indigo-600 h-2 rounded-full" style="width: ${parentProgress}%"></div></div>
                        <div id="${parentKey}-items" class="sub-budget-list">${subItemsHtml}</div>
                    </div>`;
            }).join('');
            
            const savingsList = document.getElementById('savings-list');
            savingsList.innerHTML = `
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <p class="font-semibold text-gray-800">Pure Savings</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">${formatCurrency(getAccountBalance('family-savings'))}</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <p class="font-semibold text-gray-800">Hail Mary Money</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${formatCurrency(getAccountBalance('mortgage-contingency'))}</p>
                </div>
            `;
            createSankey(document.getElementById('sankey-hero'));
        }
        
        function renderAccountsView() {
            const listEl = document.getElementById('accounts-list');
            let totalAssets = 0;
            const accountHtml = Object.entries(accountsData).map(([id, account]) => {
                const currentBalance = getAccountBalance(id);
                totalAssets += currentBalance;
                return `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${account.name}</p>
                                <p class="text-sm text-gray-500">${account.type}</p>
                            </div>
                            <p class="text-2xl font-bold text-green-600">${formatCurrency(currentBalance)}</p>
                        </div>
                    </div>`;
            }).join('');

            const summaryHtml = `<div class="bg-white border-2 border-indigo-500 p-4 rounded-lg mb-6"><p class="text-sm font-medium text-indigo-700">Total Net Worth</p><p class="text-4xl font-extrabold text-gray-900 mt-1">${formatCurrency(totalAssets)}</p></div><h2 class="text-xl font-bold text-gray-800 mb-4">Your Accounts</h2>`;
            listEl.innerHTML = summaryHtml + accountHtml;
        }

        function renderTransactionsView() {
            const listEl = document.getElementById('transactions-by-account-list');
            const netEl = document.getElementById('net-flow-display');
            const spentEl = document.getElementById('total-spent');

            const thisMonth = new Date().getMonth(), thisYear = new Date().getFullYear();
            const familyCheckingTxs = allTransactions.filter(t => t.accountId === 'family-checking');
            const monthTxs = familyCheckingTxs.filter(t => { const d = new Date(t.date); return d.getMonth() === thisMonth && d.getFullYear() === thisYear; });

            const totalSpent = monthTxs.filter(t => t.type === 'debit').reduce((s, t) => s + t.amount, 0);
            const totalEarned = monthTxs.filter(t => t.type === 'credit').reduce((s, t) => s + t.amount, 0);
            const netFlow = totalEarned - totalSpent;

            spentEl.textContent = formatCurrency(totalSpent);
            netEl.textContent = formatCurrency(netFlow);
            netEl.classList.toggle('text-green-600', netFlow >= 0);
            netEl.classList.toggle('text-red-600', netFlow < 0);
            
            listEl.innerHTML = Object.entries(accountsData).map(([accountId, account]) => {
                const accountTxs = allTransactions.filter(t => t.accountId === accountId).sort((a,b) => new Date(b.date) - new Date(a.date));
                const grouped = accountTxs.reduce((acc, t) => {
                    const d = new Date(t.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    if (!acc[d]) acc[d] = []; acc[d].push(t); return acc;
                }, {});

                const txHtml = Object.entries(grouped).map(([date, transactions]) => `
                    <div>
                        <h3 class="font-bold text-gray-500 text-sm my-2">${date}</h3>
                        <div class="space-y-2">
                            ${transactions.map(t => {
                                 let categoryName = 'Miscellaneous';
                                 for (const parent of Object.values(budgetStructure)) {
                                     if (parent.items && parent.items[t.category]) { categoryName = parent.items[t.category].name; break; }
                                 }
                                return `<div class="flex items-center bg-white border border-gray-200 p-3 rounded-lg">
                                    <div class="flex-grow"><p class="font-semibold text-gray-800">${t.name}</p><p class="text-xs text-gray-500">${categoryName}</p></div>
                                    <div class="font-semibold ${t.type === 'credit' ? 'text-green-600' : 'text-gray-800'}">${t.type === 'credit' ? '+' : ''}${formatCurrency(t.amount)}</div>
                                </div>`
                            }).join('')}
                        </div>
                    </div>`).join('');
                
                return `
                    <div class="bg-gray-100 rounded-lg border border-gray-200">
                        <button class="w-full text-left p-3 flex justify-between items-center budget-parent-toggle" data-target="${accountId}-txs">
                            <p class="font-semibold text-gray-800">${account.name}</p>
                            <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="${accountId}-txs" class="account-transactions px-4 pb-4" style="max-height: 300px; overflow-y: auto;">${txHtml || '<p class="text-sm text-gray-500">No transactions to display.</p>'}</div>
                    </div>`;
            }).join('');
        }
        
        function renderPredictionView() {
            const container = document.getElementById('prediction-view');
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dayOfMonth = today.getDate();
            const daysRemaining = daysInMonth - dayOfMonth;

            const familyCheckingTxs = allTransactions.filter(t => t.accountId === 'family-checking');
            const monthTxs = familyCheckingTxs.filter(t => { const d = new Date(t.date); return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear(); });
            
            const spentSoFar = monthTxs.filter(t => t.type === 'debit' && t.category !== 'transfers').reduce((sum, t) => sum + t.amount, 0);
            const dailyAvgSpend = spentSoFar / dayOfMonth;
            const projectedSpend = spentSoFar + (dailyAvgSpend * daysRemaining);
            const totalBudget = Object.values(budgetStructure).reduce((sum, parent) => sum + (parent.total || 0), 0) - (budgetStructure.income.total || 0);
            
            const onBudget = projectedSpend <= totalBudget;
            const statusColor = onBudget ? 'green' : 'red';
            
            container.innerHTML = `
                <div class="bg-white border-2 border-${statusColor}-500 p-4 rounded-lg">
                    <p class="text-sm font-medium text-${statusColor}-700">End of Month Projection</p>
                    <div class="flex justify-between items-baseline mt-1">
                        <p class="text-3xl font-extrabold text-gray-900">${formatCurrency(projectedSpend)}</p>
                        <p class="font-semibold text-${statusColor}-600">${onBudget ? 'On Budget' : 'Off Budget'}</p>
                    </div>
                    ${!onBudget ? '<button id="suggestion-btn" class="mt-3 w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-800 font-bold py-2 px-4 rounded-lg text-sm">Get Actionable Suggestions</button>' : ''}
                </div>`;
        }

        function showSuggestionModal() {
            const today = new Date();
            const percentOfMonthPassed = today.getDate() / new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            const overspentCategories = Object.entries(budgetStructure)
                .filter(([key, parent]) => parent.total > 0)
                .map(([key, parent]) => {
                    const percentSpent = parent.spent / parent.total;
                    return { name: parent.name, overage: percentSpent - percentOfMonthPassed, spent: parent.spent, total: parent.total };
                })
                .filter(c => c.overage > 0.1) // More than 10% over the expected pace
                .sort((a,b) => b.overage - a.overage);

            let suggestionsHtml = '<p class="text-sm text-gray-600">No specific suggestions at this time. Keep up the good work!</p>';
            if (overspentCategories.length > 0) {
                suggestionsHtml = `
                    <p class="text-sm text-gray-600 mb-4">You are spending faster than expected in these areas. Consider reducing spending here for the rest of the month:</p>
                    <ul class="space-y-3">
                        ${overspentCategories.slice(0, 3).map(c => `
                            <li class="p-3 bg-gray-100 rounded-lg">
                                <p class="font-semibold text-red-600">${c.name}</p>
                                <p class="text-xs text-gray-600">You've spent ${formatCurrency(c.spent)} of ${formatCurrency(c.total)} (${(c.spent/c.total*100).toFixed(0)}%), which is ahead of schedule.</p>
                            </li>
                        `).join('')}
                    </ul>`;
            }

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="suggestion-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Actionable Suggestions</h2>
                        ${suggestionsHtml}
                        <button id="close-suggestion-modal" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition">Close</button>
                    </div>
                </div>
            `;
        }
        
        // --- Remaining dummy functions ---
        function createSankey(svgEl) {}
        
        // --- INITIALIZATION & EVENT LISTENERS ---
        function initializeMap() { 
            const fallbackPos = [35.0456, -85.3097];
            if (document.getElementById('map')._leaflet_id) return;
            map = L.map('map', { center: fallbackPos, zoom: 9, zoomControl: false, attributionControl: false }); 
            L.tileLayer(`https://2.base.maps.ls.hereapi.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?apiKey=${HERE_API_KEY}`, { attribution: '&copy; HERE' }).addTo(map); 
        }
        
        function renderCategoryFilters() {
            const filtersContainer = document.getElementById('category-filters-container');
            const genericCategories = { 'dining': 'Dining', 'shopping': 'Shopping', 'groceries': 'Groceries', 'gas': 'Gas', 'entertainment': 'Entertainment', 'health': 'Health' };
            let filterHtml = `<button class="category-filter-btn text-sm font-semibold whitespace-nowrap px-4 py-1.5 rounded-full transition-colors bg-gray-200 text-gray-700" data-category="all">All</button>`;
            Object.entries(genericCategories).forEach(([key, name]) => {
                filterHtml += `<button class="category-filter-btn text-sm font-semibold whitespace-nowrap px-4 py-1.5 rounded-full transition-colors bg-gray-200 text-gray-700" data-category="${key}">${name}</button>`;
            });
            filtersContainer.innerHTML = filterHtml;
            updateActiveFilterButton();
        }

        function updateActiveFilterButton() {
            document.querySelectorAll('.category-filter-btn').forEach(b => {
                const isActive = b.dataset.category === activeCategory;
                b.classList.toggle('bg-indigo-600', isActive);
                b.classList.toggle('text-white', isActive);
                b.classList.toggle('bg-gray-200', !isActive);
                b.classList.toggle('text-gray-700', !isActive);
            });
        }
        
        function switchSidebarView(viewId) {
            document.querySelectorAll('.sidebar-view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.view === viewId);
            });
            renderAllViews();
        }

        document.addEventListener('DOMContentLoaded', () => {
             processAndLoadData();
             initializeMap();
             renderCategoryFilters();
             renderAllViews();
            
             document.body.addEventListener('click', (e) => {
                 const target = e.target;
                 if(target.closest('.budget-parent-toggle')) {
                     const sublistId = target.closest('.budget-parent-toggle').dataset.target;
                     const sublist = document.getElementById(sublistId);
                     const icon = target.closest('.budget-parent-toggle').querySelector('svg');
                     if (sublist.style.maxHeight && sublist.style.maxHeight !== '0px') {
                         sublist.style.maxHeight = null;
                         icon.style.transform = 'rotate(0deg)';
                     } else {
                         sublist.style.maxHeight = sublist.scrollHeight + "px";
                         icon.style.transform = 'rotate(180deg)';
                     }
                     return;
                 }
                 if(target.closest('.nav-btn')) { switchSidebarView(target.closest('.nav-btn').dataset.view); return; }
                 if(target.closest('.category-filter-btn')) { activeCategory = target.closest('.category-filter-btn').dataset.category; updateActiveFilterButton(); if(map) searchPlaces(); return; }
                 if(target.closest('#suggestion-btn')) { showSuggestionModal(); return; }
                 if(target.closest('#close-suggestion-modal') || e.target.id === 'suggestion-modal') { document.getElementById('modal-container').innerHTML = ''; return; }
             });
        });
    </script>
</body>
</html>

