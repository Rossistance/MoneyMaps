<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Maps - Unified Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/d3@7"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: light; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #f3f4f6; }
        body { overflow: hidden; }
        #desktop-view, #mobile-view { height: 100%; }
        #map, #mobile-map { height: 100%; width: 100%; }
        .sidebar-view { display: none; }
        .sidebar-view.active { display: block; }
        .nav-btn.active {
            background: linear-gradient(90deg,#e0e7ff,#c7d2fe);
            color: #1d4ed8;
        }
        .category-bar { position: relative; height: 120px; }
        .category-bar canvas { width: 100%; height: 100%; }
        .gradient-pin { background: white; border-radius: 9999px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border: 3px solid rgba(15,23,42,0.15); box-shadow: 0 12px 24px rgba(15,23,42,0.18); }
        .gradient-pin svg { width: 22px; height: 22px; }
        .timeline-wrapper { border-radius: 1.25rem; overflow: hidden; background: linear-gradient(135deg,#1f2937,#111827); box-shadow: 0 25px 50px -12px rgba(15,23,42,0.45); }
        .modal-backdrop { background: rgba(15,23,42,0.65); }
        @media (max-width: 1023px) { body { overflow: auto; } }
    </style>
</head>
<body class="text-gray-900">
    <div id="desktop-view" class="hidden lg:flex">
        <div id="map-container" class="flex-1 relative">
            <div id="map" class="z-10"></div>
            <div class="absolute top-0 left-0 right-0 p-4 space-y-3 z-20 pointer-events-none">
                <div class="max-w-xl mx-auto pointer-events-auto">
                    <div class="relative">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35m0 0A7.5 7.5 0 1 0 5.25 5.25a7.5 7.5 0 0 0 11.4 11.4Z" /></svg>
                        </div>
                        <input id="search-input" class="w-full pl-11 pr-4 py-3 rounded-2xl shadow-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search for places or addresses" />
                        <div id="autocomplete-results" class="absolute top-full left-0 right-0 mt-2 rounded-xl shadow-xl bg-white hidden overflow-hidden max-h-72 overflow-y-auto z-30"></div>
                    </div>
                    <div id="category-filters-container" class="mt-2 flex items-center space-x-2 overflow-x-auto p-2 bg-white/80 backdrop-blur rounded-2xl shadow-lg"></div>
                </div>
            </div>
            <div id="map-loader" class="absolute inset-0 hidden items-center justify-center bg-white/60 z-30"><div class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full"></div></div>
            <div id="map-place-card" class="hidden pointer-events-none absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-lg px-4 z-30">
                <div class="pointer-events-auto rounded-3xl bg-white shadow-2xl border border-slate-100 p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p id="place-card-title" class="text-lg font-semibold text-slate-900"></p>
                            <p id="place-card-address" class="text-sm text-slate-500"></p>
                        </div>
                        <button id="close-place-card" class="text-slate-400 hover:text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <select id="place-card-category" class="flex-1 border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"></select>
                        <button id="place-card-assign" class="p-2 rounded-full bg-blue-100 text-blue-600" aria-label="Assign to category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5m6.75-6.75H5.25"/></svg>
                        </button>
                        <button id="place-card-create" class="p-2 rounded-full bg-slate-100 text-slate-600" aria-label="Create sub-category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                        </button>
                    </div>
                    <p id="place-card-status" class="text-xs uppercase tracking-wide text-slate-400"></p>
                </div>
            </div>
        </div>
        <aside id="sidebar" class="w-[440px] bg-white shadow-2xl flex flex-col">
            <header class="p-5 border-b border-gray-100">
                <h1 class="text-2xl font-bold">Money Maps</h1>
                <p class="text-sm text-gray-500">Plan, connect, and visualize your finances</p>
            </header>
            <nav id="sidebar-nav" class="grid grid-cols-3 gap-2 p-3 bg-gray-50 border-b border-gray-100">
                <button class="nav-btn active flex items-center justify-center py-2 rounded-xl text-sm font-semibold text-blue-700 bg-blue-50" data-view="budget-view">Budget</button>
                <button class="nav-btn flex items-center justify-center py-2 rounded-xl text-sm font-semibold text-gray-500" data-view="accounts-view">Accounts</button>
                <button class="nav-btn flex items-center justify-center py-2 rounded-xl text-sm font-semibold text-gray-500" data-view="transactions-view">History</button>
            </nav>
            <section id="sidebar-content" class="flex-1 overflow-y-auto">
                <div id="budget-view" class="sidebar-view active p-5 space-y-6">
                    <div class="timeline-wrapper">
                        <div id="timeline-canvas" class="h-[280px]"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Fund flows</h2>
                        <button id="add-parent-category" class="p-1.5 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200" aria-label="Add parent category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                        </button>
                    </div>
                    <div id="budget-list" class="space-y-4"></div>
                </div>
                <div id="accounts-view" class="sidebar-view p-5 space-y-5"></div>
                <div id="transactions-view" class="sidebar-view">
                    <div class="sticky top-0 bg-white border-b border-gray-100 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-gray-400">Assets</p>
                                <p id="assets-display" class="text-xl font-semibold text-emerald-600"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs uppercase tracking-wide text-gray-400">Total Spent</p>
                                <p id="total-spent" class="text-xl font-semibold text-rose-500"></p>
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button id="load-demo-data" class="flex-1 px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium shadow-sm">Use Demo Data</button>
                            <button id="launch-plaid" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 text-sm font-semibold text-slate-700 hover:bg-slate-50">Link Bank (Plaid)</button>
                        </div>
                    </div>
                    <div id="transactions-list" class="p-5 space-y-4"></div>
                </div>
                <div id="place-detail-view" class="sidebar-view"></div>
            </section>
        </aside>
    </div>
    <div id="mobile-view" class="lg:hidden flex flex-col h-full">
        <div class="relative h-1/2">
            <div id="mobile-map" class="absolute inset-0"></div>
            <div class="absolute top-3 left-3 right-3 space-y-2">
                <input id="mobile-search" class="w-full bg-white/95 backdrop-blur px-10 py-3 rounded-2xl shadow" placeholder="Search city or place" />
                <div id="mobile-category-filters" class="flex overflow-x-auto space-x-2"></div>
            </div>
            <div id="mobile-place-card" class="hidden pointer-events-none absolute bottom-3 left-3 right-3 z-30">
                <div class="pointer-events-auto rounded-3xl bg-white shadow-2xl border border-slate-100 p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p id="mobile-place-title" class="text-base font-semibold text-slate-900"></p>
                            <p id="mobile-place-address" class="text-xs text-slate-500"></p>
                        </div>
                        <button id="mobile-place-close" class="text-slate-400 hover:text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <select id="mobile-place-category" class="flex-1 border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"></select>
                        <button id="mobile-place-assign" class="p-2 rounded-full bg-blue-100 text-blue-600" aria-label="Assign to category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                        </button>
                        <button id="mobile-place-create" class="p-2 rounded-full bg-slate-100 text-slate-600" aria-label="Create sub-category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                        </button>
                    </div>
                    <p id="mobile-place-status" class="text-[11px] uppercase tracking-wide text-slate-400"></p>
                </div>
            </div>
        </div>
        <div class="flex-1 bg-white rounded-t-3xl shadow-2xl -mt-6 pt-4">
            <div class="flex justify-around border-b border-slate-100 pb-3 px-4">
                <button class="mobile-tab active text-sm font-semibold text-blue-600" data-target="mobile-budget">Budget</button>
                <button class="mobile-tab text-sm font-semibold text-slate-500" data-target="mobile-accounts">Accounts</button>
                <button class="mobile-tab text-sm font-semibold text-slate-500" data-target="mobile-transactions">History</button>
            </div>
            <div id="mobile-budget" class="mobile-panel p-4 space-y-4 overflow-y-auto h-[calc(50vh-64px)]">
                <div class="timeline-wrapper">
                    <div id="mobile-timeline-canvas" class="h-[220px]"></div>
                </div>
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-semibold">Fund flows</h2>
                    <button id="mobile-add-parent" class="p-1.5 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200" aria-label="Add parent category (mobile)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                    </button>
                </div>
                <div id="mobile-budget-list" class="space-y-3"></div>
            </div>
            <div id="mobile-accounts" class="mobile-panel hidden p-4 space-y-4 overflow-y-auto h-[calc(50vh-64px)]"></div>
            <div id="mobile-transactions" class="mobile-panel hidden p-4 space-y-4 overflow-y-auto h-[calc(50vh-64px)]"></div>
        </div>
    </div>

    <div id="category-modal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Create category</h3>
                <button id="close-category-modal" class="text-slate-400 hover:text-slate-600" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide">Name</label>
                    <input id="category-name-input" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g. Dining Out" />
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide">Parent</label>
                    <select id="category-parent-select" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide">Budget amount</label>
                    <input id="category-budget-input" type="number" min="0" step="0.01" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="0.00" />
                </div>
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button id="cancel-category" class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-medium">Cancel</button>
                <button id="save-category" class="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold">Save</button>
            </div>
        </div>
    </div>
    <script>
        const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';
        const tailwindPalette = {
            indigo: ['#c7d2fe','#6366f1'],
            cyan: ['#a5f3fc','#06b6d4'],
            emerald: ['#a7f3d0','#10b981'],
            amber: ['#fde68a','#f59e0b'],
            fuchsia: ['#fbcfe8','#ec4899'],
            slate: ['#cbd5f5','#1e293b'],
            rose: ['#fecdd3','#f43f5e'],
            violet: ['#e9d5ff','#8b5cf6']
        };
        const placeTypeIcons = {
            restaurant: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 6.75h16M4 12h16M4 17.25h16"/>',
            grocery: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18l-1.5 11.25a1.5 1.5 0 0 1-1.49 1.25H5.99A1.5 1.5 0 0 1 4.5 18.25L3 7Zm5.25 0V5.25A2.25 2.25 0 0 1 10.5 3h3a2.25 2.25 0 0 1 2.25 2.25V7"/>',
            transit: '<path stroke-linecap="round" stroke-linejoin="round" d="M5.25 6.75A3.75 3.75 0 0 1 9 3h6a3.75 3.75 0 0 1 3.75 3.75v9A3.75 3.75 0 0 1 15 19.5H9a3.75 3.75 0 0 1-3.75-3.75v-9Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 12h13.5M9 19.5v1.5m6-1.5v1.5"/>',
            retail: '<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5l-.87 9.02a2.25 2.25 0 0 1-2.24 2.02H6.86a2.25 2.25 0 0 1-2.24-2.02L3.75 9Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 9V6.75A2.25 2.25 0 0 1 7.5 4.5h9a2.25 2.25 0 0 1 2.25 2.25V9"/>',
            entertainment: '<path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.25h13.5a1.5 1.5 0 0 1 1.5 1.5V18a1.5 1.5 0 0 1-1.5 1.5H5.25A1.5 1.5 0 0 1 3.75 18V6.75a1.5 1.5 0 0 1 1.5-1.5Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 9 3 2.25-3 2.25V9Z"/>',
            health: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5m6.75-6.75H5.25"/>',
            fitness: '<path stroke-linecap="round" stroke-linejoin="round" d="m3.75 9.75 3 3 2.25-2.25 4.5 4.5 3-3 3 3"/>',
            home: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 9.75 12 3l9 6.75v8.25a2.25 2.25 0 0 1-2.25 2.25h-13.5A2.25 2.25 0 0 1 3 18V9.75Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M9 21.75v-6a3 3 0 1 1 6 0v6"/>'
        };
        const placeTypes = [
            { id: 'restaurant', label: 'Restaurants', here: '100-1000', defaultParent: 'dining', gradient: tailwindPalette.indigo },
            { id: 'grocery', label: 'Groceries', here: '100-1011-0052,700-7000-0000', defaultParent: 'essentials', gradient: tailwindPalette.emerald },
            { id: 'transit', label: 'Transit', here: '400-4000-0000', defaultParent: 'transport', gradient: tailwindPalette.cyan },
            { id: 'retail', label: 'Retail', here: '600-6000-0000', defaultParent: 'shopping', gradient: tailwindPalette.violet },
            { id: 'entertainment', label: 'Entertainment', here: '300-3000-0000', defaultParent: 'leisure', gradient: tailwindPalette.fuchsia },
            { id: 'health', label: 'Healthcare', here: '500-5000-0000', defaultParent: 'health', gradient: tailwindPalette.rose },
            { id: 'fitness', label: 'Fitness', here: '800-8000-0165', defaultParent: 'wellness', gradient: tailwindPalette.cyan },
            { id: 'home', label: 'Home & Services', here: '600-6000-0062', defaultParent: 'home', gradient: tailwindPalette.amber }
        ];

        const stateBus = new EventTarget();
        const appState = {
            plaidConnected: false,
            budgets: {
                parents: [
                    {
                        id: 'dining',
                        name: 'Dining & Experiences',
                        color: tailwindPalette.indigo,
                        children: [
                            { id: 'dining-out', name: 'Dining Out', budget: 320, spent: 164, placeType: 'restaurant' },
                            { id: 'coffee-shops', name: 'Coffee Shops', budget: 110, spent: 46, placeType: 'restaurant' }
                        ]
                    },
                    {
                        id: 'essentials',
                        name: 'Groceries & Essentials',
                        color: tailwindPalette.emerald,
                        children: [
                            { id: 'groceries', name: 'Groceries', budget: 520, spent: 210, placeType: 'grocery' },
                            { id: 'household-supplies', name: 'Household Supplies', budget: 120, spent: 40, placeType: 'home' }
                        ]
                    },
                    {
                        id: 'transport',
                        name: 'Transportation',
                        color: tailwindPalette.cyan,
                        children: [
                            { id: 'fuel', name: 'Fuel', budget: 180, spent: 95, placeType: 'transit' },
                            { id: 'rideshare', name: 'Rideshare', budget: 90, spent: 20, placeType: 'transit' }
                        ]
                    },
                    {
                        id: 'leisure',
                        name: 'Leisure',
                        color: tailwindPalette.fuchsia,
                        children: [
                            { id: 'entertainment', name: 'Entertainment', budget: 200, spent: 85, placeType: 'entertainment' },
                            { id: 'subscriptions', name: 'Subscriptions', budget: 60, spent: 45, placeType: 'entertainment' }
                        ]
                    }
                ]
            },
            accounts: [
                { id: 'checking', name: 'Main Checking', balance: 3580.14 },
                { id: 'savings', name: 'High-Yield Savings', balance: 12680.45 },
                { id: 'travel', name: 'Travel Fund', balance: 2200.00 }
            ],
            transactions: [
                { id: 't-1', name: 'Tremont Tavern', amount: 42.75, type: 'debit', date: '2025-10-12', place: 'restaurant', category: 'dining-out', source: 'Bank Sync' },
                { id: 't-2', name: 'Clumpies Ice Cream', amount: 18.50, type: 'debit', date: '2025-10-11', place: 'restaurant', category: 'dining-out', source: 'Bank Sync' },
                { id: 't-3', name: 'Public House Restaurant', amount: 67.25, type: 'debit', date: '2025-10-10', place: 'restaurant', category: 'dining-out', source: 'Bank Sync' },
                { id: 't-4', name: 'Whole Foods Market', amount: 142.33, type: 'debit', date: '2025-10-09', place: 'grocery', category: 'groceries', source: 'Plaid' },
                { id: 't-5', name: 'Main Street Meats', amount: 58.11, type: 'debit', date: '2025-10-08', place: 'grocery', category: 'groceries', source: 'Plaid' },
                { id: 't-6', name: 'EPB Chattanooga', amount: 79.00, type: 'debit', date: '2025-10-07', place: 'home', category: 'household-supplies', source: 'Plaid' },
                { id: 't-7', name: 'Shell - Frazier Ave', amount: 48.12, type: 'debit', date: '2025-10-06', place: 'transit', category: 'fuel', source: 'Bank Sync' },
                { id: 't-8', name: 'Uber Trip', amount: 21.40, type: 'debit', date: '2025-10-04', place: 'transit', category: 'rideshare', source: 'Bank Sync' },
                { id: 't-9', name: 'Songbirds Museum', amount: 34.00, type: 'debit', date: '2025-10-02', place: 'entertainment', category: 'entertainment', source: 'Plaid' },
                { id: 't-10', name: 'Netflix', amount: 15.99, type: 'debit', date: '2025-09-30', place: 'entertainment', category: 'subscriptions', source: 'Plaid' },
                { id: 't-11', name: 'Paycheck', amount: 4400.00, type: 'credit', date: '2025-09-28', place: 'income', category: null, source: 'Payroll' }
            ],
            map: {
                savedPlaces: [],
                selectedType: 'all',
                lastQuery: '',
                markers: []
            }
        };
        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        const findParentByChild = (childId) => appState.budgets.parents.find(parent => parent.children.some(c => c.id === childId));
        const getParentById = (id) => appState.budgets.parents.find(p => p.id === id);
        const allSubcategories = () => appState.budgets.parents.flatMap(parent => parent.children.map(child => ({ ...child, parentId: parent.id, parentName: parent.name, parentColor: parent.color })));

        const calculateTotals = () => {
            appState.budgets.parents.forEach(parent => parent.children.forEach(child => child.spent = 0));
            appState.transactions.forEach(tx => {
                if (!tx.category) return;
                const parent = findParentByChild(tx.category);
                if (!parent) return;
                const child = parent.children.find(c => c.id === tx.category);
                if (tx.type === 'debit') child.spent += tx.amount;
                if (tx.type === 'credit') child.spent = Math.max(0, child.spent - tx.amount);
            });
        };

        const stateChanged = () => {
            calculateTotals();
            stateBus.dispatchEvent(new CustomEvent('state-change'));
        };

        const gradientToCss = (gradient) => `linear-gradient(135deg, ${gradient[0]}, ${gradient[1]})`;

        const renderCategoryBar = (canvas, budget, spent, gradient) => {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth || 320;
            const height = canvas.height = canvas.offsetHeight || 120;
            ctx.clearRect(0, 0, width, height);
            const margin = 20;
            const axisY = height - margin;
            const maxValue = Math.max(budget, spent, 1);
            const barWidth = (width - margin * 3) / 2;
            const scale = (axisY - margin) / maxValue;
            const gradBudget = ctx.createLinearGradient(0, 0, 0, axisY);
            gradBudget.addColorStop(0, gradient[0]);
            gradBudget.addColorStop(1, gradient[1]);
            ctx.fillStyle = gradBudget;
            const budgetHeight = budget * scale;
            ctx.fillRect(margin, axisY - budgetHeight, barWidth, budgetHeight);
            ctx.fillStyle = '#0f172a';
            ctx.font = '12px Inter';
            ctx.fillText('Budget', margin, axisY + 14);
            const gradSpent = ctx.createLinearGradient(0, 0, 0, axisY);
            gradSpent.addColorStop(0, 'rgba(15,23,42,0.9)');
            gradSpent.addColorStop(1, 'rgba(15,23,42,0.5)');
            const spentHeight = spent * scale;
            ctx.fillStyle = gradSpent;
            ctx.fillRect(margin * 2 + barWidth, axisY - spentHeight, barWidth, spentHeight);
            ctx.fillStyle = '#0f172a';
            ctx.fillText('Spent', margin * 2 + barWidth, axisY + 14);
            ctx.fillStyle = '#0f172a';
            ctx.textAlign = 'center';
            ctx.fillText(formatCurrency(budget), margin + barWidth / 2, axisY - budgetHeight - 6);
            ctx.fillText(formatCurrency(spent), margin * 2 + barWidth + barWidth / 2, axisY - spentHeight - 6);
        };

        class FinancialCanvas {
            constructor(containerId, data) {
                this.container = document.getElementById(containerId);
                if (!this.container) return;
                this.canvas = document.createElement('canvas');
                this.container.innerHTML = '';
                this.container.appendChild(this.canvas);
                this.ctx = this.canvas.getContext('2d');
                this.scale = 1;
                this.offsetX = 0;
                this.offsetY = 0;
                this.setData(data);
                this.addEventListeners();
            }
            setData(data) {
                this.data = data;
                this.prepareData();
                this.initializePositions();
                this.drawScene();
            }
            prepareData() {
                const today = new Date();
                this.currentDay = today.getDate();
                const simulate = (total) => {
                    const output = [];
                    let sum = 0;
                    while (sum < total) {
                        const remaining = total - sum;
                        const amt = Math.min(remaining, Math.random() * (total / 4) + 10);
                        sum += amt;
                        output.push({ day: Math.floor(Math.random() * this.currentDay) + 1, amount: amt });
                    }
                    return output;
                };
                this.data.spendingData.forEach(item => item.transactions = simulate(Math.max(item.finalSpent, 0)));
            }
            initializePositions() {
                const rect = this.container.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }
            addEventListeners() {
                window.addEventListener('resize', () => {
                    this.initializePositions();
                    this.drawScene();
                });
            }
            drawScene() {
                if (!this.ctx) return;
                const ctx = this.ctx;
                const { width, height } = this.canvas;
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, width, height);
                const padding = 40;
                const columnWidth = (width - padding * 2) / 3;
                ctx.fillStyle = 'rgba(255,255,255,0.06)';
                ctx.fillRect(padding, padding, columnWidth, height - padding * 2);
                ctx.fillRect(padding + columnWidth + 20, padding, columnWidth, height - padding * 2);
                ctx.fillRect(padding + (columnWidth + 20) * 2, padding, columnWidth, height - padding * 2);
                ctx.fillStyle = '#f8fafc';
                ctx.font = '16px Inter';
                ctx.fillText('Category', padding + 10, padding + 24);
                ctx.fillText('Budgeted', padding + columnWidth + 30, padding + 24);
                ctx.fillText('Spent', padding + (columnWidth + 20) * 2 + 10, padding + 24);
                const barHeight = 24;
                const gap = 18;
                let y = padding + 60;
                this.data.spendingData.forEach(item => {
                    const gradient = ctx.createLinearGradient(0, 0, columnWidth, 0);
                    gradient.addColorStop(0, item.color[0]);
                    gradient.addColorStop(1, item.color[1]);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(padding + 10, y, columnWidth - 20, barHeight);
                    ctx.fillStyle = '#0f172a';
                    ctx.font = '12px Inter';
                    ctx.fillText(item.label, padding + 14, y + 16);
                    ctx.fillStyle = '#f8fafc';
                    ctx.fillText(formatCurrency(item.total), padding + columnWidth + 30, y + 16);
                    ctx.fillText(formatCurrency(item.finalSpent), padding + (columnWidth + 20) * 2 + 10, y + 16);
                    y += barHeight + gap;
                });
            }
        }

        function buildTimelineData() {
            const spending = allSubcategories().map(sub => ({
                id: sub.id,
                label: sub.name,
                total: sub.budget,
                finalSpent: sub.spent,
                color: findParentByChild(sub.id)?.color || tailwindPalette.indigo
            }));
            return { spendingData: spending, savingsData: [], assumedIncome: 4500 };
        }

        const timeline = new FinancialCanvas('timeline-canvas', buildTimelineData());
        const mobileTimeline = new FinancialCanvas('mobile-timeline-canvas', buildTimelineData());

        stateBus.addEventListener('state-change', () => {
            timeline.setData(buildTimelineData());
            mobileTimeline.setData(buildTimelineData());
            renderBudgets();
            renderAccounts();
            renderTransactions();
            renderMapFilters();
            updateMapMarkers();
            if (!placeCard.classList.contains('hidden')) {
                renderPlaceOptions(placeCardSelect, placeCardSelect.value);
            }
            if (!mobilePlaceCard.classList.contains('hidden')) {
                renderPlaceOptions(mobilePlaceSelect, mobilePlaceSelect.value);
            }
        });
        const navButtons = Array.from(document.querySelectorAll('.nav-btn'));
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.sidebar-view').forEach(v => v.classList.remove('active'));
                document.getElementById(view).classList.add('active');
            });
        });

        const mobileTabs = Array.from(document.querySelectorAll('.mobile-tab'));
        mobileTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                mobileTabs.forEach(t => t.classList.remove('active','text-blue-600'));
                tab.classList.add('active','text-blue-600');
                document.querySelectorAll('.mobile-panel').forEach(panel => panel.classList.add('hidden'));
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            });
        });

        function createParentCard(parent, totalBudget, totalSpent, remaining) {
            const card = document.createElement('div');
            card.className = 'rounded-3xl border border-gray-100 shadow-sm p-5 space-y-4 bg-white';
            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">${parent.name}</h3>
                        <p class="text-sm text-slate-500">${formatCurrency(remaining)} remaining</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-right">
                            <p class="text-xs text-slate-400 uppercase tracking-wide">Spent</p>
                            <p class="text-sm font-semibold text-slate-700">${formatCurrency(totalSpent)}</p>
                        </div>
                        <button class="p-1.5 rounded-full bg-slate-100 hover:bg-slate-200" data-parent-add="${parent.id}" aria-label="Add sub-category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                        </button>
                    </div>
                </div>
                <div class="category-bar"><canvas></canvas></div>
                <div class="space-y-3">
                    ${parent.children.map(child => `
                        <div class="rounded-2xl bg-slate-50 p-3 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-700">${child.name}</p>
                                <p class="text-xs text-slate-500">${formatCurrency(child.budget - child.spent)} remaining</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <p class="text-xs text-slate-400 uppercase tracking-wide">Spent</p>
                                    <p class="text-sm font-semibold text-slate-700">${formatCurrency(child.spent)}</p>
                                </div>
                                <div class="w-20 h-3 rounded-full overflow-hidden bg-slate-200">
                                    <div class="h-full" style="width:${Math.min(100, (child.spent / child.budget) * 100)}%; background:${gradientToCss(parent.color)}"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            return card;
        }

        function renderBudgets() {
            const desktopList = document.getElementById('budget-list');
            const mobileList = document.getElementById('mobile-budget-list');
            desktopList.innerHTML = '';
            mobileList.innerHTML = '';
            appState.budgets.parents.forEach(parent => {
                const totalBudget = parent.children.reduce((sum, child) => sum + child.budget, 0);
                const totalSpent = parent.children.reduce((sum, child) => sum + child.spent, 0);
                const remaining = totalBudget - totalSpent;
                const desktopCard = createParentCard(parent, totalBudget, totalSpent, remaining);
                const mobileCard = createParentCard(parent, totalBudget, totalSpent, remaining);
                desktopList.appendChild(desktopCard);
                mobileList.appendChild(mobileCard);
                requestAnimationFrame(() => {
                    renderCategoryBar(desktopCard.querySelector('canvas'), totalBudget, totalSpent, parent.color);
                    renderCategoryBar(mobileCard.querySelector('canvas'), totalBudget, totalSpent, parent.color);
                });
            });
            Array.from(document.querySelectorAll('[data-parent-add]')).forEach(button => {
                button.addEventListener('click', () => openCategoryModal({ parentId: button.dataset.parentAdd }));
            });
        }

        function renderAccounts() {
            const desktop = document.getElementById('accounts-view');
            const mobile = document.getElementById('mobile-accounts');
            desktop.innerHTML = '';
            mobile.innerHTML = '';
            const totalAssets = appState.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const summaryCard = document.createElement('div');
            summaryCard.className = 'bg-slate-900 text-white rounded-3xl p-5';
            summaryCard.innerHTML = `
                <p class="text-sm uppercase tracking-wide text-slate-200">Total Assets</p>
                <p class="text-3xl font-semibold">${formatCurrency(totalAssets)}</p>
            `;
            desktop.appendChild(summaryCard.cloneNode(true));
            mobile.appendChild(summaryCard);
            appState.accounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'rounded-2xl border border-slate-100 p-4 bg-white shadow-sm';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-slate-900">${account.name}</h3>
                            <p class="text-sm text-slate-500">${formatCurrency(account.balance)}</p>
                        </div>
                        <p class="text-xs text-slate-400 uppercase">Chattanooga, TN</p>
                    </div>
                    <div class="mt-4 space-y-3">
                        ${allSubcategories().map(sub => `<div class="flex justify-between text-sm text-slate-600"><span>${sub.parentName} · ${sub.name}</span><span>${formatCurrency(sub.budget - sub.spent)}</span></div>`).join('')}
                    </div>
                `;
                desktop.appendChild(card.cloneNode(true));
                mobile.appendChild(card);
            });
        }

        function renderTransactionOptions(selected) {
            const options = allSubcategories().map(sub => `<option value="${sub.id}" ${selected === sub.id ? 'selected' : ''}>${sub.parentName} · ${sub.name}</option>`).join('');
            return `<option value="">Unassigned</option>${options}<option value="create-new">Create new…</option>`;
        }

        function createTransactionRow(tx) {
            const parent = tx.category ? findParentByChild(tx.category) : null;
            const sub = tx.category && parent ? parent.children.find(c => c.id === tx.category) : null;
            const remaining = sub ? formatCurrency(sub.budget - sub.spent) : 'Unassigned';
            const row = document.createElement('div');
            row.className = 'rounded-2xl border border-slate-100 bg-white shadow-sm p-4 space-y-3';
            row.dataset.transaction = tx.id;
            row.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-slate-900">${tx.name}</p>
                        <p class="text-xs text-slate-400 uppercase">${tx.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold ${tx.type === 'debit' ? 'text-rose-500' : 'text-emerald-600'}">${tx.type === 'debit' ? '-' : '+'}${formatCurrency(tx.amount)}</p>
                        <p class="text-xs text-slate-400">Remaining: ${remaining}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <select class="flex-1 border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        ${renderTransactionOptions(tx.category)}
                    </select>
                    <button class="p-2 rounded-full bg-slate-100" data-open-modal>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.25v13.5M18.75 12H5.25"/></svg>
                    </button>
                </div>
            `;
            row.querySelector('[data-open-modal]').addEventListener('click', () => openCategoryModal({ onSave: (categoryId) => assignTransaction(tx.id, categoryId) }));
            row.querySelector('select').addEventListener('change', (event) => {
                if (event.target.value === 'create-new') {
                    openCategoryModal({ onSave: (categoryId) => assignTransaction(tx.id, categoryId) });
                } else {
                    assignTransaction(tx.id, event.target.value || null);
                }
            });
            return row;
        }

        function renderTransactions() {
            const desktop = document.getElementById('transactions-list');
            const mobile = document.getElementById('mobile-transactions');
            desktop.innerHTML = '';
            mobile.innerHTML = '';
            const totalSpent = appState.transactions.filter(t => t.type === 'debit').reduce((sum, tx) => sum + tx.amount, 0);
            document.getElementById('total-spent').textContent = formatCurrency(totalSpent);
            const assets = appState.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            document.getElementById('assets-display').textContent = formatCurrency(assets);
            const sorted = appState.transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(tx => {
                desktop.appendChild(createTransactionRow(tx));
                mobile.appendChild(createTransactionRow(tx));
            });
        }
        function assignTransaction(txId, categoryId) {
            const tx = appState.transactions.find(t => t.id === txId);
            if (!tx) return;
            tx.category = categoryId || null;
            stateChanged();
        }

        const categoryModal = document.getElementById('category-modal');
        const categoryNameInput = document.getElementById('category-name-input');
        const categoryBudgetInput = document.getElementById('category-budget-input');
        const categoryParentSelect = document.getElementById('category-parent-select');
        let modalCallback = null;

        function openCategoryModal({ parentId = null, onSave = null } = {}) {
            categoryModal.classList.remove('hidden');
            categoryModal.classList.add('flex');
            categoryNameInput.value = '';
            categoryBudgetInput.value = '';
            categoryParentSelect.innerHTML = '<option value="__new">New parent category</option>' + appState.budgets.parents.map(parent => `<option value="${parent.id}">${parent.name}</option>`).join('');
            categoryParentSelect.value = parentId || '__new';
            modalCallback = onSave;
        }

        function closeCategoryModal() {
            categoryModal.classList.add('hidden');
            categoryModal.classList.remove('flex');
            modalCallback = null;
        }

        document.getElementById('close-category-modal').addEventListener('click', closeCategoryModal);
        document.getElementById('cancel-category').addEventListener('click', closeCategoryModal);
        document.getElementById('save-category').addEventListener('click', () => {
            const name = categoryNameInput.value.trim();
            const amount = parseFloat(categoryBudgetInput.value || '0');
            const parentValue = categoryParentSelect.value;
            if (!name) return;
            let newCategoryId;
            if (parentValue === '__new') {
                const parentId = createParentCategory(name, amount);
                newCategoryId = appState.budgets.parents.find(p => p.id === parentId).children[0].id;
            } else {
                newCategoryId = createSubCategory(parentValue, name, amount);
            }
            if (modalCallback) modalCallback(newCategoryId);
            closeCategoryModal();
            stateChanged();
        });

        document.getElementById('add-parent-category').addEventListener('click', () => openCategoryModal());
        document.getElementById('mobile-add-parent').addEventListener('click', () => openCategoryModal());

        const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || `category-${Date.now()}`;

        function createParentCategory(name, budget) {
            const id = slugify(name);
            const paletteKeys = Object.keys(tailwindPalette);
            const color = tailwindPalette[paletteKeys[Math.floor(Math.random() * paletteKeys.length)]];
            const subId = `${id}-general`;
            const defaultType = placeTypes[0]?.id || 'restaurant';
            const parent = { id, name, color, children: [{ id: subId, name: `${name} General`, budget, spent: 0, placeType: defaultType }] };
            appState.budgets.parents.push(parent);
            return id;
        }

        function createSubCategory(parentId, name, budget) {
            const parent = getParentById(parentId);
            if (!parent) return null;
            const id = slugify(name);
            const inheritedType = parent.children[0]?.placeType || placeTypes[0]?.id || 'restaurant';
            parent.children.push({ id, name, budget, spent: 0, placeType: inheritedType });
            return id;
        }

        const demoMerchants = [
            "Rembrandt's Coffee House","The Daily Ration","Community Pie","1885 Grill","Mean Mug Coffeehouse","Flying Squirrel Bar","The FEED Co. Table & Tavern","Easy Bistro & Bar","Frothy Monkey","Tony's Pasta Shop","Goodfellas Pizzeria","Il Primo","Bluegrass Grill","Maple Street Biscuit Company","JJs Bohemia","State of Confusion","Naked River Brewing","Yellow Deli","FEED Table","Alleia","Hello Monty","Stir","Basecamp Bar","Boathouse Rotisserie","Beast + Barrel","Taqueria Jalisco","Bela Lisboa","Urban Stack","Southern Squeeze","Lookout Winery","Tupelo Honey","Blue Orleans","Champy's Chicken","Milk & Honey","Honest Pint","Sweetly Southern","The Tap House","Songbirds Museum","River Gallery","Rock City","Tennessee Aquarium","High Point Climbing","Reflection Riding","Publix","Whole Foods Market","Food City","Walmart Neighborhood Market","Greenlife Grocery","Lupi's Pizza Pies","Bilo","Chattanooga Market","Target","Best Buy","Home Depot","Lowes","IKEA","Ace Hardware","Walgreens","CVS","Erlanger Pharmacy","BlueCross BlueShield","Orangetheory Fitness","SportsBarn","Yoga Landing","Planet Fitness","Scenic City Strength","Uber","Lyft","Chattanooga Area Regional Transportation Authority","Greyhound","Shell","Marathon","Mapco","BP","Speedway"
        ];

        function inferPlaceType(merchant) {
            const lower = merchant.toLowerCase();
            if (lower.includes('coffee') || lower.includes('bistro') || lower.includes('grill') || lower.includes('bar') || lower.includes('restaurant') || lower.includes('pie')) return 'restaurant';
            if (lower.includes('market') || lower.includes('grocery') || lower.includes('food') || lower.includes('walmart') || lower.includes('target')) return 'grocery';
            if (lower.includes('uber') || lower.includes('lyft') || lower.includes('transport') || lower.includes('bus') || lower.includes('greyhound')) return 'transit';
            if (lower.includes('pharmacy') || lower.includes('health') || lower.includes('medical') || lower.includes('bluecross')) return 'health';
            if (lower.includes('fitness') || lower.includes('yoga') || lower.includes('climbing') || lower.includes('sports')) return 'fitness';
            if (lower.includes('home depot') || lower.includes('lowes') || lower.includes('ikea') || lower.includes('hardware')) return 'home';
            if (lower.includes('museum') || lower.includes('gallery') || lower.includes('aquarium') || lower.includes('rock city')) return 'entertainment';
            return 'retail';
        }

        function generateDemoTransactions() {
            const results = [];
            const startDate = new Date('2025-05-01');
            for (let i = 0; i < 200; i++) {
                const date = new Date(startDate.getTime() + Math.random() * (Date.now() - startDate.getTime()));
                const merchant = demoMerchants[Math.floor(Math.random() * demoMerchants.length)];
                const amount = Math.round((Math.random() * 180 + 5) * 100) / 100;
                const placeType = inferPlaceType(merchant);
                const subCategory = allSubcategories().find(sub => sub.placeType === placeType);
                results.push({
                    id: `demo-${i}`,
                    name: merchant,
                    amount,
                    type: 'debit',
                    date: date.toISOString().split('T')[0],
                    place: placeType,
                    category: subCategory ? subCategory.id : null,
                    source: 'Demo'
                });
            }
            return results;
        }

        document.getElementById('load-demo-data').addEventListener('click', () => {
            appState.transactions = generateDemoTransactions();
            stateChanged();
        });

        document.getElementById('launch-plaid').addEventListener('click', () => {
            appState.plaidConnected = true;
            document.getElementById('load-demo-data').classList.add('hidden');
            alert('Plaid Link flow would launch here in production.');
        });
        let desktopMap, mobileMap;
        const mapState = { markers: [] };

        function createSvgPin(colorGradient, iconKey) {
            const gradientId = `grad-${iconKey}-${Math.random().toString(36).slice(2, 7)}`;
            const gradientStops = `<linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="${colorGradient[0]}"/><stop offset="100%" stop-color="${colorGradient[1]}"/></linearGradient>`;
            const iconPath = placeTypeIcons[iconKey] || placeTypeIcons.restaurant;
            return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><defs>${gradientStops}</defs><path d='M24 46c8.6-9.5 16-17.1 16-26A16 16 0 1 0 8 20c0 8.9 7.4 16.5 16 26Z' fill='url(#${gradientId})' stroke='rgba(15,23,42,0.2)' stroke-width='2'/><g transform='translate(12 12)' fill='none' stroke='#fff' stroke-width='2'>${iconPath}</g></svg>`;
        }

        function initMaps() {
            desktopMap = L.map('map', { zoomControl: false }).setView([35.0456, -85.3097], 13);
            mobileMap = L.map('mobile-map', { zoomControl: false }).setView([35.0456, -85.3097], 13);
            const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
            tiles.addTo(desktopMap);
            tiles.addTo(mobileMap);
            L.control.zoom({ position: 'bottomright' }).addTo(desktopMap);
            L.control.zoom({ position: 'bottomright' }).addTo(mobileMap);
            desktopMap.on('moveend', debounce(() => fetchPlaces(), 300));
            mobileMap.on('moveend', debounce(() => fetchPlaces(), 300));
        }

        function clearMarkers() {
            mapState.markers.forEach(marker => marker.remove());
            mapState.markers = [];
        }

        function renderMapFilters() {
            const desktop = document.getElementById('category-filters-container');
            const mobile = document.getElementById('mobile-category-filters');
            desktop.innerHTML = '';
            mobile.innerHTML = '';
            const filters = ['all', ...placeTypes.map(type => type.id)];
            const createButton = (typeId) => {
                const type = placeTypes.find(t => t.id === typeId);
                const label = type ? type.label : 'All places';
                const button = document.createElement('button');
                button.className = 'flex items-center gap-2 px-4 py-2 rounded-2xl whitespace-nowrap border border-slate-200 text-sm font-medium';
                if (appState.map.selectedType === typeId) {
                    button.classList.add('bg-slate-900','text-white');
                } else {
                    button.classList.add('bg-white/80');
                }
                if (type) {
                    button.innerHTML = `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-900/10 text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" class="w-4 h-4">${placeTypeIcons[type.id]}</svg></span><span>${label}</span>`;
                } else {
                    button.textContent = label;
                }
                button.addEventListener('click', () => {
                    appState.map.selectedType = typeId;
                    renderMapFilters();
                    fetchPlaces();
                });
                return button;
            };
            filters.forEach(typeId => {
                desktop.appendChild(createButton(typeId));
                mobile.appendChild(createButton(typeId));
            });
        }

        async function fetchPlaces() {
            if (!desktopMap) return;
            const mapRef = window.innerWidth >= 1024 ? desktopMap : mobileMap;
            const center = mapRef.getCenter();
            const category = appState.map.selectedType;
            const query = category === 'all' ? '' : placeTypes.find(c => c.id === category)?.here;
            const searchQuery = document.getElementById(window.innerWidth >= 1024 ? 'search-input' : 'mobile-search').value.trim();
            const inCircle = `${center.lat},${center.lng};r=${Math.round(mapRef.getBounds().getNorthEast().distanceTo(center))}`;
            let url = '';
            if (searchQuery) {
                url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(searchQuery)}&in=circle:${inCircle}&limit=50&apiKey=${HERE_API_KEY}`;
            } else if (query) {
                url = `https://browse.search.hereapi.com/v1/browse?categories=${query}&in=circle:${inCircle}&limit=50&apiKey=${HERE_API_KEY}`;
            } else {
                url = '';
            }
            if (!url) {
                clearMarkers();
                hidePlaceCard();
                return;
            }
            document.getElementById('map-loader').classList.remove('hidden');
            const response = await fetch(url);
            const data = await response.json();
            document.getElementById('map-loader').classList.add('hidden');
            clearMarkers();
            hidePlaceCard();
            (data.items || []).forEach(item => addMarker(item));
        }

        function addMarker(item) {
            if (!item.position) return;
            const coords = [item.position.lat, item.position.lng];
            const placeCategory = determinePlaceType(item);
            const place = {
                id: item.id,
                title: item.title,
                address: item.address?.label || '',
                lat: item.position.lat,
                lng: item.position.lng,
                placeType: placeCategory
            };
            const saved = appState.map.savedPlaces.find(p => p.id === place.id);
            const assignedCategory = saved ? saved.categoryId : null;
            const gradientSource = assignedCategory ? findParentByChild(assignedCategory) : null;
            const gradient = gradientSource ? gradientSource.color : ['#bbf7d0','#22c55e'];
            const svg = createSvgPin(gradient, placeCategory);
            const icon = L.divIcon({ html: `<div class="gradient-pin">${svg}</div>`, className: '', iconSize: [44, 44], iconAnchor: [22, 44] });
            const desktopMarker = L.marker(coords, { icon }).addTo(desktopMap);
            const mobileMarker = L.marker(coords, { icon }).addTo(mobileMap);
            const popupHtml = `<div class="text-sm font-semibold">${item.title}</div><div class="text-xs text-slate-500">${item.address?.label || ''}</div>`;
            desktopMarker.bindPopup(popupHtml);
            mobileMarker.bindPopup(popupHtml);
            desktopMarker.on('click', () => showPlaceCard(place));
            mobileMarker.on('click', () => showPlaceCard(place, true));
            mapState.markers.push(desktopMarker, mobileMarker);
        }

        function determinePlaceType(item) {
            if (item.categories) {
                for (const category of item.categories) {
                    const match = placeTypes.find(pt => pt.here.split(',').some(code => category.id?.includes(code.trim())));
                    if (match) return match.id;
                }
            }
            return 'restaurant';
        }

        const placeCard = document.getElementById('map-place-card');
        const placeCardTitle = document.getElementById('place-card-title');
        const placeCardAddress = document.getElementById('place-card-address');
        const placeCardSelect = document.getElementById('place-card-category');
        const placeCardStatus = document.getElementById('place-card-status');
        const mobilePlaceCard = document.getElementById('mobile-place-card');
        const mobilePlaceTitle = document.getElementById('mobile-place-title');
        const mobilePlaceAddress = document.getElementById('mobile-place-address');
        const mobilePlaceSelect = document.getElementById('mobile-place-category');
        const mobilePlaceStatus = document.getElementById('mobile-place-status');
        let activePlace = null;

        function renderPlaceOptions(select, selected) {
            if (!select) return;
            select.innerHTML = `<option value="">Select category</option>` + allSubcategories().map(sub => `<option value="${sub.id}" ${selected === sub.id ? 'selected' : ''}>${sub.parentName} · ${sub.name}</option>`).join('');
        }

        function showPlaceCard(place, mobile = false) {
            activePlace = place;
            const saved = appState.map.savedPlaces.find(p => p.id === place.id);
            const statusText = saved && saved.categoryId ? `Assigned to ${findParentByChild(saved.categoryId)?.name || ''}` : 'Uncategorized';
            renderPlaceOptions(placeCardSelect, saved?.categoryId || '');
            renderPlaceOptions(mobilePlaceSelect, saved?.categoryId || '');
            placeCardTitle.textContent = place.title;
            placeCardAddress.textContent = place.address;
            placeCardStatus.textContent = statusText;
            mobilePlaceTitle.textContent = place.title;
            mobilePlaceAddress.textContent = place.address;
            mobilePlaceStatus.textContent = statusText;
            placeCard.classList.remove('hidden');
            mobilePlaceCard.classList.remove('hidden');
            placeCardSelect.value = saved?.categoryId || '';
            mobilePlaceSelect.value = saved?.categoryId || '';
        }

        function hidePlaceCard() {
            placeCard.classList.add('hidden');
            mobilePlaceCard.classList.add('hidden');
            activePlace = null;
        }

        function assignPlaceToCategory(categoryId) {
            if (!activePlace) return;
            const existing = appState.map.savedPlaces.find(p => p.id === activePlace.id);
            if (existing) {
                if (categoryId) {
                    existing.categoryId = categoryId;
                } else {
                    appState.map.savedPlaces = appState.map.savedPlaces.filter(p => p.id !== activePlace.id);
                }
            } else if (categoryId) {
                appState.map.savedPlaces.push({ ...activePlace, categoryId });
            }
            hidePlaceCard();
            updateMapMarkers();
        }

        document.getElementById('close-place-card').addEventListener('click', hidePlaceCard);
        document.getElementById('place-card-assign').addEventListener('click', () => {
            assignPlaceToCategory(placeCardSelect.value || null);
        });
        document.getElementById('place-card-create').addEventListener('click', () => {
            openCategoryModal({ onSave: (categoryId) => assignPlaceToCategory(categoryId) });
        });
        document.getElementById('mobile-place-close').addEventListener('click', hidePlaceCard);
        document.getElementById('mobile-place-assign').addEventListener('click', () => {
            assignPlaceToCategory(mobilePlaceSelect.value || null);
        });
        document.getElementById('mobile-place-create').addEventListener('click', () => {
            openCategoryModal({ onSave: (categoryId) => assignPlaceToCategory(categoryId) });
        });

        const debounce = (fn, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        };

        const autocompleteResults = document.getElementById('autocomplete-results');
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', debounce(async () => {
            const value = searchInput.value.trim();
            if (value.length < 3) { autocompleteResults.classList.add('hidden'); return; }
            const center = desktopMap.getCenter();
            const url = `https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(value)}&at=${center.lat},${center.lng}&apiKey=${HERE_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            renderAutocomplete(data.items || []);
        }, 300));

        function renderAutocomplete(items) {
            if (!items.length) { autocompleteResults.classList.add('hidden'); return; }
            autocompleteResults.innerHTML = items.map(item => `
                <button class="w-full text-left p-3 hover:bg-slate-100 border-b" data-id="${item.id}">
                    <p class="font-semibold text-slate-800">${item.title}</p>
                    <p class="text-xs text-slate-500">${item.address?.label || ''}</p>
                </button>
            `).join('');
            autocompleteResults.classList.remove('hidden');
            Array.from(autocompleteResults.querySelectorAll('button')).forEach(btn => {
                btn.addEventListener('click', () => lookupPlace(btn.dataset.id));
            });
        }

        async function lookupPlace(id) {
            autocompleteResults.classList.add('hidden');
            const url = `https://lookup.search.hereapi.com/v1/lookup?id=${id}&apiKey=${HERE_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.position) {
                desktopMap.flyTo([data.position.lat, data.position.lng], 15);
                addMarker(data);
            }
        }

        function updateMapMarkers() {
            fetchPlaces();
        }

        function syncMobileSearch() {
            const mobileSearch = document.getElementById('mobile-search');
            mobileSearch.addEventListener('change', () => fetchPlaces());
        }

        function initLayout() {
            if (window.innerWidth >= 1024) {
                document.getElementById('desktop-view').classList.remove('hidden');
                document.getElementById('mobile-view').classList.add('hidden');
            } else {
                document.getElementById('desktop-view').classList.add('hidden');
                document.getElementById('mobile-view').classList.remove('hidden');
            }
        }

        window.addEventListener('resize', initLayout);

        function bootstrap() {
            initLayout();
            initMaps();
            calculateTotals();
            renderBudgets();
            renderAccounts();
            renderTransactions();
            renderMapFilters();
            syncMobileSearch();
            stateChanged();
        }

        bootstrap();
    </script>
</body>
</html>
