
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Maps - Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet"
    />
    <style>
        :root {
            color-scheme: light;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        body {
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #map-container {
            position: relative;
            flex: 1 1 0%;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        #sidebar {
            width: 430px;
            background-color: #ffffff;
            box-shadow: -12px 0 35px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            z-index: 30;
        }

        #sidebar-content {
            flex: 1 1 0%;
            overflow-y: auto;
        }

        .sidebar-view {
            display: none;
        }

        .sidebar-view.active {
            display: block;
        }

        .map-overlay {
            pointer-events: none;
        }

        .map-overlay > * {
            pointer-events: auto;
        }

        .poi-button {
            border-radius: 9999px;
            font-size: 0.75rem;
            line-height: 1rem;
            padding: 0.5rem 0.9rem;
            background-color: rgba(255, 255, 255, 0.7);
            color: #0f172a;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
            transition: all 0.15s ease-in-out;
            white-space: nowrap;
        }

        .poi-button:hover {
            background-color: rgba(226, 232, 240, 0.85);
        }

        .poi-button.active {
            background-color: #1d4ed8;
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
        }

        .scrollbars::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .scrollbars::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.6);
            border-radius: 9999px;
        }

        .gradient-pin-wrapper {
            background: transparent;
        }

        .gradient-pin {
            width: 38px;
            height: 38px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
        }

        .gradient-pin svg {
            transform: rotate(45deg);
        }

        .search-result-card {
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        .search-result-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
        }

        .search-result-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: #0f172a;
            transition: all 0.15s ease;
        }

        .search-result-actions button:hover {
            background-color: rgba(226, 232, 240, 0.85);
        }

        .badge {
            padding: 0.15rem 0.55rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-panel {
            width: 100%;
            max-width: 460px;
            background-color: white;
            border-radius: 1.25rem;
            padding: 1.75rem;
            box-shadow: 0 30px 55px rgba(15, 23, 42, 0.18);
        }

        .modal-panel h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .input-row label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
        }

        .input-row input,
        .input-row select {
            border-radius: 0.85rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 0.6rem 0.75rem;
            font-size: 0.9rem;
            color: #0f172a;
        }

        .input-row input:focus,
        .input-row select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .slider-input {
            width: 100%;
        }

        #map-loader {
            display: none;
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(1px);
            z-index: 25;
            align-items: center;
            justify-content: center;
        }

        #map-loader.active {
            display: flex;
        }

        .loader {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 4px solid rgba(148, 163, 184, 0.4);
            border-top-color: #2563eb;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="map-container">
            <div id="map"></div>
            <div id="map-loader" class="flex"><div class="loader"></div></div>
            <div class="map-overlay absolute top-0 left-0 right-0 p-4 z-20 space-y-3">
                <div class="max-w-3xl mx-auto space-y-3">
                    <form id="search-form" class="relative flex items-center">
                        <span class="absolute left-4 text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="7"></circle>
                                <line x1="20" y1="20" x2="16.65" y2="16.65"></line>
                            </svg>
                        </span>
                        <input
                            id="search-input"
                            name="search"
                            type="text"
                            placeholder="Search city, state, or business"
                            class="w-full bg-white rounded-full py-3 pl-12 pr-28 shadow-xl text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-blue-100"
                            autocomplete="off"
                        />
                        <button
                            type="submit"
                            class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md"
                        >
                            Search
                        </button>
                    </form>
                    <div id="poi-type-strip" class="scrollbars flex items-center gap-2 overflow-x-auto rounded-2xl bg-white/80 backdrop-blur-sm p-2 shadow-lg"></div>
                    <div id="search-results" class="hidden max-h-96 overflow-y-auto space-y-3"></div>
                </div>
            </div>
        </div>
        <aside id="sidebar">
            <div class="p-4 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Money Maps</h1>
                        <p class="text-sm text-slate-500">Budget &amp; Map intelligence</p>
                    </div>
                    <div class="flex rounded-full bg-slate-100 text-xs font-semibold text-slate-600 px-3 py-1">Beta</div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button class="nav-btn active flex items-center justify-center rounded-xl py-2 font-semibold text-sm text-blue-600 bg-blue-50" data-view="budget-view">Budget</button>
                    <button class="nav-btn flex items-center justify-center rounded-xl py-2 font-semibold text-sm text-slate-500 bg-slate-100" data-view="transactions-view">History</button>
                </div>
            </div>
            <div id="sidebar-content">
                <section id="budget-view" class="sidebar-view active p-4 space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900">Fund Flows</h2>
                        <button id="create-parent-btn" class="flex h-9 w-9 items-center justify-center rounded-full bg-blue-600 text-white shadow-md hover:bg-blue-700" title="Create parent category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="budget-list" class="space-y-4"></div>
                </section>
                <section id="transactions-view" class="sidebar-view p-4 space-y-4">
                    <h2 class="text-xl font-bold text-slate-900">History</h2>
                    <p class="text-sm text-slate-500">Transaction history demo data is not linked in this prototype.</p>
                </section>
            </div>
        </aside>
    </div>

    <div id="link-subcategory-modal" class="modal-backdrop">
        <div class="modal-panel space-y-6">
            <div class="space-y-2">
                <h3>Link to sub-category</h3>
                <p class="text-sm text-slate-500">Choose a sub-category to link <span id="link-place-name" class="font-semibold text-slate-700"></span>.</p>
            </div>
            <form id="link-subcategory-form" class="space-y-5">
                <div class="input-row">
                    <label for="link-subcategory-select">Sub-category</label>
                    <select id="link-subcategory-select" required></select>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button type="button" data-action="cancel-link" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Link place</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-subcategory-modal" class="modal-backdrop">
        <div class="modal-panel space-y-6">
            <div class="space-y-2">
                <h3>Create sub-category</h3>
                <p class="text-sm text-slate-500">Create a sub-category and optionally link the selected place.</p>
            </div>
            <form id="create-subcategory-form" class="space-y-5">
                <div class="input-row">
                    <label for="create-parent-select">Parent category</label>
                    <select id="create-parent-select" required></select>
                </div>
                <div class="input-row">
                    <label for="create-subcategory-name">Sub-category name</label>
                    <input id="create-subcategory-name" type="text" placeholder="e.g. Electronics" required />
                </div>
                <div class="input-row">
                    <label for="create-subcategory-budget">Budget amount</label>
                    <input id="create-subcategory-budget" type="range" min="50" max="3000" step="25" class="slider-input" />
                    <div class="text-sm font-semibold text-blue-600" id="create-budget-display">$50</div>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button type="button" data-action="cancel-create-subcategory" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-parent-modal" class="modal-backdrop">
        <div class="modal-panel space-y-6">
            <div class="space-y-2">
                <h3>Create parent category</h3>
                <p class="text-sm text-slate-500">Add a new parent category for your budget.</p>
            </div>
            <form id="create-parent-form" class="space-y-5">
                <div class="input-row">
                    <label for="create-parent-name">Category name</label>
                    <input id="create-parent-name" type="text" placeholder="e.g. Education" required />
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button type="button" data-action="cancel-create-parent" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';

        const POI_TYPES = [
            "airport","amusement park","aquarium","art gallery","ATM","bakery","bank","bar","beauty salon","bicycle store","book store","bowling alley","bus station","cafe","campground","car dealer","car rental","car repair","car wash","casino","cemetery","church","city hall","clothing store","convenience store","courthouse","dentist","department store","doctor","drugstore","electrician","electronics store","embassy","fire station","florist","funeral home","furniture store","gas station","gym","hair care","hardware store","Hindu temple","home goods store","hospital","insurance agency","jewelry store","laundry","lawyer","library","light rail station","liquor store","local government office","locksmith","lodging","meal delivery","meal takeaway","mosque","movie rental","movie theater","moving company","museum","night club","painter","park","parking","pet store","pharmacy","physiotherapist","plumber","police","post office","primary school","real estate agency","restaurant","roofing contractor","RV park","school","secondary school","shoe store","shopping mall","spa","stadium","storage","store","subway station","supermarket","synagogue","taxi stand","tourist attraction","train station","transit station","travel agency","university","veterinary care","zoo"
        ];

        const GREEN_GRADIENT = ['#34d399', '#059669'];
        const ZOOM_FOR_40_MILES = 10;
        const RADIUS_40_MILES_METERS = 64373;

        const COLOR_PALETTE = [
            ['#2563eb', '#1e40af'],
            ['#ec4899', '#be185d'],
            ['#f59e0b', '#b45309'],
            ['#10b981', '#047857'],
            ['#6366f1', '#4338ca'],
            ['#f97316', '#c2410c'],
            ['#14b8a6', '#0f766e'],
            ['#8b5cf6', '#6d28d9']
        ];

        function slugify(value) {
            return value
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/g, '-');
        }

        function clone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        const budgetStore = (() => {
            const parentCategories = [
                {
                    id: 'food-dining',
                    name: 'Food & Dining',
                    colorStops: COLOR_PALETTE[0],
                    subCategories: [
                        { id: 'restaurants', parentId: 'food-dining', name: 'Restaurants', budgetAmount: 450 },
                        { id: 'coffee', parentId: 'food-dining', name: 'Coffee Shops', budgetAmount: 120 }
                    ]
                },
                {
                    id: 'home-life',
                    name: 'Home & Life',
                    colorStops: COLOR_PALETTE[1],
                    subCategories: [
                        { id: 'groceries', parentId: 'home-life', name: 'Groceries', budgetAmount: 520 },
                        { id: 'home-supplies', parentId: 'home-life', name: 'Home Supplies', budgetAmount: 200 }
                    ]
                },
                {
                    id: 'mobility',
                    name: 'Mobility',
                    colorStops: COLOR_PALETTE[2],
                    subCategories: [
                        { id: 'fuel', parentId: 'mobility', name: 'Fuel', budgetAmount: 180 },
                        { id: 'rideshare', parentId: 'mobility', name: 'Ride Share', budgetAmount: 120 }
                    ]
                }
            ];

            const categorizedPlaces = new Map([
                [
                    'here:poi:8409qh0k-f1b0795aa9de45dc94cf5f8a3fa1f166',
                    {
                        place: {
                            id: 'here:poi:8409qh0k-f1b0795aa9de45dc94cf5f8a3fa1f166',
                            name: 'Triangle Coffee',
                            lat: 35.787743,
                            lng: -78.644257,
                            poiType: 'cafe',
                            address: '201 W Martin St, Raleigh, NC'
                        },
                        categoryId: 'food-dining',
                        subCategoryId: 'coffee'
                    }
                ]
            ]);

            const listeners = new Set();

            function notify() {
                const snapshot = getSnapshot();
                listeners.forEach((listener) => listener(snapshot));
            }

            function getSnapshot() {
                return {
                    parentCategories: clone(parentCategories),
                    categorizedPlaces: Array.from(categorizedPlaces.values()).map((entry) => ({
                        ...clone(entry),
                        place: clone(entry.place)
                    }))
                };
            }

            function subscribe(listener) {
                listeners.add(listener);
                listener(getSnapshot());
                return () => listeners.delete(listener);
            }

            function nextColor() {
                return COLOR_PALETTE[parentCategories.length % COLOR_PALETTE.length];
            }

            function recalcParentTotals(parent) {
                parent.totalBudget = parent.subCategories.reduce((sum, sub) => sum + sub.budgetAmount, 0);
            }

            parentCategories.forEach(recalcParentTotals);

            function findParent(parentId) {
                return parentCategories.find((parent) => parent.id === parentId);
            }

            function findSubCategory(subCategoryId) {
                for (const parent of parentCategories) {
                    const sub = parent.subCategories.find((candidate) => candidate.id === subCategoryId);
                    if (sub) {
                        return { parent, sub };
                    }
                }
                return null;
            }

            function ensureUniqueId(baseId) {
                let id = baseId || 'category';
                let attempt = 1;
                while (parentCategories.some((parent) => parent.id === id)) {
                    id = `${baseId || 'category'}-${attempt++}`;
                }
                return id;
            }

            function createParentCategory(name) {
                const baseId = slugify(name);
                const id = ensureUniqueId(baseId);
                const newParent = {
                    id,
                    name,
                    colorStops: nextColor(),
                    subCategories: [],
                    totalBudget: 0
                };
                parentCategories.push(newParent);
                notify();
                return clone(newParent);
            }

            function createSubCategory(parentId, name, budgetAmount) {
                const parent = findParent(parentId);
                if (!parent) throw new Error('Parent category not found');
                const baseId = slugify(name) || `subcategory-${Date.now()}`;
                let id = baseId;
                let index = 1;
                while (parent.subCategories.some((sub) => sub.id === id)) {
                    id = `${baseId}-${index++}`;
                }
                const subCategory = { id, parentId, name, budgetAmount };
                parent.subCategories.push(subCategory);
                recalcParentTotals(parent);
                notify();
                return clone(subCategory);
            }

            function linkPlaceToSubCategory(place, subCategoryId) {
                const located = findSubCategory(subCategoryId);
                if (!located) throw new Error('Sub-category not found');
                const payload = {
                    place: { ...place },
                    categoryId: located.parent.id,
                    subCategoryId: located.sub.id
                };
                categorizedPlaces.set(place.id, payload);
                notify();
                return clone(payload);
            }

            function getCategorization(placeId) {
                const record = categorizedPlaces.get(placeId);
                if (!record) return null;
                const located = findSubCategory(record.subCategoryId);
                if (!located) return null;
                return {
                    ...clone(record),
                    colorStops: located.parent.colorStops,
                    categoryName: located.parent.name,
                    subCategoryName: located.sub.name
                };
            }

            function getAllSubCategories() {
                return parentCategories.flatMap((parent) =>
                    parent.subCategories.map((sub) => ({
                        ...clone(sub),
                        parentName: parent.name,
                        colorStops: parent.colorStops
                    }))
                );
            }

            return {
                subscribe,
                getSnapshot,
                createParentCategory,
                createSubCategory,
                linkPlaceToSubCategory,
                getCategorization,
                getAllSubCategories,
                findParent,
                findSubCategory
            };
        })();

        let map;
        let mapMarkers = [];
        let activePoiType = '';
        let latestResults = [];
        let pendingPlaceId = null;
        let pendingPlaceForNewSub = null;

        function initializeMap() {
            map = L.map('map', {
                center: [35.7796, -78.6382],
                zoom: ZOOM_FOR_40_MILES,
                zoomControl: true,
                attributionControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO'
            }).addTo(map);

            requestInitialLocation();
        }

        function requestInitialLocation() {
            if (!navigator.geolocation) {
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], ZOOM_FOR_40_MILES);
                },
                () => {},
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        function setLoaderVisible(isVisible) {
            const loader = document.getElementById('map-loader');
            loader.classList.toggle('active', isVisible);
        }

        function clearMarkers() {
            mapMarkers.forEach((entry) => entry.marker.remove());
            mapMarkers = [];
        }

        function gradientStyle([start, end]) {
            return `linear-gradient(135deg, ${start}, ${end})`;
        }

        function createMarker(place, colorStops) {
            const icon = L.divIcon({
                className: 'gradient-pin-wrapper',
                iconSize: [38, 38],
                iconAnchor: [19, 36],
                html: `
                    <div class="gradient-pin" style="background:${gradientStyle(colorStops)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                `
            });
            const marker = L.marker([place.lat, place.lng], { icon });
            marker.addTo(map);
            mapMarkers.push({ marker, placeId: place.id });
        }

        function renderMarkers(results) {
            clearMarkers();
            results.forEach((result) => {
                const colorStops = result.status === 'categorized' ? result.colorStops : GREEN_GRADIENT;
                createMarker(result, colorStops);
            });
        }

        function renderPoiButtons() {
            const container = document.getElementById('poi-type-strip');
            container.innerHTML = POI_TYPES.map((type) => `<button class="poi-button" data-poi-type="${type}">${type}</button>`).join('');
        }

        function formatAddress(item) {
            if (!item.address) return '';
            const { label } = item.address;
            return label || '';
        }

        function selectBestPoiType(categories = []) {
            if (!categories || categories.length === 0) return 'point of interest';
            const sorted = [...categories].sort((a, b) => (b.name?.length || 0) - (a.name?.length || 0));
            return sorted[0]?.name?.toLowerCase() || 'point of interest';
        }

        function decorateResults(results) {
            return results.map((place) => {
                const categorization = budgetStore.getCategorization(place.id);
                if (categorization) {
                    return {
                        ...place,
                        status: 'categorized',
                        categoryId: categorization.categoryId,
                        subCategoryId: categorization.subCategoryId,
                        colorStops: categorization.colorStops || GREEN_GRADIENT,
                        categoryName: categorization.categoryName,
                        subCategoryName: categorization.subCategoryName
                    };
                }
                return { ...place, status: 'uncategorized', colorStops: GREEN_GRADIENT };
            });
        }

        function renderSearchResults(results) {
            const container = document.getElementById('search-results');
            if (!results || results.length === 0) {
                container.innerHTML = `<div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 text-center text-sm text-slate-500 shadow-lg">No places found. Try a different search or tap a place type.</div>`;
                container.classList.remove('hidden');
                return;
            }

            container.innerHTML = results
                .map((result) => {
                    const gradient = gradientStyle(result.status === 'categorized' ? result.colorStops : GREEN_GRADIENT);
                    const badgeClass =
                        result.status === 'categorized'
                            ? 'bg-blue-50 text-blue-700'
                            : 'bg-emerald-50 text-emerald-700';
                    const badgeLabel = result.status === 'categorized' ? `Categorized • ${result.subCategoryName || 'Sub-category'}` : 'New place';

                    return `
                        <div class="search-result-card bg-white/90 backdrop-blur-sm rounded-2xl p-4 flex gap-3 items-start" data-place-id="${result.id}">
                            <div class="search-result-icon" style="background:${gradient}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 21V8a2 2 0 0 1 2-2h3l2-3h4l2 3h3a2 2 0 0 1 2 2v13"></path>
                                    <path d="M16 21v-5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v5"></path>
                                </svg>
                            </div>
                            <div class="flex-1 space-y-3">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="space-y-1">
                                        <h3 class="font-semibold text-slate-900">${result.name}</h3>
                                        <p class="text-xs uppercase tracking-wide text-slate-400">${result.poiType}</p>
                                        ${result.address ? `<p class="text-xs text-slate-500">${result.address}</p>` : ''}
                                    </div>
                                    <span class="badge ${badgeClass}">${badgeLabel}</span>
                                </div>
                                <div class="search-result-actions flex flex-wrap gap-2">
                                    <button data-action="link-existing" data-place-id="${result.id}">
                                        <span>+</span>
                                        <span>Add to existing</span>
                                    </button>
                                    <button data-action="create-subcategory" data-place-id="${result.id}">
                                        <span>+</span>
                                        <span>Create sub-category</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.classList.remove('hidden');
        }

        function computeDistanceMeters(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const rad = (deg) => (deg * Math.PI) / 180;
            const dLat = rad(lat2 - lat1);
            const dLng = rad(lng2 - lng1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function mergeWithCategorized(results, center) {
            const mergedMap = new Map();
            results.forEach((result) => mergedMap.set(result.id, result));

            const categorized = budgetStore.getSnapshot().categorizedPlaces
                .map((entry) => {
                    const parent = budgetStore.findParent(entry.categoryId);
                    const located = budgetStore.findSubCategory(entry.subCategoryId);
                    return {
                        ...entry.place,
                        status: 'categorized',
                        colorStops: parent?.colorStops || GREEN_GRADIENT,
                        categoryId: entry.categoryId,
                        subCategoryId: entry.subCategoryId,
                        categoryName: parent?.name,
                        subCategoryName: located?.sub.name
                    };
                })
                .filter((place) => {
                    if (!center) return true;
                    return computeDistanceMeters(center.lat, center.lng, place.lat, place.lng) <= RADIUS_40_MILES_METERS * 1.5;
                });

            categorized.forEach((place) => {
                if (!mergedMap.has(place.id)) {
                    mergedMap.set(place.id, place);
                }
            });

            return Array.from(mergedMap.values());
        }

        async function geocodeIfLocation(query) {
            if (!query) return null;
            try {
                const url = `https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(query)}&limit=1&apiKey=${HERE_API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                const item = data.items?.[0];
                if (!item) return null;
                const type = item.resultType;
                if (['locality', 'administrativeArea', 'county', 'state', 'postalCode'].includes(type)) {
                    return {
                        lat: item.position.lat,
                        lng: item.position.lng
                    };
                }
            } catch (error) {
                console.error('Geocode error', error);
            }
            return null;
        }

        async function fetchHereResults(query, center, poiType) {
            const circle = `${center.lat},${center.lng};r=${RADIUS_40_MILES_METERS}`;
            let url;
            if (poiType && query) {
                url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(`${query} ${poiType}`)}&in=circle:${circle}&limit=80&apiKey=${HERE_API_KEY}`;
            } else if (poiType) {
                url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(poiType)}&in=circle:${circle}&limit=80&apiKey=${HERE_API_KEY}`;
            } else if (query) {
                url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(query)}&in=circle:${circle}&limit=80&apiKey=${HERE_API_KEY}`;
            } else {
                return [];
            }

            const response = await fetch(url);
            if (!response.ok) {
                console.error('HERE API error', await response.text());
                return [];
            }

            const data = await response.json();
            if (!data.items) return [];

            return data.items
                .filter((item) => item.position?.lat && item.position?.lng)
                .map((item) => ({
                    id: item.id,
                    name: item.title,
                    lat: item.position.lat,
                    lng: item.position.lng,
                    poiType: selectBestPoiType(item.categories),
                    address: formatAddress(item),
                    status: 'uncategorized'
                }));
        }

        async function runSearch(query) {
            if (HERE_API_KEY === 'YOUR_HERE_API_KEY') {
                console.error('HERE API key missing');
                return;
            }

            if (!query && !activePoiType) {
                latestResults = [];
                clearMarkers();
                const container = document.getElementById('search-results');
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            setLoaderVisible(true);
            let center = map.getCenter();
            const geocoded = await geocodeIfLocation(query);
            if (geocoded) {
                center = geocoded;
                map.setView([geocoded.lat, geocoded.lng], ZOOM_FOR_40_MILES);
            }

            try {
                const hereResults = await fetchHereResults(query, center, activePoiType);
                const merged = mergeWithCategorized(hereResults, center);
                latestResults = decorateResults(merged);
                renderMarkers(latestResults);
                renderSearchResults(latestResults);
            } catch (error) {
                console.error('Search error', error);
            } finally {
                setLoaderVisible(false);
            }
        }

        function refreshResults() {
            if (latestResults.length === 0) return;
            latestResults = decorateResults(latestResults);
            renderMarkers(latestResults);
            renderSearchResults(latestResults);
        }

        function toggleModal(modalId, open) {
            const modal = document.getElementById(modalId);
            modal.classList.toggle('active', open);
        }

        function populateSubcategorySelect(selectId) {
            const select = document.getElementById(selectId);
            const subCategories = budgetStore.getAllSubCategories();
            if (subCategories.length === 0) {
                select.innerHTML = '<option value="">No sub-categories yet</option>';
                select.disabled = true;
                return;
            }
            select.disabled = false;
            select.innerHTML = subCategories
                .map(
                    (sub) => `
                        <option value="${sub.id}">
                            ${sub.parentName} • ${sub.name}
                        </option>
                    `
                )
                .join('');
        }

        function populateParentSelect(selectId) {
            const select = document.getElementById(selectId);
            const snapshot = budgetStore.getSnapshot();
            if (!snapshot.parentCategories.length) {
                select.innerHTML = '<option value="">No parent categories yet</option>';
                select.disabled = true;
                return;
            }
            select.innerHTML = snapshot.parentCategories
                .map((parent) => `<option value="${parent.id}">${parent.name}</option>`)
                .join('');
            select.disabled = false;
        }

        function openExistingLinkModal(placeId) {
            const place = latestResults.find((item) => item.id === placeId);
            if (!place) return;
            pendingPlaceId = placeId;
            document.getElementById('link-place-name').textContent = place.name;
            populateSubcategorySelect('link-subcategory-select');
            toggleModal('link-subcategory-modal', true);
        }

        function openCreateSubcategoryModal(placeId, parentId) {
            const snapshot = budgetStore.getSnapshot();
            if (!snapshot.parentCategories.length) {
                openCreateParentModal();
                return;
            }
            pendingPlaceForNewSub = placeId || null;
            populateParentSelect('create-parent-select');
            const parentSelect = document.getElementById('create-parent-select');
            if (parentId) {
                parentSelect.value = parentId;
            }
            document.getElementById('create-subcategory-name').value = '';
            document.getElementById('create-subcategory-budget').value = 50;
            document.getElementById('create-budget-display').textContent = '$50';
            toggleModal('create-subcategory-modal', true);
        }

        function openCreateParentModal() {
            document.getElementById('create-parent-name').value = '';
            toggleModal('create-parent-modal', true);
        }

        function renderBudgetView(snapshot) {
            const container = document.getElementById('budget-list');
            if (!snapshot.parentCategories.length) {
                container.innerHTML = '<p class="text-sm text-slate-500">No parent categories yet. Create one to begin tracking.</p>';
                return;
            }

            container.innerHTML = snapshot.parentCategories
                .map((parent) => {
                    const gradient = gradientStyle(parent.colorStops);
                    const total = parent.totalBudget || parent.subCategories.reduce((sum, sub) => sum + sub.budgetAmount, 0);
                    const subList = parent.subCategories
                        .map(
                            (sub) => `
                                <div class="flex items-center justify-between rounded-xl bg-slate-50 px-3 py-2">
                                    <div>
                                        <p class="text-sm font-semibold text-slate-800">${sub.name}</p>
                                        <p class="text-xs text-slate-400">Budget ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(sub.budgetAmount)}</p>
                                    </div>
                                </div>
                            `
                        )
                        .join('');

                    return `
                        <article class="rounded-3xl border border-slate-200 bg-white p-4 shadow-sm space-y-4">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-2xl" style="background:${gradient}"></div>
                                    <div>
                                        <h3 class="font-semibold text-lg text-slate-900">${parent.name}</h3>
                                        <p class="text-xs uppercase tracking-wide text-slate-400">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(total)} budgeted</p>
                                    </div>
                                </div>
                                <button class="add-subcategory-btn flex h-9 items-center justify-center rounded-full bg-slate-100 px-3 text-xs font-semibold text-slate-600 hover:bg-slate-200" data-parent-id="${parent.id}">
                                    + Sub-category
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${subList || '<p class="text-xs text-slate-400">No sub-categories yet.</p>'}
                            </div>
                        </article>
                    `;
                })
                .join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            renderPoiButtons();

            budgetStore.subscribe((snapshot) => {
                populateParentSelect('create-parent-select');
                populateSubcategorySelect('link-subcategory-select');
                renderBudgetView(snapshot);
                refreshResults();
            });

            document.getElementById('search-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const query = document.getElementById('search-input').value.trim();
                runSearch(query || activePoiType);
            });

            document.getElementById('poi-type-strip').addEventListener('click', (event) => {
                const button = event.target.closest('.poi-button');
                if (!button) return;
                const type = button.dataset.poiType;
                activePoiType = activePoiType === type ? '' : type;
                document.querySelectorAll('.poi-button').forEach((btn) => btn.classList.remove('active'));
                if (activePoiType) {
                    button.classList.add('active');
                }
                if (activePoiType) {
                    runSearch(document.getElementById('search-input').value.trim());
                }
            });

            document.getElementById('search-results').addEventListener('click', (event) => {
                const actionButton = event.target.closest('button[data-action]');
                if (!actionButton) return;
                const placeId = actionButton.dataset.placeId;
                if (actionButton.dataset.action === 'link-existing') {
                    openExistingLinkModal(placeId);
                } else if (actionButton.dataset.action === 'create-subcategory') {
                    openCreateSubcategoryModal(placeId);
                }
            });

            document.getElementById('create-parent-btn').addEventListener('click', () => {
                openCreateParentModal();
            });

            document.getElementById('link-subcategory-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const select = document.getElementById('link-subcategory-select');
                const subCategoryId = select.value;
                if (!pendingPlaceId || !subCategoryId) {
                    pendingPlaceId = null;
                    toggleModal('link-subcategory-modal', false);
                    return;
                }
                const place = latestResults.find((item) => item.id === pendingPlaceId);
                if (!place) {
                    pendingPlaceId = null;
                    return;
                }
                budgetStore.linkPlaceToSubCategory(place, subCategoryId);
                toggleModal('link-subcategory-modal', false);
                pendingPlaceId = null;
            });

            document.querySelector('[data-action="cancel-link"]').addEventListener('click', () => {
                toggleModal('link-subcategory-modal', false);
                pendingPlaceId = null;
            });

            document.getElementById('create-subcategory-budget').addEventListener('input', (event) => {
                document.getElementById('create-budget-display').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(event.target.value || 0));
            });

            document.getElementById('create-subcategory-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const parentId = document.getElementById('create-parent-select').value;
                const name = document.getElementById('create-subcategory-name').value.trim();
                const budgetAmount = Number(document.getElementById('create-subcategory-budget').value || 0);
                if (!parentId || !name || budgetAmount <= 0) return;
                const sub = budgetStore.createSubCategory(parentId, name, budgetAmount);
                if (pendingPlaceForNewSub) {
                    const place = latestResults.find((item) => item.id === pendingPlaceForNewSub);
                    if (place) {
                        budgetStore.linkPlaceToSubCategory(place, sub.id);
                    }
                }
                toggleModal('create-subcategory-modal', false);
                pendingPlaceForNewSub = null;
            });

            document.querySelector('[data-action="cancel-create-subcategory"]').addEventListener('click', () => {
                toggleModal('create-subcategory-modal', false);
                pendingPlaceForNewSub = null;
            });

            document.getElementById('create-parent-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const name = document.getElementById('create-parent-name').value.trim();
                if (!name) return;
                budgetStore.createParentCategory(name);
                toggleModal('create-parent-modal', false);
            });

            document.querySelector('[data-action="cancel-create-parent"]').addEventListener('click', () => {
                toggleModal('create-parent-modal', false);
            });

            document.getElementById('budget-list').addEventListener('click', (event) => {
                const button = event.target.closest('.add-subcategory-btn');
                if (!button) return;
                const parentId = button.dataset.parentId;
                openCreateSubcategoryModal(null, parentId);
            });

            document.querySelectorAll('.nav-btn').forEach((button) => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach((btn) => btn.classList.remove('active', 'text-blue-600', 'bg-blue-50'));
                    document.querySelectorAll('.nav-btn').forEach((btn) => btn.classList.add('text-slate-500', 'bg-slate-100'));
                    button.classList.add('active', 'text-blue-600', 'bg-blue-50');
                    button.classList.remove('text-slate-500', 'bg-slate-100');
                    const target = button.dataset.view;
                    document.querySelectorAll('.sidebar-view').forEach((view) => view.classList.remove('active'));
                    document.getElementById(target).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
