
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Maps - Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet"
    />
    <style>
        :root {
            color-scheme: light;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        body {
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #map-container {
            position: relative;
            flex: 1 1 0%;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        #sidebar {
            width: 430px;
            background-color: #ffffff;
            box-shadow: -12px 0 35px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            z-index: 30;
        }

        #sidebar-content {
            flex: 1 1 0%;
            overflow-y: auto;
        }

        .sidebar-view {
            display: none;
        }

        .sidebar-view.active {
            display: block;
        }

        .map-overlay {
            pointer-events: none;
        }

        .map-overlay > * {
            pointer-events: auto;
        }

        .poi-button {
            border-radius: 9999px;
            font-size: 0.75rem;
            line-height: 1rem;
            padding: 0.5rem 0.9rem;
            background-color: rgba(255, 255, 255, 0.7);
            color: #0f172a;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
            transition: all 0.15s ease-in-out;
            white-space: nowrap;
        }

        .poi-button:hover {
            background-color: rgba(226, 232, 240, 0.85);
        }

        .poi-button.active {
            background-color: #1d4ed8;
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
        }

        .scrollbars::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .scrollbars::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.6);
            border-radius: 9999px;
        }

        .gradient-pin-wrapper {
            background: transparent;
        }

        .gradient-pin {
            width: 38px;
            height: 38px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
        }

        .gradient-pin svg {
            transform: rotate(45deg);
        }

        .gradient-pin.selected {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4), 0 12px 30px rgba(15, 23, 42, 0.25);
            border-color: rgba(37, 99, 235, 0.6);
        }

        .search-result-card {
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        .search-result-card.selected {
            border: 2px solid rgba(37, 99, 235, 0.3);
            box-shadow: 0 16px 40px rgba(37, 99, 235, 0.15);
        }

        .search-result-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
        }

        .search-result-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: #0f172a;
            transition: all 0.15s ease;
        }

        .search-result-actions button:hover {
            background-color: rgba(226, 232, 240, 0.85);
        }

        #map-card-container.hidden {
            display: none;
        }

        .map-card {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
            box-shadow: 0 30px 70px rgba(15, 23, 42, 0.25);
            padding: 1.5rem;
        }

        .map-card .map-card-actions button {
            flex: 1;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 0.6rem 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            transition: background-color 0.15s ease, transform 0.15s ease;
        }

        .map-card .map-card-actions button:hover {
            background-color: rgba(226, 232, 240, 0.85);
            transform: translateY(-1px);
        }

        .map-card .map-card-actions button.primary {
            background: #2563eb;
            color: #ffffff;
            border-color: transparent;
        }

        .map-card .map-card-actions button.primary:hover {
            background: #1d4ed8;
        }

        .map-card-close {
            height: 2rem;
            width: 2rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(248, 250, 252, 0.8);
            transition: background-color 0.15s ease;
        }

        .map-card-close:hover {
            background: rgba(226, 232, 240, 0.85);
        }

        .collapse-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2.25rem;
            width: 2.25rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(248, 250, 252, 0.9);
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }

        .collapse-toggle:hover {
            background: rgba(226, 232, 240, 0.85);
            border-color: rgba(148, 163, 184, 0.6);
        }

        .collapse-toggle svg {
            transition: transform 0.2s ease;
        }

        .collapse-toggle[aria-expanded='true'] svg {
            transform: rotate(180deg);
        }

        .badge {
            padding: 0.15rem 0.55rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-panel {
            width: 100%;
            max-width: 460px;
            background-color: white;
            border-radius: 1.25rem;
            padding: 1.75rem;
            box-shadow: 0 30px 55px rgba(15, 23, 42, 0.18);
        }

        .budget-overview-entry {
            border-radius: 1.5rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(14, 165, 233, 0.12));
            border: 1px solid rgba(37, 99, 235, 0.18);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 12px 30px rgba(15, 23, 42, 0.08);
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .budget-overview-entry:hover {
            transform: translateY(-1px);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 18px 36px rgba(37, 99, 235, 0.12);
        }

        .budget-overview-entry:focus-visible {
            outline: 3px solid rgba(59, 130, 246, 0.6);
            outline-offset: 2px;
        }

        .timeline-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            z-index: 60;
        }

        .timeline-overlay.active {
            display: flex;
        }

        .timeline-dialog {
            position: relative;
            width: min(1100px, 92vw);
            max-height: calc(100vh - 4rem);
            border-radius: 1.75rem;
            overflow: hidden;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 120px rgba(15, 23, 42, 0.45);
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .timeline-body {
            padding: 1.25rem 1.75rem 1.75rem;
            overflow: hidden auto;
        }

        .timeline-close-btn {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            padding: 0.45rem 0.9rem;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .timeline-close-btn:hover {
            border-color: rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.75);
        }

        .timeline-focus-sentinel {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
        }

        .modal-panel h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .input-row label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
        }

        .input-row input,
        .input-row select {
            border-radius: 0.85rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 0.6rem 0.75rem;
            font-size: 0.9rem;
            color: #0f172a;
        }

        .input-row input:focus,
        .input-row select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .slider-input {
            width: 100%;
        }

        #map-loader {
            display: none;
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(1px);
            z-index: 25;
            align-items: center;
            justify-content: center;
        }

        #map-loader.active {
            display: flex;
        }

        .loader {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 4px solid rgba(148, 163, 184, 0.4);
            border-top-color: #2563eb;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="map-container">
            <div id="map"></div>
            <div id="map-loader" class="flex"><div class="loader"></div></div>
            <div class="map-overlay absolute inset-0 z-20">
                <div class="p-4">
                    <div class="max-w-3xl mx-auto space-y-3 pointer-events-auto">
                        <form id="search-form" class="relative flex items-center">
                        <span class="absolute left-4 text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="7"></circle>
                                <line x1="20" y1="20" x2="16.65" y2="16.65"></line>
                            </svg>
                        </span>
                        <input
                            id="search-input"
                            name="search"
                            type="text"
                            placeholder="Search city, state, or business"
                            class="w-full bg-white rounded-full py-3 pl-12 pr-28 shadow-xl text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-blue-100"
                            autocomplete="off"
                        />
                        <button
                            type="submit"
                            class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md"
                        >
                            Search
                        </button>
                    </form>
                        <div id="poi-type-strip" class="scrollbars flex items-center gap-2 overflow-x-auto rounded-2xl bg-white/80 backdrop-blur-sm p-2 shadow-lg"></div>
                        <div id="search-results" class="hidden max-h-96 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
                <div id="map-card-host" class="absolute bottom-0 left-0 right-0 p-4 pb-6 pointer-events-none">
                    <div id="map-card-container" class="max-w-md mx-auto pointer-events-auto hidden"></div>
                </div>
            </div>
        </div>
        <aside id="sidebar">
            <div class="p-4 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Money Maps</h1>
                        <p class="text-sm text-slate-500">Budget &amp; Map intelligence</p>
                    </div>
                    <div class="flex rounded-full bg-slate-100 text-xs font-semibold text-slate-600 px-3 py-1">Beta</div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-4">
                    <button class="nav-btn active flex items-center justify-center rounded-xl py-2 font-semibold text-sm text-blue-600 bg-blue-50" data-view="budget-view">Budget</button>
                    <button class="nav-btn flex items-center justify-center rounded-xl py-2 font-semibold text-sm text-slate-500 bg-slate-100" data-view="accounts-view">Accounts</button>
                    <button class="nav-btn flex items-center justify-center rounded-xl py-2 font-semibold text-sm text-slate-500 bg-slate-100" data-view="transactions-view">Transactions</button>
                </div>
            </div>
            <div id="sidebar-content">
                <section id="budget-view" class="sidebar-view active p-4 space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900">Fund Flows</h2>
                        <button id="create-parent-btn" class="flex h-9 w-9 items-center justify-center rounded-full bg-blue-600 text-white shadow-md hover:bg-blue-700" title="Create parent category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span class="font-semibold text-slate-600">Viewing:</span>
                        <span id="active-data-source" class="badge bg-slate-100 text-slate-600">Demo data</span>
                        <span id="active-account-filter" class="hidden badge bg-blue-50 text-blue-700"></span>
                        <button id="clear-account-filter" class="hidden text-blue-600 hover:underline text-xs font-semibold">Clear filter</button>
                    </div>
                    <button
                        id="budget-overview-entry"
                        class="budget-overview-entry text-left"
                        type="button"
                        aria-haspopup="dialog"
                        aria-controls="budget-timeline-overlay"
                    >
                        <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-blue-500/20 text-blue-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 7.5h16.5M3.75 12h9.75m-9.75 4.5h6.75" />
                            </svg>
                        </div>
                        <div class="flex-1 space-y-1">
                            <p class="text-xs uppercase tracking-wide text-blue-200/80 font-semibold">Modular Budget Overview</p>
                            <p id="budget-overview-entry-label" class="text-sm font-semibold text-white">Open timeline</p>
                            <p class="text-xs text-blue-100/70">
                                <span id="budget-overview-period-label">Current month</span>
                                â€¢ Day <span id="budget-overview-day">1</span>
                            </p>
                        </div>
                        <div class="flex flex-col items-end gap-1 text-right text-xs text-blue-100/70">
                            <span class="font-semibold text-white" id="budget-overview-inflow">$0</span>
                            <span>Inflow</span>
                        </div>
                    </button>
                    <div id="budget-list" class="space-y-4"></div>
                </section>
                <section id="accounts-view" class="sidebar-view p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900">Accounts</h2>
                        <button id="disconnect-plaid" class="hidden text-xs font-semibold text-rose-600 hover:underline">Disconnect</button>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span class="font-semibold text-slate-600">Source:</span>
                        <span id="accounts-data-source" class="badge bg-slate-100 text-slate-600">Demo</span>
                    </div>
                    <div id="accounts-summary" class="rounded-3xl bg-slate-900 text-white p-4 space-y-1 hidden">
                        <p class="text-xs uppercase tracking-wide text-slate-300">Total balance</p>
                        <p id="accounts-total" class="text-2xl font-semibold">$0.00</p>
                    </div>
                    <div id="accounts-list" class="space-y-3"></div>
                </section>
                <section id="transactions-view" class="sidebar-view p-4 space-y-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Transactions</h2>
                            <p class="text-sm text-slate-500">Stay in sync across Plaid, demo, and map categories.</p>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            <button id="demo-data-btn" class="hidden text-xs font-semibold text-blue-600 hover:underline">Use Demo Data (200)</button>
                            <button id="reset-demo-btn" class="hidden text-xs font-semibold text-slate-500 hover:underline">Reset Demo Data</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="connect-plaid-btn" class="px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow">Connect Bank (Plaid)</button>
                        <div id="transactions-source-pill" class="badge bg-slate-100 text-slate-600">Using demo data</div>
                        <div id="transactions-account-pill" class="hidden badge bg-blue-50 text-blue-700"></div>
                    </div>
                    <div id="plaid-feedback" class="text-xs font-semibold text-emerald-600 hidden"></div>
                    <div class="border border-slate-200 rounded-3xl overflow-hidden">
                        <div class="grid grid-cols-[auto_1fr_auto_auto] gap-3 bg-slate-50 px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wide">
                            <div>Date</div>
                            <div>Merchant</div>
                            <div>Amount</div>
                            <div>Category</div>
                        </div>
                        <div id="transactions-list" class="divide-y divide-slate-100 max-h-[420px] overflow-y-auto"></div>
                    </div>
                </section>
            </div>
        </aside>
    </div>

    <div id="budget-timeline-overlay" class="timeline-overlay" role="dialog" aria-modal="true" aria-labelledby="budget-timeline-title">
        <span class="timeline-focus-sentinel" tabindex="0"></span>
        <div class="timeline-dialog">
            <header class="timeline-header">
                <div>
                    <p class="text-xs uppercase tracking-wide text-blue-200/70 font-semibold">Budget intelligence</p>
                    <h2 id="budget-timeline-title" class="text-lg font-semibold text-white">Modular Budget Timeline</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="budget-timeline-minimize" class="timeline-close-btn" type="button">Minimize</button>
                </div>
            </header>
            <div class="timeline-body" id="budget-timeline-host"></div>
        </div>
        <span class="timeline-focus-sentinel" tabindex="0"></span>
    </div>

    <div id="link-subcategory-modal" class="modal-backdrop">
        <div class="modal-panel space-y-5">
            <div class="space-y-2">
                <h3>Select a sub-category</h3>
                <p class="text-sm text-slate-500">Choose where to track <span id="link-context-label" class="font-semibold text-slate-700"></span>.</p>
            </div>
            <div class="space-y-3">
                <div class="input-row">
                    <label for="subcategory-search">Search</label>
                    <input id="subcategory-search" type="text" placeholder="Filter by name" />
                </div>
                <div id="subcategory-chip-grid" class="grid gap-2 max-h-72 overflow-y-auto"></div>
            </div>
            <div class="flex items-center justify-between">
                <button type="button" id="link-create-subcategory" class="flex items-center gap-2 text-sm font-semibold text-blue-600 hover:underline">
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-blue-100 text-blue-700">+</span>
                    Create new sub-category
                </button>
                <button type="button" data-action="cancel-link" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Close</button>
            </div>
        </div>
    </div>

    <div id="create-subcategory-modal" class="modal-backdrop">
        <div class="modal-panel space-y-6">
            <div class="space-y-2">
                <h3>Create sub-category</h3>
                <p class="text-sm text-slate-500">Create a sub-category and optionally link the selected item.</p>
            </div>
            <form id="create-subcategory-form" class="space-y-5">
                <div class="input-row">
                    <label for="create-parent-select">Parent category</label>
                    <select id="create-parent-select" required></select>
                </div>
                <div class="input-row">
                    <label for="create-subcategory-name">Sub-category name</label>
                    <input id="create-subcategory-name" type="text" placeholder="e.g. Electronics" required />
                </div>
                <div class="input-row">
                    <label for="create-subcategory-budget">Budget amount</label>
                    <input id="create-subcategory-budget" type="range" min="25" max="5000" step="25" class="slider-input" />
                    <div class="flex items-center justify-between text-sm">
                        <div class="font-semibold text-blue-600" id="create-budget-display">$25</div>
                        <input id="create-subcategory-budget-input" type="number" min="0" max="10000" step="5" class="w-24 rounded-full border border-slate-200 px-3 py-1 text-right text-sm" />
                    </div>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button type="button" data-action="cancel-create-subcategory" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-parent-modal" class="modal-backdrop">
        <div class="modal-panel space-y-6">
            <div class="space-y-2">
                <h3>Create parent category</h3>
                <p class="text-sm text-slate-500">Add a new parent category for your budget.</p>
            </div>
            <form id="create-parent-form" class="space-y-5">
                <div class="input-row">
                    <label for="create-parent-name">Category name</label>
                    <input id="create-parent-name" type="text" placeholder="e.g. Education" required />
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button type="button" data-action="cancel-create-parent" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-500 hover:bg-slate-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';
const STORAGE_KEY = 'money-maps-state-v2';
const POI_OVERRIDE_STORAGE_KEY = 'money-maps-poi-overrides-v1';
const STRICT_DEMO_MODE = Boolean(window.STRICT_DEMO_MODE);

const PLAID_LINK_TOKEN_ENDPOINT = window.MONEYMAPS_PLAID_LINK_TOKEN_URL || '/api/create_link_token';
const PLAID_TOKEN_EXCHANGE_ENDPOINT = window.MONEYMAPS_PLAID_EXCHANGE_URL || '/api/exchange_public_token';
const DEFAULT_PLAID_ENV = window.MONEYMAPS_PLAID_ENV || 'sandbox';

const POI_TYPES = [
    "airport","amusement park","aquarium","art gallery","ATM","bakery","bank","bar","beauty salon","bicycle store","book store","bowling alley","bus station","cafe","campground","car dealer","car rental","car repair","car wash","casino","cemetery","church","city hall","clothing store","convenience store","courthouse","dentist","department store","doctor","drugstore","electrician","electronics store","embassy","fire station","florist","funeral home","furniture store","gas station","gym","hair care","hardware store","Hindu temple","home goods store","hospital","insurance agency","jewelry store","laundry","lawyer","library","light rail station","liquor store","local government office","locksmith","lodging","meal delivery","meal takeaway","mosque","movie rental","movie theater","moving company","museum","night club","painter","park","parking","pet store","pharmacy","physiotherapist","plumber","police","post office","primary school","real estate agency","restaurant","roofing contractor","RV park","school","secondary school","shoe store","shopping mall","spa","stadium","storage","store","subway station","supermarket","synagogue","taxi stand","tourist attraction","train station","transit station","travel agency","university","veterinary care","zoo"
];

const GREEN_GRADIENT = ['#34d399', '#059669'];
const COLOR_PALETTE = [
    ['#2563eb', '#1e40af'],
    ['#ec4899', '#be185d'],
    ['#f59e0b', '#b45309'],
    ['#10b981', '#047857'],
    ['#6366f1', '#4338ca'],
    ['#f97316', '#c2410c'],
    ['#14b8a6', '#0f766e'],
    ['#8b5cf6', '#6d28d9'],
    ['#0ea5e9', '#0369a1'],
    ['#f43f5e', '#be123c']
];

const searchUIState = {
    isDropdownVisible: true,
    isPOIButtonsVisible: true
};

let budgetTimelineController = null;
let budgetTimelineOverlayOpen = false;
let budgetTimelineFocusReturn = null;

const SUB_GRADIENT_VARIANTS = [
    { start: 0.02, end: -0.05 },
    { start: 0.08, end: 0 },
    { start: -0.05, end: -0.12 },
    { start: 0.14, end: 0.05 }
];

const ZOOM_FOR_40_MILES = 10;
const RADIUS_40_MILES_METERS = 64373;

function slugify(value) {
    return value
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)+/g, '') || `id-${Date.now()}`;
}

function clone(obj) {
    if (typeof structuredClone === 'function') {
        return structuredClone(obj);
    }
    return JSON.parse(JSON.stringify(obj));
}

function hexToRgb(hex) {
    const sanitized = hex.replace('#', '');
    const bigint = parseInt(sanitized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return { r, g, b };
}

function rgbToHsl({ r, g, b }) {
    r /= 255;
    g /= 255;
    b /= 255;
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h = 0;
    let s = 0;
    const l = (max + min) / 2;

    if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
        }
        h /= 6;
    }

    return { h, s, l };
}

function hslToRgb({ h, s, l }) {
    let r, g, b;

    if (s === 0) {
        r = g = b = l;
    } else {
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1 / 6) return p + (q - p) * 6 * t;
            if (t < 1 / 2) return q;
            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
            return p;
        };

        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1 / 3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1 / 3);
    }

    return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
    };
}

function rgbToHex({ r, g, b }) {
    return `#${[r, g, b]
        .map((x) => {
            const hex = x.toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        })
        .join('')}`;
}

function adjustHex(hex, delta) {
    const hsl = rgbToHsl(hexToRgb(hex));
    hsl.l = Math.min(1, Math.max(0, hsl.l + delta));
    return rgbToHex(hslToRgb(hsl));
}

function deriveSubGradient(parentStops, variantIndex) {
    const variant = SUB_GRADIENT_VARIANTS[variantIndex % SUB_GRADIENT_VARIANTS.length];
    const [start, end] = parentStops;
    return [adjustHex(start, variant.start), adjustHex(end, variant.end)];
}

function gradientStyle(stops) {
    return `linear-gradient(135deg, ${stops[0]}, ${stops[1]})`;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
}

function formatPercent(value) {
    return `${Math.round(value * 100)}%`;
}

function startOfMonth(date) {
    return new Date(date.getFullYear(), date.getMonth(), 1);
}

function endOfMonth(date) {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0);
}

function addDays(date, amount) {
    const result = new Date(date);
    result.setDate(result.getDate() + amount);
    return result;
}

function parseISODate(value) {
    if (!value) return null;
    return new Date(`${value}T00:00:00`);
}

function formatISODate(date) {
    return date.toISOString().slice(0, 10);
}

function clampDate(date, min, max) {
    if (date < min) return new Date(min);
    if (date > max) return new Date(max);
    return date;
}

function differenceInDays(start, end) {
    const ms = end.getTime() - start.getTime();
    return Math.floor(ms / (24 * 60 * 60 * 1000));
}

function formatMonthTitle(date) {
    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
}

function normalizeTimelineState(input) {
    const today = new Date();
    const baseStart = input?.periodStart ? parseISODate(input.periodStart) : startOfMonth(today);
    const baseEnd = input?.periodEnd ? parseISODate(input.periodEnd) : endOfMonth(today);
    const start = baseStart && !Number.isNaN(baseStart.getTime()) ? baseStart : startOfMonth(today);
    const end = baseEnd && !Number.isNaN(baseEnd.getTime()) ? baseEnd : endOfMonth(today);
    const safeEnd = end < start ? new Date(start) : end;
    const limitDate = today < safeEnd ? today : safeEnd;
    const selected = input?.selectedDate ? parseISODate(input.selectedDate) : limitDate;
    const selectedSafe = selected && !Number.isNaN(selected.getTime()) ? clampDate(selected, start, limitDate) : limitDate;
    return {
        periodStart: formatISODate(start),
        periodEnd: formatISODate(safeEnd),
        selectedDate: formatISODate(selectedSafe),
        granularity: input?.granularity === 'week' ? 'week' : 'day',
        focusCategoryId: input?.focusCategoryId || null
    };
}

function loadPoiOverrideTable() {
    try {
        const raw = localStorage.getItem(POI_OVERRIDE_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
            return parsed;
        }
    } catch (error) {
        console.error('Failed to parse POI override table', error);
    }
    return {};
}

function persistPoiOverrideTable(table) {
    try {
        localStorage.setItem(POI_OVERRIDE_STORAGE_KEY, JSON.stringify(table));
    } catch (error) {
        console.error('Failed to persist POI override table', error);
    }
}

function getRuntimePoiOverrides() {
    if (window.MoneyMapsPOIOverrides && typeof window.MoneyMapsPOIOverrides === 'object') {
        return window.MoneyMapsPOIOverrides;
    }
    return {};
}

function normalizePoiLabel(label) {
    return (label || '').toString().trim().toLowerCase();
}

const DEFAULT_POI_SYNONYMS = {
    'coffee shop': ['coffee', 'coffee shops', 'cafe'],
    cafe: ['coffee shops', 'restaurants'],
    restaurant: ['restaurants', 'food', 'dining'],
    'fast food restaurant': ['restaurants', 'food'],
    supermarket: ['groceries', 'grocery'],
    'grocery store': ['groceries', 'food'],
    pharmacy: ['pharmacy', 'health'],
    gym: ['fitness', 'health'],
    'fitness center': ['fitness', 'health'],
    'gas station': ['fuel', 'gas'],
    'taxi stand': ['rideshare', 'transportation'],
    parking: ['parking', 'transportation'],
    'streaming service': ['streaming', 'entertainment'],
    museum: ['events', 'entertainment'],
    stadium: ['events', 'entertainment'],
    'outdoor shop': ['outdoors'],
    'outdoor recreation': ['outdoors'],
    'fitness & sports': ['fitness']
};

const FALLBACK_CATEGORY_LABELS = ['misc', 'other', 'uncategorized'];

const DEFAULT_CATEGORY_SETUP = [
    {
        id: 'home-life',
        name: 'Home & Life',
        subCategories: [
            { id: 'rent-mortgage', name: 'Rent & Mortgage', budget: 1800 },
            { id: 'utilities', name: 'Utilities', budget: 220 },
            { id: 'home-supplies', name: 'Home Supplies', budget: 160 }
        ]
    },
    {
        id: 'food-dining',
        name: 'Food & Dining',
        subCategories: [
            { id: 'groceries', name: 'Groceries', budget: 550 },
            { id: 'restaurants', name: 'Restaurants', budget: 320 },
            { id: 'coffee', name: 'Coffee Shops', budget: 110 }
        ]
    },
    {
        id: 'transport',
        name: 'Transportation',
        subCategories: [
            { id: 'fuel', name: 'Fuel', budget: 200 },
            { id: 'rideshare', name: 'Rideshare & Taxi', budget: 120 },
            { id: 'parking', name: 'Parking', budget: 60 }
        ]
    },
    {
        id: 'health',
        name: 'Health & Wellness',
        subCategories: [
            { id: 'pharmacy', name: 'Pharmacy', budget: 85 },
            { id: 'fitness', name: 'Fitness & Sports', budget: 95 }
        ]
    },
    {
        id: 'entertainment',
        name: 'Entertainment',
        subCategories: [
            { id: 'streaming', name: 'Streaming & Media', budget: 70 },
            { id: 'events', name: 'Concerts & Events', budget: 120 },
            { id: 'outdoors', name: 'Outdoors & Adventure', budget: 140 }
        ]
    }
];

function buildDefaultCategories() {
    const categories = [];
    const subCategories = [];
    DEFAULT_CATEGORY_SETUP.forEach((entry, index) => {
        const colorStops = COLOR_PALETTE[index % COLOR_PALETTE.length];
        categories.push({ id: entry.id, name: entry.name, colorStops });
        entry.subCategories.forEach((sub, subIndex) => {
            subCategories.push({
                id: sub.id,
                parentId: entry.id,
                name: sub.name,
                budget: sub.budget,
                colorStops: deriveSubGradient(colorStops, subIndex)
            });
        });
    });
    return { categories, subCategories, paletteIndex: categories.length };
}

function getActiveSource(state) {
    return state.sources[state.dataSource] || { accounts: [], transactions: [], seeded: false };
}

function getFilteredTransactions(state) {
    const source = getActiveSource(state);
    let transactions = source.transactions || [];
    if (state.activeAccountId) {
        transactions = transactions.filter((txn) => txn.accountId === state.activeAccountId);
    }
    const timeline = getTimelineState(state);
    const periodStart = parseISODate(timeline.periodStart);
    const selectedDate = parseISODate(timeline.selectedDate);
    transactions = transactions.filter((txn) => {
        const txnDate = parseISODate(txn.date);
        if (!txnDate) return false;
        return txnDate >= periodStart && txnDate <= selectedDate;
    });
    return transactions;
}

function computeSpentBySubCategory(state) {
    const spent = new Map();
    const transactions = getFilteredTransactions(state);
    transactions.forEach((txn) => {
        if (!txn.subCategoryId) return;
        const amount = txn.amount < 0 ? Math.abs(txn.amount) : 0;
        if (amount === 0) return;
        spent.set(txn.subCategoryId, (spent.get(txn.subCategoryId) || 0) + amount);
    });
    return spent;
}

function computeSpentBySubCategoryAll(state) {
    const spent = new Map();
    const transactions = (getActiveSource(state).transactions || []).slice();
    transactions.forEach((txn) => {
        if (!txn.subCategoryId) return;
        const amount = txn.amount < 0 ? Math.abs(txn.amount) : 0;
        if (amount === 0) return;
        spent.set(txn.subCategoryId, (spent.get(txn.subCategoryId) || 0) + amount);
    });
    return spent;
}

function summarizeCategorySpend(categoryId, subCategoryId, state, spentMap) {
    const summary = { budget: 0, spent: 0, available: 0 };
    if (!state) return summary;
    if (subCategoryId) {
        const sub = state.subCategories.find((item) => item.id === subCategoryId);
        if (!sub) return summary;
        const budget = Number(sub.budget || 0);
        const spent = spentMap.get(sub.id) || 0;
        summary.budget = budget;
        summary.spent = spent;
        summary.available = Math.max(0, budget - spent);
        return summary;
    }
    if (categoryId) {
        const subs = state.subCategories.filter((item) => item.parentId === categoryId);
        const budget = subs.reduce((sum, sub) => sum + (Number(sub.budget) || 0), 0);
        const spent = subs.reduce((sum, sub) => sum + (spentMap.get(sub.id) || 0), 0);
        summary.budget = budget;
        summary.spent = spent;
        summary.available = Math.max(0, budget - spent);
        return summary;
    }
    return summary;
}

function resolveOverrideMapping(overrideValue, state) {
    if (!overrideValue) return null;
    const overrides = typeof overrideValue === 'string' ? { subCategoryId: overrideValue } : overrideValue;
    if (overrides.subCategoryId) {
        const sub = state.subCategories.find((item) => item.id === overrides.subCategoryId);
        if (sub) {
            return {
                categoryId: sub.parentId,
                subCategoryId: sub.id,
                confidence: overrides.confidence ?? 0.98,
                matchedName: overrides.label || sub.name
            };
        }
    }
    if (overrides.categoryId) {
        const category = state.categories.find((item) => item.id === overrides.categoryId);
        if (category) {
            return {
                categoryId: category.id,
                confidence: overrides.confidence ?? 0.85,
                matchedName: overrides.label || category.name
            };
        }
    }
    if (typeof overrideValue === 'string') {
        const category = state.categories.find((item) => normalizePoiLabel(item.name) === normalizePoiLabel(overrideValue));
        if (category) {
            return {
                categoryId: category.id,
                confidence: 0.85,
                matchedName: category.name
            };
        }
    }
    return null;
}

function getBudgetCategoryForPOI(poiType, state = appStore.getState()) {
    const normalized = normalizePoiLabel(poiType);
    if (!normalized) {
        return { confidence: 0 };
    }

    const combinedOverrides = Object.assign({}, state.poiCategoryOverrides || {}, getRuntimePoiOverrides());
    const overrideValue = combinedOverrides[normalized] || combinedOverrides[normalized.replace(/s$/, '')];
    if (overrideValue) {
        const resolved = resolveOverrideMapping(overrideValue, state);
        if (resolved) {
            return { ...resolved, confidence: Math.min(1, resolved.confidence ?? 0.95) };
        }
    }

    const subCategories = state.subCategories || [];
    const categories = state.categories || [];

    const directSub = subCategories.find((sub) => normalizePoiLabel(sub.name) === normalized);
    if (directSub) {
        return { categoryId: directSub.parentId, subCategoryId: directSub.id, confidence: 1, matchedName: directSub.name };
    }

    const directCategory = categories.find((cat) => normalizePoiLabel(cat.name) === normalized);
    if (directCategory) {
        return { categoryId: directCategory.id, confidence: 0.9, matchedName: directCategory.name };
    }

    const synonymTargets = DEFAULT_POI_SYNONYMS[normalized] || [];
    for (const synonym of synonymTargets) {
        const normalizedSynonym = normalizePoiLabel(synonym);
        const subMatch = subCategories.find((sub) => normalizePoiLabel(sub.name) === normalizedSynonym);
        if (subMatch) {
            return { categoryId: subMatch.parentId, subCategoryId: subMatch.id, confidence: 0.75, matchedName: subMatch.name };
        }
        const catMatch = categories.find((cat) => normalizePoiLabel(cat.name) === normalizedSynonym);
        if (catMatch) {
            return { categoryId: catMatch.id, confidence: 0.6, matchedName: catMatch.name };
        }
    }

    const fuzzySub = subCategories.find((sub) => {
        const name = normalizePoiLabel(sub.name);
        return name.includes(normalized) || normalized.includes(name);
    });
    if (fuzzySub) {
        return { categoryId: fuzzySub.parentId, subCategoryId: fuzzySub.id, confidence: 0.55, matchedName: fuzzySub.name };
    }

    const fuzzyParent = categories.find((cat) => {
        const name = normalizePoiLabel(cat.name);
        return name.includes(normalized) || normalized.includes(name);
    });
    if (fuzzyParent) {
        return { categoryId: fuzzyParent.id, confidence: 0.45, matchedName: fuzzyParent.name };
    }

    const fallback = categories.find((cat) => {
        const name = normalizePoiLabel(cat.name);
        return FALLBACK_CATEGORY_LABELS.some((needle) => name.includes(needle));
    });
    if (fallback) {
        return { categoryId: fallback.id, confidence: 0.3, matchedName: fallback.name };
    }

    return { confidence: 0 };
}

function getAvailableToSpend(categoryId, subCategoryId) {
    const state = appStore.getState();
    const spentMap = computeSpentBySubCategoryAll(state);
    const summary = summarizeCategorySpend(categoryId, subCategoryId, state, spentMap);
    return summary.available;
}

function computeAccountTotals(state) {
    const transactions = getFilteredTransactions(state);
    const totals = new Map();
    transactions.forEach((txn) => {
        const amount = txn.amount;
        totals.set(txn.accountId, (totals.get(txn.accountId) || 0) + amount);
    });
    return totals;
}

function getTimelineState(state) {
    return normalizeTimelineState(state?.timeline);
}

function computeBudgetTimelineSnapshot(state) {
    const timeline = getTimelineState(state);
    const periodStart = parseISODate(timeline.periodStart);
    const periodEnd = parseISODate(timeline.periodEnd);
    const selectedDate = parseISODate(timeline.selectedDate);
    const today = new Date();
    const limitDate = today < periodEnd ? today : periodEnd;
    const dayCount = differenceInDays(periodStart, periodEnd) + 1;
    const effectiveSelected = selectedDate > limitDate ? limitDate : selectedDate;
    const selectedIndex = Math.min(dayCount - 1, Math.max(0, differenceInDays(periodStart, effectiveSelected)));

    const source = getActiveSource(state);
    const subToParent = new Map();
    state.subCategories.forEach((sub) => subToParent.set(sub.id, sub.parentId));

    const categoryBudgets = new Map();
    state.subCategories.forEach((sub) => {
        const parentId = sub.parentId;
        categoryBudgets.set(parentId, (categoryBudgets.get(parentId) || 0) + (Number(sub.budget) || 0));
    });

    const categorySeries = new Map();
    state.categories.forEach((category) => {
        categorySeries.set(category.id, {
            id: category.id,
            name: category.name,
            color: category.colorStops?.[0] || '#60a5fa',
            gradient: gradientStyle(category.colorStops || ['#60a5fa', '#34d399']),
            budget: categoryBudgets.get(category.id) || 0,
            spentByDay: Array.from({ length: dayCount }, () => 0)
        });
    });

    let inflow = 0;
    const transactions = source.transactions || [];
    transactions.forEach((txn) => {
        const txnDate = parseISODate(txn.date);
        if (!txnDate) return;
        if (txnDate < periodStart || txnDate > periodEnd) return;
        if (txn.amount > 0) {
            inflow += txn.amount;
        }
        if (txn.amount < 0) {
            const parentId = subToParent.get(txn.subCategoryId);
            if (!parentId) return;
            const series = categorySeries.get(parentId);
            if (!series) return;
            const dayIndex = Math.min(dayCount - 1, Math.max(0, differenceInDays(periodStart, txnDate)));
            series.spentByDay[dayIndex] += Math.abs(txn.amount);
        }
    });

    const categories = Array.from(categorySeries.values());
    categories.forEach((series) => {
        let running = 0;
        series.cumulative = series.spentByDay.map((value) => {
            running += value;
            return running;
        });
        series.totalSpent = running;
        series.spentToSelected = series.cumulative[selectedIndex] || running;
    });

    const budgeted = Array.from(categoryBudgets.values()).reduce((sum, value) => sum + value, 0);
    const unallocated = Math.max(0, inflow - budgeted);

    return {
        period: {
            start: periodStart,
            end: periodEnd,
            limit: limitDate,
            selectedIndex,
            selectedDate: effectiveSelected,
            dayCount,
            granularity: timeline.granularity
        },
        categories,
        inflow,
        budgeted,
        unallocated,
        focusCategoryId: timeline.focusCategoryId
    };
}

const TIMELINE_STYLE_ID = 'budget-timeline-style-block';
let timelineStylesInjected = false;

function ensureBudgetTimelineStyles() {
    if (timelineStylesInjected) return;
    if (document.getElementById(TIMELINE_STYLE_ID)) {
        timelineStylesInjected = true;
        return;
    }
    const style = document.createElement('style');
    style.id = TIMELINE_STYLE_ID;
    style.textContent = `:root{--bg:#0b1220;--panel:#111827;--panel-2:#0f172a;--ink:#e5e7eb;--ink-dim:#9ca3af;--accent:#60a5fa;--accent-2:#34d399;--grid:#1f2937;--warn:#f59e0b;--alert:#ef4444;} .timeline-root{font-family:ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji','Inter var',Inter,sans-serif;background-color:#111827;color:var(--ink);} .timeline-root .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));box-shadow:0 6px 24px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03);} .timeline-root .grid-bg{background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:24px 24px,24px 24px;background-position:-1px -1px,-1px -1px;} .timeline-root .chip{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.25);color:#cfe6ff;} .timeline-root .bar{border-radius:10px;height:18px;background:linear-gradient(90deg,rgba(96,165,250,.35),rgba(52,211,153,.35));box-shadow:inset 0 1px 0 rgba(255,255,255,.08);} .timeline-root .bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,#60a5fa,#34d399);box-shadow:0 3px 16px rgba(52,211,153,.25);} .timeline-root .flow{height:6px;border-radius:999px;background:linear-gradient(90deg,rgba(99,102,241,.45),rgba(34,197,94,.45));} .timeline-root .mini-badge{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);border-radius:8px;padding:2px 6px;font-size:12px;color:var(--ink-dim);} .timeline-root .legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;} .timeline-root .legend{display:flex;gap:12px;flex-wrap:wrap;color:#d1d5db;font-size:12px;} .timeline-root .slider{-webkit-appearance:none;height:4px;border-radius:999px;background:#1f2937;outline:none;width:100%;} .timeline-root .slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#93c5fd,#3b82f6);border:2px solid #0b1220;box-shadow:0 6px 12px rgba(59,130,246,.45);cursor:pointer;} .timeline-root .kpi{border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:14px;padding:10px 12px;} .timeline-root .scroll-shadow{-webkit-mask-image:linear-gradient(to bottom,transparent 0,#000 18px,#000 calc(100% - 18px),transparent 100%);mask-image:linear-gradient(to bottom,transparent 0,#000 18px,#000 calc(100% - 18px),transparent 100%);} .timeline-root .btn{background:linear-gradient(180deg,#1f2937,#0b1220);border:1px solid rgba(255,255,255,.08);color:#e5e7eb;border-radius:12px;padding:8px 12px;} .timeline-root .btn:hover{border-color:rgba(255,255,255,.14);} .timeline-root .btn-primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border:1px solid rgba(59,130,246,.3);color:white;box-shadow:0 12px 24px rgba(37,99,235,.35),inset 0 1px 0 rgba(255,255,255,.2);} .timeline-root .kbd{background:#0b1220;border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:8px;font-size:11px;color:#cbd5e1;}`;
    document.head.appendChild(style);
    timelineStylesInjected = true;
}

function createBudgetTimeline(root, options) {
    if (!root) return null;
    ensureBudgetTimelineStyles();
    root.classList.add('timeline-root');
    root.innerHTML = `
        <div class="min-h-full p-4 sm:p-6">
            <div class="max-w-7xl mx-auto space-y-4">
                <div class="flex items-center justify-between">
                    <div class="space-y-1">
                        <h1 class="text-2xl sm:text-3xl font-semibold text-gray-100 tracking-tight">Modular Budget Timeline</h1>
                        <p class="text-gray-400">Visualize income, allocations, and spend across the month. Pan, zoom, and inspect trends.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn hidden md:inline-flex items-center gap-2" id="btnResetView" type="button">
                            Reset View <span class="kbd">R</span>
                        </button>
                        <button class="btn-primary inline-flex items-center gap-2" id="btnExport" type="button">
                            Export Snapshot
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="kpi">
                        <div class="text-xs text-gray-400">Month Inflow</div>
                        <div class="text-lg font-semibold text-gray-100" id="lblInflow">$0</div>
                    </div>
                    <div class="kpi">
                        <div class="text-xs text-gray-400">Budgeted</div>
                        <div class="text-lg font-semibold text-gray-100" id="lblBudgeted">$0</div>
                    </div>
                    <div class="kpi">
                        <div class="text-xs text-gray-400">Unallocated</div>
                        <div class="text-lg font-semibold text-gray-100" id="lblUnallocated">$0</div>
                    </div>
                </div>
                <div class="panel rounded-2xl p-3 sm:p-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div class="legend">
                            <span><span class="legend-dot" style="background:#60a5fa"></span>Budget</span>
                            <span><span class="legend-dot" style="background:#34d399"></span>Spent</span>
                            <span><span class="legend-dot" style="background:#f59e0b"></span>Upcoming</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="mini-badge">Pan: <span class="kbd">Drag</span></div>
                            <div class="mini-badge">Zoom: <span class="kbd">Ctrl + Wheel</span></div>
                            <div class="mini-badge">Reset: <span class="kbd">R</span></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <input id="daySlider" class="slider" type="range" min="1" max="31" step="1" value="1" aria-label="Select day in period" />
                        <div class="flex justify-between text-[12px] text-gray-500 mt-1">
                            <span data-role="slider-start">Day 1</span><span data-role="slider-end">Day 31</span>
                        </div>
                    </div>
                </div>
                <div class="panel rounded-2xl p-3 sm:p-4 grid-bg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="chip px-2 py-1 rounded-lg text-sm">Overview</div>
                        <div class="text-sm text-gray-400" id="lblPeriod" aria-live="polite">&nbsp;</div>
                    </div>
                    <div class="relative">
                        <canvas id="timelineCanvas" class="w-full rounded-xl" height="520"></canvas>
                        <div id="hoverTip" class="hidden absolute text-xs bg-gray-800/95 border border-white/10 px-2 py-1 rounded-md pointer-events-none"></div>
                    </div>
                    <div class="mt-3 overflow-auto max-h-56 scroll-shadow">
                        <div id="categoryList" class="space-y-3"></div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-500">
                    Prototype timeline module. Replace simulated data with live app store before production.
                </div>
            </div>
        </div>
    `;

    const slider = root.querySelector('#daySlider');
    const sliderStartLabel = root.querySelector('[data-role="slider-start"]');
    const sliderEndLabel = root.querySelector('[data-role="slider-end"]');
    const inflowLabel = root.querySelector('#lblInflow');
    const budgetedLabel = root.querySelector('#lblBudgeted');
    const unallocatedLabel = root.querySelector('#lblUnallocated');
    const periodLabel = root.querySelector('#lblPeriod');
    const canvas = root.querySelector('#timelineCanvas');
    const categoryList = root.querySelector('#categoryList');
    const resetButton = root.querySelector('#btnResetView');

    let state = options?.initialSnapshot || null;
    let frameRef = null;
    let resizeObserver = null;
    let localSelectedIndex = null;
    let localSelectedDate = null;

    function getSelectedIndex() {
        if (!state) return 0;
        if (localSelectedIndex !== null) return localSelectedIndex;
        return state.period.selectedIndex || 0;
    }

    function getSelectedDate() {
        if (!state) return new Date();
        if (localSelectedDate) return localSelectedDate;
        return state.period.selectedDate;
    }

    function renderSlider() {
        if (!state || !slider) return;
        const limitIndex = differenceInDays(state.period.start, state.period.limit);
        const maxValue = Math.max(0, limitIndex) + 1;
        slider.max = String(maxValue);
        slider.min = '1';
        const nextValue = Math.min(maxValue, getSelectedIndex() + 1);
        slider.value = String(nextValue);
        slider.disabled = maxValue <= 1;
        if (sliderStartLabel) sliderStartLabel.textContent = 'Day 1';
        if (sliderEndLabel) sliderEndLabel.textContent = `Day ${maxValue}`;
    }

    function renderKpis() {
        if (!state) return;
        inflowLabel.textContent = formatCurrency(state.inflow);
        budgetedLabel.textContent = formatCurrency(state.budgeted);
        unallocatedLabel.textContent = formatCurrency(state.unallocated);
    }

    function renderMeta() {
        if (!state) return;
        const periodTitle = formatMonthTitle(state.period.start);
        const label = `${periodTitle} â€¢ Day ${getSelectedIndex() + 1}`;
        periodLabel.textContent = label;
        periodLabel.setAttribute('data-selected-date', getSelectedDate().toISOString());
    }

    function renderCategoryList() {
        if (!state || !categoryList) return;
        if (!state.categories.length) {
            categoryList.innerHTML = '<p class="text-sm text-gray-400">No categories yet. Create one to begin tracking.</p>';
            categoryList.removeAttribute('data-selected-day');
            return;
        }
        const day = getSelectedIndex() + 1;
        const focusId = state.focusCategoryId;
        categoryList.innerHTML = state.categories
            .map((category) => {
                const pct = category.budget > 0 ? Math.min(100, Math.round((category.spentToSelected / category.budget) * 100)) : 0;
                const focused = category.id === focusId ? 'true' : 'false';
                return `
                    <div class="flex items-center gap-3" data-category-id="${category.id}" data-role="category-row" data-focused="${focused}">
                        <div class="min-w-[140px] text-sm text-gray-300">${category.name}</div>
                        <div class="flex-1 bar">
                            <div class="bar-fill" style="width:${pct}%; background: linear-gradient(90deg, ${category.color}, rgba(255,255,255,.35));"></div>
                        </div>
                        <div class="text-xs text-gray-400 min-w-[160px] text-right">${formatCurrency(category.spentToSelected)} / ${formatCurrency(category.budget)} (${pct}%)</div>
                    </div>
                `;
            })
            .join('');
        categoryList.setAttribute('data-selected-day', String(day));
    }

    function drawCanvas() {
        if (!state || !canvas) return;
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const width = canvas.clientWidth;
        const barHeight = 18;
        const barGap = 18;
        const topPad = 48;
        const bottomPad = 96;
        const height = Math.max(320, topPad + state.categories.length * (barHeight + barGap) + bottomPad);
        if (canvas.height !== Math.floor(height * dpr)) {
            canvas.height = Math.floor(height * dpr);
        }
        if (canvas.width !== Math.floor(width * dpr)) {
            canvas.width = Math.floor(width * dpr);
        }
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, width, height);

        const leftPad = 92;
        const rightPad = 24;
        const usableWidth = Math.max(120, width - leftPad - rightPad);
        const dayCount = Math.max(1, state.period.dayCount);
        const limitIndex = differenceInDays(state.period.start, state.period.limit);
        const dayWidth = usableWidth / Math.max(1, dayCount - 1);
        const selectedIndex = Math.min(limitIndex, getSelectedIndex());
        const maxValue = Math.max(1, ...state.categories.map((category) => Math.max(category.budget || 0, category.totalSpent || 0)));
        const pxPerValue = usableWidth / maxValue;

        ctx.fillStyle = 'rgba(255,255,255,.02)';
        for (let x = 0; x < usableWidth; x += 24) {
            ctx.fillRect(leftPad + x, topPad - 24, 1, height - topPad - bottomPad + 48);
        }

        ctx.fillStyle = '#6b7280';
        ctx.font = '12px ui-sans-serif, system-ui';
        ctx.textBaseline = 'middle';
        for (let i = 0; i <= limitIndex; i++) {
            const x = leftPad + i * dayWidth;
            if (i % 2 === 1) {
                ctx.fillStyle = 'rgba(255,255,255,.05)';
                ctx.fillRect(x, topPad - 16, 1, height - topPad - bottomPad + 32);
                ctx.fillStyle = '#6b7280';
            }
            if (i % 5 === 0) {
                ctx.fillText(`Day ${i + 1}`, x, height - bottomPad + 56);
            }
        }

        ctx.textBaseline = 'alphabetic';
        state.categories.forEach((category, index) => {
            const baseY = topPad + index * (barHeight + barGap);
            const budgetWidth = Math.min(usableWidth, (category.budget || 0) * pxPerValue);
            const spentWidth = Math.min(usableWidth, (category.spentToSelected || 0) * pxPerValue);

            ctx.fillStyle = 'rgba(59,130,246,.35)';
            ctx.fillRect(leftPad, baseY, budgetWidth, barHeight);

            ctx.fillStyle = category.color || '#34d399';
            ctx.fillRect(leftPad, baseY, spentWidth, barHeight);

            ctx.fillStyle = '#d1d5db';
            ctx.font = '13px ui-sans-serif, system-ui';
            ctx.fillText(category.name, 12, baseY + barHeight - 4);

            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'right';
            ctx.fillText(`${formatCurrency(category.spentToSelected)} / ${formatCurrency(category.budget)}`, width - 36, baseY + barHeight - 4);
            ctx.textAlign = 'left';
        });

        const markerX = leftPad + Math.min(selectedIndex, limitIndex) * dayWidth;
        ctx.fillStyle = 'rgba(59,130,246,.7)';
        ctx.fillRect(markerX, topPad - 20, 2, height - topPad - bottomPad + 40);
    }

    function scheduleDraw() {
        if (frameRef) cancelAnimationFrame(frameRef);
        frameRef = requestAnimationFrame(() => drawCanvas());
    }

    function update(snapshot) {
        state = snapshot;
        localSelectedIndex = null;
        localSelectedDate = null;
        renderSlider();
        renderKpis();
        renderMeta();
        renderCategoryList();
        scheduleDraw();
    }

    function commitSelectedDate(index) {
        if (!state) return;
        const limitIndex = differenceInDays(state.period.start, state.period.limit);
        const clampedIndex = Math.min(limitIndex, Math.max(0, index));
        localSelectedIndex = clampedIndex;
        localSelectedDate = addDays(state.period.start, clampedIndex);
        renderMeta();
        scheduleDraw();
        options.onDayChange?.(localSelectedDate);
    }

    function handleSliderInput(event) {
        if (!state) return;
        const value = Number(event.target.value) || 1;
        commitSelectedDate(value - 1);
    }

    function handleReset() {
        if (!state) return;
        commitSelectedDate(differenceInDays(state.period.start, state.period.limit));
        if (slider) {
            slider.value = String(getSelectedIndex() + 1);
        }
    }

    function handleCategoryClick(event) {
        const row = event.target.closest('[data-role="category-row"]');
        if (!row || !state) return;
        const categoryId = row.dataset.categoryId;
        if (!categoryId) return;
        options.onCategoryFocus?.(categoryId);
        options.onNavigate?.('budget', categoryId);
    }

    function handleKeydown(event) {
        if (event.key?.toLowerCase() === 'r') {
            handleReset();
        }
    }

    slider?.addEventListener('input', handleSliderInput);
    resetButton?.addEventListener('click', handleReset);
    categoryList?.addEventListener('click', handleCategoryClick);
    window.addEventListener('keydown', handleKeydown);

    resizeObserver = new ResizeObserver(() => scheduleDraw());
    if (canvas) resizeObserver.observe(canvas);

    if (state) {
        update(state);
    }

    return {
        update,
        destroy() {
            slider?.removeEventListener('input', handleSliderInput);
            resetButton?.removeEventListener('click', handleReset);
            categoryList?.removeEventListener('click', handleCategoryClick);
            window.removeEventListener('keydown', handleKeydown);
            if (resizeObserver) {
                resizeObserver.disconnect();
                resizeObserver = null;
            }
            if (frameRef) {
                cancelAnimationFrame(frameRef);
                frameRef = null;
            }
            root.classList.remove('timeline-root');
            root.innerHTML = '';
        }
    };
}


function ensureBudgetTimelineController(initialState) {
    const host = document.getElementById('budget-timeline-host');
    if (!host) return;
    if (!budgetTimelineController) {
        budgetTimelineController = createBudgetTimeline(host, {
            initialSnapshot: computeBudgetTimelineSnapshot(initialState),
            onDayChange: (date) => appStore.setTimelineSelectedDate(date),
            onPeriodChange: (start, end) => appStore.setTimelinePeriod(start, end),
            onCategoryFocus: (categoryId) => appStore.setTimelineFocusCategory(categoryId),
            onRequestCreateSubcategory: (categoryId) => openCreateSubcategoryModal({ type: 'timeline', parentId: categoryId }),
            onNavigate: (target, categoryId) => navigateFromTimeline(target, categoryId)
        });
    }
}

function handleTimelineKeydown(event) {
    if (!budgetTimelineOverlayOpen) return;
    if (event.key === 'Escape') {
        event.preventDefault();
        closeBudgetTimeline();
    }
}

function handleTimelineBackdrop(event) {
    if (event.target.id === 'budget-timeline-overlay') {
        closeBudgetTimeline();
    }
}

function openBudgetTimeline() {
    const overlay = document.getElementById('budget-timeline-overlay');
    const host = document.getElementById('budget-timeline-host');
    if (!overlay || !host) return;
    const state = appStore.getState();
    ensureBudgetTimelineController(state);
    budgetTimelineController?.update(computeBudgetTimelineSnapshot(state));
    overlay.classList.add('active');
    budgetTimelineOverlayOpen = true;
    renderBudgetOverviewEntry(state);
    budgetTimelineFocusReturn = document.activeElement;
    document.addEventListener('keydown', handleTimelineKeydown);
    overlay.addEventListener('click', handleTimelineBackdrop);
    const focusables = focusableElementsWithin(overlay);
    if (focusables.length) {
        focusables[0].focus();
    }
}

function closeBudgetTimeline() {
    const overlay = document.getElementById('budget-timeline-overlay');
    if (!overlay) return;
    overlay.classList.remove('active');
    budgetTimelineOverlayOpen = false;
    overlay.removeEventListener('click', handleTimelineBackdrop);
    document.removeEventListener('keydown', handleTimelineKeydown);
    renderBudgetOverviewEntry(appStore.getState());
    if (budgetTimelineFocusReturn && typeof budgetTimelineFocusReturn.focus === 'function') {
        budgetTimelineFocusReturn.focus();
    }
    budgetTimelineFocusReturn = null;
}

function setupTimelineFocusTrap() {
    const overlay = document.getElementById('budget-timeline-overlay');
    if (!overlay) return;
    const sentinels = overlay.querySelectorAll('.timeline-focus-sentinel');
    sentinels.forEach((sentinel, index) => {
        sentinel.addEventListener('focus', () => {
            if (!budgetTimelineOverlayOpen) return;
            const focusables = focusableElementsWithin(overlay);
            if (!focusables.length) return;
            if (index === 0) {
                focusables[focusables.length - 1].focus();
            } else {
                focusables[0].focus();
            }
        });
    });
}

function updateTransactionChips(transactionId, searchTerm) {
    const state = appStore.getState();
    const grid = document.querySelector(`[data-chip-grid][data-transaction-id="${transactionId}"]`);
    if (!grid) return;
    const txn = getActiveSource(state).transactions.find((item) => item.id === transactionId);
    grid.innerHTML = renderSubcategoryChipsMarkup(state, searchTerm || '', txn?.subCategoryId);
}

function openLinkModal(context) {
    linkModalContext = context;
    const modal = document.getElementById('link-subcategory-modal');
    if (!modal) return;
    const label = document.getElementById('link-context-label');
    if (label) {
        label.textContent = context.label || 'this item';
    }
    const searchInput = document.getElementById('subcategory-search');
    if (searchInput) {
        searchInput.value = '';
    }
    renderModalSubcategoryChips('');
    modal.classList.add('active');
}

function closeLinkModal() {
    const modal = document.getElementById('link-subcategory-modal');
    if (modal) {
        modal.classList.remove('active');
    }
    linkModalContext = null;
}

function renderModalSubcategoryChips(searchTerm) {
    const state = appStore.getState();
    const grid = document.getElementById('subcategory-chip-grid');
    if (!grid) return;
    grid.innerHTML = renderSubcategoryChipsMarkup(state, searchTerm, null);
}

function openCreateSubcategoryModal(context) {
    const modal = document.getElementById('create-subcategory-modal');
    if (!modal) return;
    pendingCreateContext = context;
    populateParentSelect();
    const parentSelect = document.getElementById('create-parent-select');
    if (parentSelect.disabled) {
        openCreateParentModal();
        return;
    }
    if (context?.parentId) {
        parentSelect.value = context.parentId;
    }
    document.getElementById('create-subcategory-name').value = '';
    const slider = document.getElementById('create-subcategory-budget');
    const numberInput = document.getElementById('create-subcategory-budget-input');
    slider.value = 25;
    numberInput.value = 25;
    document.getElementById('create-budget-display').textContent = formatCurrency(25);
    modal.classList.add('active');
}

function closeCreateSubcategoryModal() {
    document.getElementById('create-subcategory-modal')?.classList.remove('active');
    pendingCreateContext = null;
}

function openCreateParentModal() {
    const modal = document.getElementById('create-parent-modal');
    if (!modal) return;
    const input = document.getElementById('create-parent-name');
    if (input) {
        input.value = '';
    }
    modal.classList.add('active');
}

function closeCreateParentModal() {
    document.getElementById('create-parent-modal')?.classList.remove('active');
}

function populateParentSelect() {
    const select = document.getElementById('create-parent-select');
    if (!select) return;
    const state = appStore.getState();
    if (!state.categories.length) {
        select.innerHTML = '<option value="">No parent categories yet</option>';
        select.disabled = true;
        return;
    }
    select.disabled = false;
    select.innerHTML = state.categories.map((parent) => `<option value="${parent.id}">${parent.name}</option>`).join('');
}

function handleCreateSubcategory(event) {
    event.preventDefault();
    const parentId = document.getElementById('create-parent-select').value;
    const name = document.getElementById('create-subcategory-name').value.trim();
    const budgetSlider = document.getElementById('create-subcategory-budget');
    const budgetInput = document.getElementById('create-subcategory-budget-input');
    const budgetAmount = Number(budgetInput.value || budgetSlider.value || 0);
    if (!parentId || !name || budgetAmount < 0) return;
    const created = appStore.createSubCategory(parentId, name, budgetAmount);
    if (created && pendingCreateContext) {
        if (pendingCreateContext.type === 'transaction') {
            appStore.assignTransactionToSubCategory(pendingCreateContext.id, created.id);
        } else if (pendingCreateContext.type === 'map') {
            const place = latestResults.find((item) => item.id === pendingCreateContext.id);
            if (place) {
                appStore.linkPlaceToSubCategory(place, created.id);
            }
        }
    }
    closeCreateSubcategoryModal();
}

function handleCreateParent(event) {
    event.preventDefault();
    const name = document.getElementById('create-parent-name').value.trim();
    if (!name) return;
    appStore.createParentCategory(name);
    closeCreateParentModal();
    populateParentSelect();
}

function handleLinkChipClick(subCategoryId) {
    if (!linkModalContext) return;
    if (linkModalContext.type === 'map') {
        const place = latestResults.find((item) => item.id === linkModalContext.id);
        if (place) {
            appStore.linkPlaceToSubCategory(place, subCategoryId);
        }
    } else if (linkModalContext.type === 'transaction') {
        appStore.assignTransactionToSubCategory(linkModalContext.id, subCategoryId);
    }
    closeLinkModal();
}

function handleTransactionChipClick(transactionId, subCategoryId) {
    appStore.assignTransactionToSubCategory(transactionId, subCategoryId);
}

function openSubcategoryPickerForTransaction(transactionId) {
    const txn = getActiveSource(appStore.getState()).transactions.find((item) => item.id === transactionId);
    openLinkModal({ type: 'transaction', id: transactionId, label: txn ? txn.merchant : 'transaction' });
}

function openSubcategoryPickerForPlace(placeId) {
    const place = latestResults.find((item) => item.id === placeId);
    if (!place) return;
    openLinkModal({ type: 'map', id: placeId, label: place.name });
}

function updateTransactionsAfterStateChange(state) {
    renderTransactions(state);
    state.sources[state.dataSource].transactions.forEach((txn) => {
        if (!openTransactionPanels.has(txn.id)) {
            transactionSearchTerms.delete(txn.id);
        }
    });
}

function simulatePlaidConnection() {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(generatePlaidData());
        }, 1000);
    });
}

function simulateDemoSeed() {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(generateDemoData(appStore.getState()));
        }, 600);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initializeMap();
    renderPoiButtons();

    const initialState = appStore.getState();
    populateParentSelect();
    renderBudgetView(initialState);
    renderBudgetOverviewEntry(initialState);
    renderAccounts(initialState);
    renderTransactions(initialState);

    const searchInput = document.getElementById('search-input');
    const mapCardContainer = document.getElementById('map-card-container');
    syncSearchUiVisibility();

    appStore.subscribe((state) => {
        populateParentSelect();
        renderBudgetView(state);
        renderBudgetOverviewEntry(state);
        renderAccounts(state);
        updateTransactionsAfterStateChange(state);
        refreshResults();
        renderActiveMapCard();
        if (budgetTimelineController && budgetTimelineOverlayOpen) {
            budgetTimelineController.update(computeBudgetTimelineSnapshot(state));
        }
    });

    if (searchInput) {
        searchInput.addEventListener('focus', () => {
            setPoiButtonsVisibility(true);
            setSearchDropdownVisibility(true);
        });
        searchInput.addEventListener('blur', () => {
            setSearchDropdownVisibility(false);
        });
        searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                setSearchDropdownVisibility(false);
                searchInput.blur();
            }
        });
        searchInput.addEventListener('input', (event) => {
            if (!(event.target.value || '').trim()) {
                setPoiButtonsVisibility(true);
                setSearchDropdownVisibility(true);
            }
        });
    }

    document.getElementById('search-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const query = (searchInput ? searchInput.value : '').trim();
        runSearch(query || activePoiType);
    });

    document.getElementById('poi-type-strip').addEventListener('click', (event) => {
        const button = event.target.closest('.poi-button');
        if (!button) return;
        const type = button.dataset.poiType;
        if (activePoiType === type) {
            activePoiType = '';
            document.querySelectorAll('.poi-button').forEach((btn) => btn.classList.remove('active'));
            setPoiButtonsVisibility(true);
            setSearchDropdownVisibility(true);
            runSearch(searchInput ? searchInput.value.trim() : '');
            return;
        }
        activePoiType = type;
        document.querySelectorAll('.poi-button').forEach((btn) => btn.classList.remove('active'));
        button.classList.add('active');
        hideSearchControlsAfterSelection();
        runSearch(searchInput ? searchInput.value.trim() : '');
    });

    document.getElementById('search-results').addEventListener('click', (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (actionButton) {
            const placeId = actionButton.dataset.placeId;
            if (actionButton.dataset.action === 'map-link') {
                openSubcategoryPickerForPlace(placeId);
            } else if (actionButton.dataset.action === 'map-create') {
                openCreateSubcategoryModal({ type: 'map', id: placeId });
            }
            hideSearchControlsAfterSelection();
            return;
        }
        const card = event.target.closest('.search-result-card');
        if (card) {
            handlePlaceSelection(card.dataset.placeId);
        }
    });

    if (mapCardContainer) {
        mapCardContainer.addEventListener('click', (event) => {
            const control = event.target.closest('[data-action]');
            if (!control) return;
            const placeId = control.dataset.placeId || activeMapPlaceId;
            if (control.dataset.action === 'close-map-card') {
                closeMapCard();
            } else if (control.dataset.action === 'card-link') {
                if (placeId) {
                    openSubcategoryPickerForPlace(placeId);
                    hideSearchControlsAfterSelection();
                }
            } else if (control.dataset.action === 'card-create') {
                if (placeId) {
                    openCreateSubcategoryModal({ type: 'map', id: placeId });
                    hideSearchControlsAfterSelection();
                }
            }
        });
    }

    document.getElementById('link-create-subcategory').addEventListener('click', () => {
        if (!linkModalContext) return;
        openCreateSubcategoryModal({ type: linkModalContext.type, id: linkModalContext.id });
    });

    document.getElementById('link-subcategory-modal').addEventListener('click', (event) => {
        const chip = event.target.closest('.subcategory-chip');
        if (chip) {
            handleLinkChipClick(chip.dataset.subcategoryId);
            return;
        }
        if (event.target.matches('[data-action="cancel-link"]')) {
            closeLinkModal();
        }
    });

    document.getElementById('subcategory-search').addEventListener('input', (event) => {
        renderModalSubcategoryChips(event.target.value);
    });

    document.getElementById('create-subcategory-form').addEventListener('submit', handleCreateSubcategory);
    document.getElementById('create-parent-form').addEventListener('submit', handleCreateParent);

    document.querySelector('[data-action="cancel-create-subcategory"]').addEventListener('click', () => {
        closeCreateSubcategoryModal();
    });
    document.querySelector('[data-action="cancel-create-parent"]').addEventListener('click', () => {
        closeCreateParentModal();
    });

    document.getElementById('create-parent-btn').addEventListener('click', () => {
        openCreateParentModal();
    });

    document.getElementById('create-subcategory-budget').addEventListener('input', (event) => {
        const value = Number(event.target.value || 0);
        document.getElementById('create-budget-display').textContent = formatCurrency(value);
        document.getElementById('create-subcategory-budget-input').value = value;
    });

    document.getElementById('create-subcategory-budget-input').addEventListener('input', (event) => {
        const value = Math.max(0, Number(event.target.value || 0));
        document.getElementById('create-subcategory-budget').value = value;
        document.getElementById('create-budget-display').textContent = formatCurrency(value);
    });

    document.getElementById('budget-list').addEventListener('click', (event) => {
        const toggleButton = event.target.closest('.collapse-toggle');
        if (toggleButton) {
            appStore.toggleCategoryCollapse(toggleButton.dataset.categoryId);
            return;
        }
        const button = event.target.closest('.add-subcategory-btn');
        if (!button) return;
        openCreateSubcategoryModal({ type: 'budget', parentId: button.dataset.parentId });
    });

    document.getElementById('transactions-list').addEventListener('click', (event) => {
        const transactionRow = event.target.closest('.transaction-row');
        if (!transactionRow) return;
        const transactionId = transactionRow.dataset.transactionId;
        if (event.target.matches('.transaction-toggle')) {
            const panel = transactionRow.querySelector('.transaction-panel');
            const isHidden = panel.classList.contains('hidden');
            panel.classList.toggle('hidden', !isHidden);
            if (isHidden) {
                openTransactionPanels.add(transactionId);
            } else {
                openTransactionPanels.delete(transactionId);
            }
        }
        const chip = event.target.closest('.subcategory-chip');
        if (chip) {
            handleTransactionChipClick(transactionId, chip.dataset.subcategoryId);
        }
        const createButton = event.target.closest('[data-action="create-subcategory"]');
        if (createButton) {
            openCreateSubcategoryModal({ type: 'transaction', id: transactionId });
        }
    });

    document.getElementById('transactions-list').addEventListener('input', (event) => {
        const search = event.target.closest('.subcategory-search');
        if (!search) return;
        const transactionId = search.dataset.transactionId;
        transactionSearchTerms.set(transactionId, search.value);
        updateTransactionChips(transactionId, search.value);
    });

    document.getElementById('demo-data-btn').addEventListener('click', async (event) => {
        if (appStore.getState().plaidConnected) return;
        const button = event.currentTarget;
        button.textContent = 'Loading demo dataâ€¦';
        button.classList.add('pointer-events-none', 'text-slate-400');
        const data = await simulateDemoSeed();
        appStore.seedDemoData(() => data);
    });

    document.getElementById('reset-demo-btn').addEventListener('click', async (event) => {
        if (appStore.getState().plaidConnected) return;
        const button = event.currentTarget;
        button.textContent = 'Refreshing demo dataâ€¦';
        button.classList.add('pointer-events-none', 'text-slate-400');
        const data = await simulateDemoSeed();
        appStore.seedDemoData(() => data);
        button.textContent = 'Reset Demo Data';
        button.classList.remove('pointer-events-none', 'text-slate-400');
    });

    document.getElementById('connect-plaid-btn').addEventListener('click', async (event) => {
        if (appStore.getState().plaidConnected) return;
        const button = event.currentTarget;
        button.textContent = 'Launching Plaidâ€¦';
        button.disabled = true;
        await openPlaidLink(button);
    });

    document.getElementById('disconnect-plaid').addEventListener('click', () => {
        appStore.disconnectPlaid();
        showPlaidFeedback('Disconnected from Plaid. Using demo data.', false);
    });

    document.getElementById('accounts-list').addEventListener('click', (event) => {
        const accountBtn = event.target.closest('[data-account-id]');
        if (!accountBtn) return;
        const accountId = accountBtn.dataset.accountId;
        const state = appStore.getState();
        if (state.activeAccountId === accountId) {
            appStore.clearAccountFilter();
        } else {
            appStore.setAccountFilter(accountId);
        }
    });

    document.getElementById('clear-account-filter').addEventListener('click', () => {
        appStore.clearAccountFilter();
    });

    setupTimelineFocusTrap();
    ensureBudgetTimelineController(initialState);
    const overviewEntry = document.getElementById('budget-overview-entry');
    overviewEntry?.addEventListener('click', () => openBudgetTimeline());
    const minimizeButton = document.getElementById('budget-timeline-minimize');
    minimizeButton?.addEventListener('click', () => closeBudgetTimeline());

    document.querySelectorAll('.nav-btn').forEach((button) => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.nav-btn').forEach((btn) => btn.classList.remove('active', 'text-blue-600', 'bg-blue-50'));
            document.querySelectorAll('.nav-btn').forEach((btn) => btn.classList.add('text-slate-500', 'bg-slate-100'));
            button.classList.add('active', 'text-blue-600', 'bg-blue-50');
            button.classList.remove('text-slate-500', 'bg-slate-100');
            const target = button.dataset.view;
            document.querySelectorAll('.sidebar-view').forEach((view) => view.classList.remove('active'));
            document.getElementById(target).classList.add('active');
        });
    });

    document.querySelectorAll('[data-action="cancel-link"]').forEach((btn) => {
        btn.addEventListener('click', () => {
            closeLinkModal();
        });
    });
});

    </script>
</body>
</html>
