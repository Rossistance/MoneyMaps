<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Maps - Web</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            color-scheme: light;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            display: flex;
            height: 100vh;
        }
        #map-container {
            flex-grow: 1;
            position: relative;
            background-color: #0f172a;
        }
        #map {
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        #sidebar {
            width: 480px;
            flex-shrink: 0;
            background-color: #ffffff;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        #sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .sidebar-view {
            display: none;
        }
        .sidebar-view.active {
            display: block;
        }
        .nav-btn.active {
            background-color: #eef2ff;
            color: #3b82f6;
        }
        .nav-btn svg {
            margin-right: 0.35rem;
        }
        .gradient-pill {
            background-image: linear-gradient(135deg, rgba(59,130,246,1) 0%, rgba(14,165,233,1) 100%);
        }
        #sidebar-content::-webkit-scrollbar,
        .category-filters::-webkit-scrollbar,
        #autocomplete-results::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        #sidebar-content::-webkit-scrollbar-thumb,
        .category-filters::-webkit-scrollbar-thumb,
        #autocomplete-results::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .pin-shell {
            width: 40px;
            height: 40px;
            border-radius: 100% 100% 100% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.25);
            border: 2px solid rgba(255,255,255,0.8);
            background: linear-gradient(145deg, #10b981, #059669);
        }
        .pin-shell svg {
            transform: rotate(45deg);
        }
        .pin-shell[data-status="categorized"] {
            background: linear-gradient(145deg, #3b82f6, #1d4ed8);
        }
        .pin-shell[data-status="parent-housing"] {
            background: linear-gradient(145deg, #6366f1, #4f46e5);
        }
        .pin-shell[data-status="parent-lifestyle"] {
            background: linear-gradient(145deg, #ec4899, #db2777);
        }
        .pin-shell[data-status="parent-transport"] {
            background: linear-gradient(145deg, #10b981, #059669);
        }
        .pin-shell[data-status="parent-health"] {
            background: linear-gradient(145deg, #06b6d4, #0e7490);
        }
        .pin-shell[data-status="parent-savings"] {
            background: linear-gradient(145deg, #f59e0b, #d97706);
        }
        .pin-shell[data-status="parent-income"] {
            background: linear-gradient(145deg, #16a34a, #15803d);
        }
        .pin-shell[data-status="uncategorized"] {
            background: linear-gradient(145deg, #22c55e, #15803d);
        }
        .timeline-wrapper {
            position: relative;
            width: 100%;
            min-height: 260px;
            border-radius: 1.25rem;
            overflow: hidden;
            background: #0f172a;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        }
        .timeline-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        .budget-bar {
            position: relative;
            height: 42px;
            border-radius: 12px;
            background: #e2e8f0;
            overflow: hidden;
        }
        .budget-bar span {
            position: absolute;
            inset: 0;
            display: block;
        }
        .budget-bar .budget-target {
            background-image: linear-gradient(90deg, rgba(226,232,240,0.8), rgba(148,163,184,0.4));
        }
        .budget-bar .budget-spent {
            mix-blend-mode: multiply;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(4px);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .mobile-hidden { display: block; }
        .desktop-hidden { display: none; }
        @media (max-width: 1024px) {
            body, html {
                overflow: auto;
            }
            .main-container {
                flex-direction: column;
            }
            #map-container {
                order: -1;
                height: 45vh;
            }
            #sidebar {
                width: 100%;
                height: auto;
                box-shadow: none;
            }
            #sidebar-content {
                height: auto;
            }
            .mobile-hidden { display: none; }
            .desktop-hidden { display: block; }
        }
    </style>
</head>
<body>
<div id="app-root" class="main-container">
    <div id="map-container">
        <div id="map"></div>
        <div class="absolute top-0 left-0 right-0 p-4 z-20 space-y-2">
            <div class="max-w-xl mx-auto">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search place or address..." class="w-full pl-11 pr-4 py-3 bg-white rounded-2xl shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                    <div class="absolute top-1/2 left-3 -translate-y-1/2 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div id="autocomplete-results" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl z-30 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
                </div>
                <div id="place-type-filters" class="category-filters flex items-center space-x-2 overflow-x-auto p-2 bg-white/90 backdrop-blur rounded-xl mt-2 shadow-md"></div>
            </div>
        </div>
        <div id="map-loader" class="absolute inset-0 bg-white/60 z-30 items-center justify-center hidden"><div class="loader border-4 border-slate-200 border-t-blue-500 rounded-full w-10 h-10 animate-spin"></div></div>
    </div>
    <aside id="sidebar">
        <div class="p-4 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-slate-900">Money Maps</h1>
                <span id="view-toggle-label" class="text-xs text-slate-500 desktop-hidden">Mobile View</span>
            </div>
        </div>
        <nav id="sidebar-nav" class="grid grid-cols-3 gap-2 p-2 border-b bg-slate-50">
            <button class="nav-btn active flex items-center justify-center p-2 rounded-xl font-semibold text-sm" data-view="budget-view">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"></line><line x1="18" x2="18" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="16"></line></svg>
                Budget
            </button>
            <button class="nav-btn flex items-center justify-center p-2 rounded-xl font-semibold text-sm text-slate-600" data-view="accounts-view">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10l9-7 9 7"></path><path d="M9 21V9h6v12"></path></svg>
                Accounts
            </button>
            <button class="nav-btn flex items-center justify-center p-2 rounded-xl font-semibold text-sm text-slate-600" data-view="transactions-view">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                History
            </button>
        </nav>
        <div id="sidebar-content">
            <section id="budget-view" class="sidebar-view active p-4 space-y-6">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span>Fund flows</span>
                        <button class="add-parent-btn text-blue-500 hover:text-blue-600 transition" title="Add category" aria-label="Add category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </h2>
                    <div class="text-right">
                        <p class="text-xs text-slate-500">Remaining</p>
                        <p id="budget-remaining" class="text-lg font-bold text-emerald-600"></p>
                    </div>
                </div>
                <div id="budget-timeline" class="timeline-wrapper"></div>
                <div id="budget-category-list" class="space-y-4"></div>
                <h3 class="text-lg font-semibold text-slate-800 px-2">Pure savings</h3>
                <div id="savings-category-list" class="space-y-3"></div>
                <h3 class="text-lg font-semibold text-slate-800 px-2">Time targets</h3>
                <div id="goals-list" class="space-y-3 pb-6"></div>
            </section>
            <section id="accounts-view" class="sidebar-view p-4 space-y-6">
                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                    <h2 class="text-lg font-semibold text-slate-800">Accounts Overview</h2>
                    <p class="text-sm text-slate-500">Balances and remaining budgets</p>
                </div>
                <div id="accounts-summary" class="space-y-3"></div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide mb-2">Places &amp; Remaining budgets</h3>
                    <div id="accounts-places" class="space-y-3"></div>
                </div>
            </section>
            <section id="transactions-view" class="sidebar-view p-4 space-y-4">
                <div class="bg-white border border-slate-200 rounded-2xl p-4 sticky top-0 z-10">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wide">Assets</p>
                            <p id="assets-display" class="text-2xl font-bold text-emerald-600"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase tracking-wide">Total spent</p>
                            <p id="total-spent" class="text-2xl font-bold text-rose-600"></p>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="demo-data-btn" class="flex-1 bg-slate-900 text-white py-2.5 rounded-xl text-sm font-semibold shadow-sm hover:bg-slate-800 transition">Use demo data</button>
                        <button id="plaid-link-btn" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl text-sm font-semibold shadow-sm hover:bg-blue-500 transition">Link bank (Plaid)</button>
                    </div>
                </div>
                <div id="transactions-list" class="space-y-3 pb-10"></div>
            </section>
            <section id="place-detail-view" class="sidebar-view p-4 space-y-4"></section>
        </div>
    </aside>
</div>

<div id="category-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="category-modal-title">
    <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
            <div>
                <h2 id="category-modal-title" class="text-xl font-semibold">Create budget category</h2>
                <p id="category-modal-subtitle" class="text-sm text-slate-300">Organize funds into flexible buckets.</p>
            </div>
            <button class="close-category-modal text-white/70 hover:text-white" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="px-6 py-6 space-y-5">
            <div>
                <label for="category-name" class="block text-sm font-medium text-slate-600">Category name</label>
                <input id="category-name" type="text" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Dining Out">
            </div>
            <div>
                <label for="category-parent" class="block text-sm font-medium text-slate-600">Parent category</label>
                <select id="category-parent" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="category-budget" class="block text-sm font-medium text-slate-600">Budgeted amount</label>
                    <input id="category-budget" type="number" min="0" step="0.01" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="250">
                </div>
                <div>
                    <label for="category-icon" class="block text-sm font-medium text-slate-600">Icon (optional)</label>
                    <input id="category-icon" type="text" maxlength="1" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="🍽️">
                </div>
            </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 flex items-center justify-end gap-3 border-t border-slate-200">
            <button class="close-category-modal px-4 py-2 rounded-xl text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
            <button id="category-modal-save" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-500 transition">Save</button>
        </div>
    </div>
</div>

<div id="categorize-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="categorize-modal-title">
    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
            <h2 id="categorize-modal-title" class="text-xl font-semibold">Categorize transaction</h2>
            <button class="close-categorize-modal text-white/80 hover:text-white" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="px-6 py-6 space-y-5">
            <p id="categorize-modal-transaction" class="text-slate-700 font-semibold"></p>
            <div>
                <label for="categorize-select" class="block text-sm font-medium text-slate-600">Assign to sub-category</label>
                <select id="categorize-select" class="mt-1 w-full border border-slate-200 rounded-xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <button id="categorize-new-sub" class="w-full px-4 py-2.5 rounded-xl border border-dashed border-blue-400 text-blue-600 font-medium hover:bg-blue-50">Create new sub-category</button>
        </div>
        <div class="px-6 py-4 bg-slate-50 flex items-center justify-end gap-3 border-t border-slate-200">
            <button class="close-categorize-modal px-4 py-2 rounded-xl text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
            <button id="categorize-save" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-500 transition">Save</button>
        </div>
    </div>
</div>

<script>
const HERE_API_KEY = 'YOUR_HERE_API_KEY';

const tailwindPalette = {
    "indigo": ['#6366f1', '#4338ca'],
    "sky": ['#38bdf8', '#0ea5e9'],
    "pink": ['#ec4899', '#db2777'],
    "emerald": ['#10b981', '#059669'],
    "amber": ['#f59e0b', '#d97706'],
    "cyan": ['#06b6d4', '#0e7490'],
    "rose": ['#f43f5e', '#e11d48'],
    "purple": ['#a855f7', '#7c3aed'],
    "slate": ['#64748b', '#475569']
};

const placeTypeConfig = [
    { id: 'restaurant', label: 'Restaurants', here: '100-1000', icon: 'M4 9l8-7 8 7v11a2 2 0 0 1-2 2h-4', parentHint: 'lifestyle' },
    { id: 'grocery', label: 'Groceries', here: '100-1011-0052,700-7000-0000', icon: 'M3 9h18l-1 11H4L3 9z M7 9V4h10v5', parentHint: 'living' },
    { id: 'electronics', label: 'Electronics', here: '600-6000-0000', icon: 'M7 4h10a2 2 0 0 1 2 2v10H5V6a2 2 0 0 1 2-2z M2 18h20', parentHint: 'lifestyle' },
    { id: 'transport', label: 'Transit', here: '400-4000-0000', icon: 'M5 16l1 1 1 4h10l1-4 1-1', parentHint: 'transport' },
    { id: 'health', label: 'Healthcare', here: '500-5000-0000', icon: 'M12 5v14 M5 12h14', parentHint: 'health' },
    { id: 'leisure', label: 'Leisure', here: '300-3000-0000', icon: 'M21 10l-9-7-9 7v11h18z', parentHint: 'lifestyle' },
    { id: 'fitness', label: 'Fitness', here: '800-8000-0165', icon: 'M4 6h16M4 10h16M10 14h4', parentHint: 'health' }
];

const appState = {
    viewMode: 'desktop',
    budgets: {
        parents: {
            'living': {
                id: 'living',
                name: 'Living essentials',
                gradient: 'from-sky-500 to-sky-600',
                colorKey: 'sky',
                icon: 'home',
                children: {
                    'living-rent': { id: 'living-rent', name: 'Rent', icon: 'home', budget: 1750, type: 'expense' },
                    'living-groceries': { id: 'living-groceries', name: 'Groceries', icon: 'basket', budget: 450, type: 'expense' },
                    'living-utilities': { id: 'living-utilities', name: 'Utilities', icon: 'bolt', budget: 220, type: 'expense' }
                }
            },
            'lifestyle': {
                id: 'lifestyle',
                name: 'Lifestyle',
                gradient: 'from-pink-500 to-rose-500',
                colorKey: 'pink',
                icon: 'sparkles',
                children: {
                    'lifestyle-dining-out': { id: 'lifestyle-dining-out', name: 'Dining out', icon: 'utensils', budget: 240, type: 'expense' },
                    'lifestyle-entertainment': { id: 'lifestyle-entertainment', name: 'Entertainment', icon: 'ticket', budget: 160, type: 'expense' },
                    'lifestyle-shopping': { id: 'lifestyle-shopping', name: 'Shopping', icon: 'shopping-bag', budget: 200, type: 'expense' }
                }
            },
            'transport': {
                id: 'transport',
                name: 'Transportation',
                gradient: 'from-emerald-500 to-emerald-600',
                colorKey: 'emerald',
                icon: 'car',
                children: {
                    'transport-gas': { id: 'transport-gas', name: 'Fuel & charging', icon: 'gas', budget: 180, type: 'expense' },
                    'transport-rideshare': { id: 'transport-rideshare', name: 'Rideshare', icon: 'taxi', budget: 90, type: 'expense' }
                }
            },
            'health': {
                id: 'health',
                name: 'Health & wellness',
                gradient: 'from-cyan-500 to-indigo-500',
                colorKey: 'cyan',
                icon: 'heart',
                children: {
                    'health-healthcare': { id: 'health-healthcare', name: 'Healthcare', icon: 'cross', budget: 130, type: 'expense' },
                    'health-fitness': { id: 'health-fitness', name: 'Fitness', icon: 'dumbbell', budget: 95, type: 'expense' }
                }
            },
            'savings': {
                id: 'savings',
                name: 'Pure savings',
                gradient: 'from-amber-400 to-amber-500',
                colorKey: 'amber',
                icon: 'piggy-bank',
                children: {
                    'savings-emergency': { id: 'savings-emergency', name: 'Emergency fund', icon: 'lifebuoy', budget: 400, type: 'savings' },
                    'savings-vacation': { id: 'savings-vacation', name: 'Vacation', icon: 'plane', budget: 150, type: 'savings' }
                }
            }
        },
        goals: {
            'debt-free': { id: 'debt-free', name: 'Debt free', current: 2400, target: 5000, colorKey: 'purple' },
            'college': { id: 'college', name: '529 college', current: 890, target: 5000, colorKey: 'slate' }
        }
    },
    transactions: [],
    accounts: {
        byId: {
            'checking': { id: 'checking', name: 'TriStar Checking', institution: 'TriStar Bank', balance: 3624.12 },
            'savings': { id: 'savings', name: 'TriStar High Yield', institution: 'TriStar Bank', balance: 7250.40 },
            'cash': { id: 'cash', name: 'Cash wallet', institution: 'On hand', balance: 320.00 }
        }
    },
    map: {
        markers: [],
        activeType: 'all',
        cachedPlaces: {},
        selectedPlace: null
    },
    plaid: {
        connected: false
    }
};

const eventBus = new EventTarget();

function emit(eventName, detail) {
    eventBus.dispatchEvent(new CustomEvent(eventName, { detail }));
}

function on(eventName, handler) {
    eventBus.addEventListener(eventName, handler);
}

function withSubCategories(cb) {
    const parents = appState.budgets.parents;
    return Object.values(parents).flatMap(parent => Object.values(parent.children).map(child => cb(child, parent)));
}

function computeBudgetSnapshots() {
    const snapshot = {};
    withSubCategories((child, parent) => {
        snapshot[child.id] = {
            sub: child,
            parent,
            budget: child.budget,
            spent: 0,
            remaining: child.budget,
            transactions: []
        };
    });

    appState.transactions.forEach(txn => {
        if (!txn.subCategoryId) return;
        const entry = snapshot[txn.subCategoryId];
        if (!entry) return;
        if (txn.type === 'debit') {
            entry.spent += txn.amount;
            entry.remaining = entry.budget - entry.spent;
        }
        entry.transactions.push(txn);
    });

    return snapshot;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function randomGradient(key) {
    const palette = tailwindPalette[key] || tailwindPalette['slate'];
    return `linear-gradient(120deg, ${palette[0]}, ${palette[1]})`;
}

let map;

function initMap() {
    const startPos = [35.0456, -85.3097];
    map = L.map('map', {
        center: startPos,
        zoom: 13,
        zoomControl: false,
        attributionControl: false
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);

    map.on('click', () => {
        switchSidebarView('budget-view');
        appState.map.selectedPlace = null;
        emit('place:selected', null);
    });
}

function createSvgIcon(path) {
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white">${path}</svg>`;
}

const pinTemplates = {
    restaurant: createSvgIcon('<path d="M4 21v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/><circle cx="12" cy="7" r="4"/>'),
    grocery: createSvgIcon('<path d="M3 4h18l-1 16H4L3 4z"/><line x1="7" y1="9" x2="7" y2="4"/><line x1="17" y1="9" x2="17" y2="4"/>'),
    electronics: createSvgIcon('<rect x="4" y="5" width="16" height="12" rx="2"/><line x1="2" y1="19" x2="22" y2="19"/>'),
    transport: createSvgIcon('<rect x="3" y="7" width="18" height="10" rx="2"/><path d="M6 17l-1 3h3"/><path d="M18 17l1 3h-3"/>'),
    health: createSvgIcon('<path d="M12 21s-6-4.35-6-8.5S8.5 4 12 7.5 18 4 18 12.5 12 21 12 21z"/>'),
    leisure: createSvgIcon('<path d="M20 21V8l-8-5-8 5v13"/><path d="M12 22V11"/><path d="M4 15h16"/>'),
    fitness: createSvgIcon('<path d="M5 16l-1 4"/><path d="M19 16l1 4"/><path d="M2 12h20"/><path d="M7 8v8"/><path d="M17 8v8"/>'),
    default: createSvgIcon('<path d="M21 10c0 6-9 13-9 13S3 16 3 10a9 9 0 1 1 18 0z"/><circle cx="12" cy="10" r="3"/>')
};
function clearMapMarkers() {
    appState.map.markers.forEach(({ marker }) => marker.remove());
    appState.map.markers = [];
}

function placeParentColor(place) {
    const parent = appState.budgets.parents[place.parentId || ''];
    if (!parent) return 'categorized';
    return `parent-${parent.id}`;
}

function renderPlaceMarkers(items, highlightNew = false) {
    clearMapMarkers();
    const snapshot = computeBudgetSnapshots();

    items.forEach(item => {
        if (!item.position) return;
        const place = {
            id: item.id,
            title: item.title || item.name,
            type: item.resultType || item.categories?.[0]?.name || 'Place',
            lat: item.position.lat,
            lng: item.position.lng,
            iconKey: item.iconKey || 'default',
            hereRaw: item,
            subCategoryId: item.subCategoryId || null,
            parentId: item.parentId || null,
            amountHint: 0,
            remainingHint: null,
            isDemo: highlightNew
        };

        if (place.subCategoryId && snapshot[place.subCategoryId]) {
            const entry = snapshot[place.subCategoryId];
            place.parentId = entry.parent.id;
            place.amountHint = entry.spent;
            place.remainingHint = entry.remaining;
        }

        const status = place.subCategoryId ? placeParentColor(place) : 'uncategorized';
        const iconHtml = pinTemplates[place.iconKey] || pinTemplates.default;
        const marker = L.marker([place.lat, place.lng], {
            icon: L.divIcon({
                html: `<div class="pin-shell" data-status="${status}">${iconHtml}</div>`,
                className: '',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            })
        }).addTo(map);

        marker.on('click', () => {
            appState.map.selectedPlace = place;
            emit('place:selected', place);
            switchSidebarView('place-detail-view');
        });

        appState.map.markers.push({ marker, place });
    });
}

async function fetchPlaces() {
    const query = document.getElementById('search-input').value.trim();
    const center = map.getCenter();
    const activeType = appState.map.activeType;
    const cacheKey = `${center.lat.toFixed(3)}_${center.lng.toFixed(3)}_${map.getZoom()}_${activeType}_${query}`;

    if (appState.map.cachedPlaces[cacheKey]) {
        renderPlaceMarkers(appState.map.cachedPlaces[cacheKey]);
        renderAccountsView();
        return;
    }

    if (HERE_API_KEY === 'YOUR_HERE_API_KEY') {
        console.warn('HERE API key missing, skipping live search.');
        return;
    }

    document.getElementById('map-loader').classList.remove('hidden');

    try {
        const bounds = map.getBounds();
        const radius = Math.round(center.distanceTo(bounds.getNorthEast()));
        let url;
        if (query) {
            url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(query)}&in=circle:${center.lat},${center.lng};r=${radius}&limit=80&apiKey=${HERE_API_KEY}`;
        } else if (activeType !== 'all') {
            const type = placeTypeConfig.find(t => t.id === activeType);
            url = `https://browse.search.hereapi.com/v1/browse?categories=${type?.here || ''}&in=circle:${center.lat},${center.lng};r=${radius}&limit=80&apiKey=${HERE_API_KEY}`;
        } else {
            document.getElementById('map-loader').classList.add('hidden');
            return;
        }
        const response = await fetch(url);
        const data = await response.json();
        const items = (data.items || []).map(item => {
            const iconKey = activeType !== 'all' ? activeType : detectPlaceType(item);
            return { ...item, iconKey };
        });
        appState.map.cachedPlaces[cacheKey] = items;
        renderPlaceMarkers(items, !query);
        renderAccountsView();
    } catch (err) {
        console.error('Place search failed', err);
    } finally {
        document.getElementById('map-loader').classList.add('hidden');
    }
}

function detectPlaceType(item) {
    const categories = item.categories || [];
    for (const type of placeTypeConfig) {
        if (type.here && categories.some(cat => type.here.split(',').includes(cat.id))) {
            return type.id;
        }
    }
    return 'default';
}

function renderBudgetView() {
    const snapshot = computeBudgetSnapshots();
    let totalRemaining = 0;
    const budgetList = document.getElementById('budget-category-list');
    const savingsList = document.getElementById('savings-category-list');
    budgetList.innerHTML = '';
    savingsList.innerHTML = '';

    Object.values(appState.budgets.parents).forEach(parent => {
        const isSavings = parent.id === 'savings';
        const container = isSavings ? savingsList : budgetList;
        const cards = Object.values(parent.children).map(child => {
            const entry = snapshot[child.id];
            const spent = entry?.spent || 0;
            const remaining = Math.max(0, child.budget - spent);
            const percent = child.budget ? Math.min(100, (spent / child.budget) * 100) : 0;
            const gradient = randomGradient(parent.colorKey);
            if (!isSavings) {
                totalRemaining += remaining;
            }
            return `
                <article class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-slate-900">${child.name}</p>
                            <p class="text-xs text-slate-500">${formatCurrency(spent)} spent of ${formatCurrency(child.budget)}</p>
                        </div>
                        <button class="add-sub-btn text-blue-500 hover:text-blue-600" data-parent="${parent.id}" data-sub="${child.id}" title="Add sub-category">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div class="budget-bar mt-4">
                        <span class="budget-target"></span>
                        <span class="budget-spent" style="width:${percent}% ; background:${gradient};"></span>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <p class="text-xs font-semibold text-white drop-shadow">${percent.toFixed(0)}%</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between text-xs font-medium">
                        <span class="text-slate-500">Remaining</span>
                        <span class="text-emerald-600">${formatCurrency(remaining)}</span>
                    </div>
                </article>
            `;
        }).join('');

        container.insertAdjacentHTML('beforeend', `
            <section class="space-y-3">
                <header class="flex items-center justify-between px-2">
                    <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                        <span>${parent.name}</span>
                    </h3>
                    <button class="add-parent-child text-blue-500 hover:text-blue-600" data-parent="${parent.id}" title="Add sub-category">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </header>
                <div class="space-y-3">${cards}</div>
            </section>
        `);
    });

    document.getElementById('budget-remaining').textContent = formatCurrency(totalRemaining);

    const goalsList = document.getElementById('goals-list');
    goalsList.innerHTML = Object.values(appState.budgets.goals).map(goal => {
        const percent = goal.target ? Math.min(100, (goal.current / goal.target) * 100) : 0;
        const gradient = randomGradient(goal.colorKey);
        return `
            <article class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                <div class="flex justify-between">
                    <p class="font-semibold text-slate-900">${goal.name}</p>
                    <span class="text-sm text-slate-500">${formatCurrency(goal.current)} / ${formatCurrency(goal.target)}</span>
                </div>
                <div class="budget-bar mt-3">
                    <span class="budget-target"></span>
                    <span class="budget-spent" style="width:${percent}% ; background:${gradient};"></span>
                </div>
            </article>
        `;
    }).join('');
}
let financialCanvas;
function initTimeline() {
    if (!financialCanvas) {
        financialCanvas = new FinancialCanvas('budget-timeline', buildTimelineData());
    } else {
        financialCanvas.updateData(buildTimelineData());
    }
}

function buildTimelineData() {
    const snapshot = computeBudgetSnapshots();
    const spendingData = withSubCategories((child, parent) => {
        if (child.type === 'savings') return null;
        const entry = snapshot[child.id];
        return {
            id: child.id,
            label: child.name,
            finalSpent: entry?.spent || 0,
            total: child.budget,
            color: tailwindPalette[parent.colorKey]?.[0] || '#3b82f6'
        };
    }).filter(Boolean);

    const savingsData = withSubCategories((child, parent) => {
        if (child.type !== 'savings') return null;
        const entry = snapshot[child.id];
        return {
            id: child.id,
            label: child.name,
            finalSaved: entry ? entry.budget - entry.spent : child.budget,
            total: child.budget,
            color: tailwindPalette[parent.colorKey]?.[0] || '#f59e0b'
        };
    }).filter(Boolean);

    const assumedIncome = 6200;
    return { spendingData, savingsData, assumedIncome };
}

class FinancialCanvas {
    constructor(containerId, data) {
        this.container = document.getElementById(containerId);
        this.canvas = document.createElement('canvas');
        this.container.appendChild(this.canvas);
        this.ctx = this.canvas.getContext('2d');
        this.scale = window.devicePixelRatio || 1;
        this.width = this.container.clientWidth;
        this.height = this.container.clientHeight;
        this.canvas.width = this.width * this.scale;
        this.canvas.height = this.height * this.scale;
        this.canvas.style.width = `${this.width}px`;
        this.canvas.style.height = `${this.height}px`;
        this.ctx.scale(this.scale, this.scale);
        this.data = data;
        this.drag = { active: false, x: 0, offset: 0 };
        this.sliderValue = 20;
        this.bindEvents();
        this.draw();
    }

    bindEvents() {
        window.addEventListener('resize', () => this.resize());
        this.canvas.addEventListener('pointerdown', (e) => {
            const { left } = this.canvas.getBoundingClientRect();
            const x = e.clientX - left;
            if (this.isSliderHit(x)) {
                this.drag.active = true;
                this.drag.offset = x - this.sliderX();
            }
        });
        window.addEventListener('pointerup', () => this.drag.active = false);
        window.addEventListener('pointermove', (e) => {
            if (!this.drag.active) return;
            const { left } = this.canvas.getBoundingClientRect();
            const x = e.clientX - left - this.drag.offset;
            const clamped = Math.max(50, Math.min(this.width - 50, x));
            const percent = (clamped - 50) / (this.width - 100);
            this.sliderValue = Math.round(1 + percent * 30);
            this.draw();
        });
    }

    resize() {
        this.width = this.container.clientWidth;
        this.height = this.container.clientHeight;
        this.canvas.width = this.width * this.scale;
        this.canvas.height = this.height * this.scale;
        this.canvas.style.width = `${this.width}px`;
        this.canvas.style.height = `${this.height}px`;
        this.ctx.scale(this.scale, this.scale);
        this.draw();
    }

    sliderX() {
        return 50 + ((this.sliderValue - 1) / 30) * (this.width - 100);
    }

    isSliderHit(x) {
        return Math.abs(x - this.sliderX()) < 20;
    }

    updateData(data) {
        this.data = data;
        this.draw();
    }

    draw() {
        const ctx = this.ctx;
        ctx.save();
        ctx.clearRect(0, 0, this.width, this.height);
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, this.width, this.height);
        ctx.font = '12px Inter';
        ctx.fillStyle = '#cbd5f5';
        ctx.fillText('Spending velocity', 32, 32);
        ctx.fillText(`Day ${this.sliderValue}`, this.width - 90, 32);

        const laneHeight = 52;
        const startY = 64;
        const maxAmount = Math.max(1, ...this.data.spendingData.map(d => d.total));
        this.data.spendingData.forEach((item, index) => {
            const y = startY + index * laneHeight;
            const width = (item.finalSpent / maxAmount) * (this.width - 140);
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(32, y, this.width - 64, laneHeight - 12);
            const gradient = ctx.createLinearGradient(32, y, 32 + width, y);
            gradient.addColorStop(0, item.color);
            gradient.addColorStop(1, '#1d4ed8');
            ctx.fillStyle = gradient;
            ctx.fillRect(32, y, width, laneHeight - 12);
            ctx.fillStyle = '#e5e7eb';
            ctx.fillText(item.label, 40, y + 24);
            ctx.fillStyle = '#94a3b8';
            ctx.fillText(`${formatCurrency(item.finalSpent)} / ${formatCurrency(item.total)}`, 40, y + 40);
        });

        const sliderX = this.sliderX();
        ctx.strokeStyle = '#6366f1';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sliderX, 40);
        ctx.lineTo(sliderX, this.height - 40);
        ctx.stroke();

        ctx.fillStyle = '#0ea5e9';
        ctx.beginPath();
        ctx.arc(sliderX, this.height - 48, 14, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#0f172a';
        ctx.font = 'bold 12px Inter';
        ctx.fillText(this.sliderValue.toString(), sliderX - 6, this.height - 44);
        ctx.restore();
    }
}
function renderTransactions() {
    const listEl = document.getElementById('transactions-list');
    const assetsEl = document.getElementById('assets-display');
    const totalSpentEl = document.getElementById('total-spent');
    const snapshot = computeBudgetSnapshots();

    const sorted = [...appState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    const totalSpent = sorted.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
    const totalCredits = sorted.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
    const assets = Object.values(appState.accounts.byId).reduce((sum, a) => sum + a.balance, 0);

    totalSpentEl.textContent = formatCurrency(totalSpent);
    assetsEl.textContent = formatCurrency(assets + totalCredits - totalSpent);

    const groups = sorted.reduce((acc, txn) => {
        const day = new Date(txn.date).toISOString().split('T')[0];
        if (!acc[day]) acc[day] = [];
        acc[day].push(txn);
        return acc;
    }, {});

    listEl.innerHTML = Object.entries(groups).map(([day, txns]) => {
        const label = new Date(day).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        return `
            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600 mb-3">${label}</h3>
                <div class="space-y-3">
                    ${txns.map(txn => {
                        const entry = txn.subCategoryId ? snapshot[txn.subCategoryId] : null;
                        const parentName = entry ? entry.parent.name : 'Uncategorized';
                        const subName = entry ? entry.sub.name : 'Assign category';
                        return `
                            <article class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-slate-900">${txn.name}</p>
                                    <p class="text-xs text-slate-500">${subName} · ${parentName}</p>
                                    <p class="text-xs text-slate-400">${formatDate(txn.date)}</p>
                                </div>
                                <div class="text-right flex flex-col items-end gap-1">
                                    <span class="font-semibold ${txn.type === 'debit' ? 'text-slate-900' : 'text-emerald-600'}">${txn.type === 'debit' ? '-' : '+'}${formatCurrency(txn.amount)}</span>
                                    <button class="txn-categorize text-xs text-blue-600 flex items-center gap-1" data-id="${txn.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                        Assign
                                    </button>
                                </div>
                            </article>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function renderAccountsView() {
    const summaryEl = document.getElementById('accounts-summary');
    const placesEl = document.getElementById('accounts-places');
    const snapshot = computeBudgetSnapshots();

    summaryEl.innerHTML = Object.values(appState.accounts.byId).map(account => {
        return `
            <article class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-slate-900">${account.name}</h3>
                        <p class="text-xs text-slate-500">${account.institution}</p>
                    </div>
                    <p class="text-lg font-bold text-slate-900">${formatCurrency(account.balance)}</p>
                </div>
            </article>
        `;
    }).join('');

    const placeCards = appState.map.markers.map(({ place }) => {
        const entry = place.subCategoryId ? snapshot[place.subCategoryId] : null;
        const remaining = entry ? entry.remaining : null;
        return `
            <article class="bg-white border border-slate-200 rounded-2xl p-4 flex justify-between items-center shadow-sm">
                <div>
                    <h3 class="font-semibold text-slate-900">${place.title}</h3>
                    <p class="text-xs text-slate-500">${place.type}</p>
                </div>
                <div class="text-right">
                    ${remaining !== null ? `<p class="text-xs text-slate-500">Remaining</p><p class="text-sm font-bold text-emerald-600">${formatCurrency(remaining)}</p>` : '<p class="text-xs text-amber-600">Uncategorized</p>'}
                </div>
            </article>
        `;
    }).join('');
    placesEl.innerHTML = placeCards || '<p class="text-sm text-slate-500">Search for places to see budget matches.</p>';
}

function renderPlaceDetail(place) {
    const container = document.getElementById('place-detail-view');
    if (!place) {
        container.innerHTML = '';
        return;
    }
    const snapshot = computeBudgetSnapshots();
    const entry = place.subCategoryId ? snapshot[place.subCategoryId] : null;
    const subName = entry ? entry.sub.name : 'Uncategorized';
    const parentName = entry ? entry.parent.name : 'No parent assigned';
    const remaining = entry ? formatCurrency(entry.remaining) : '—';

    container.innerHTML = `
        <button class="text-sm text-blue-600 font-semibold" id="back-to-budget">← Back to overview</button>
        <div class="bg-white border border-slate-200 rounded-3xl p-5 shadow-lg space-y-4">
            <div>
                <h2 class="text-xl font-bold text-slate-900">${place.title}</h2>
                <p class="text-sm text-slate-500">${place.type}</p>
            </div>
            <div class="bg-slate-900 text-white rounded-2xl p-4">
                <p class="text-sm text-slate-300">Assigned category</p>
                <p class="text-lg font-semibold">${subName}</p>
                <p class="text-xs text-slate-400">${parentName}</p>
                <p class="text-sm mt-2">Remaining: <span class="font-semibold">${remaining}</span></p>
            </div>
            <div class="flex gap-3">
                <button class="map-add-existing flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-semibold flex items-center justify-center gap-2" data-place="${place.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add to sub-category
                </button>
                <button class="map-create-new flex-1 border border-dashed border-blue-400 text-blue-600 py-2.5 rounded-xl font-semibold flex items-center justify-center gap-2" data-place="${place.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    Create new
                </button>
            </div>
        </div>
    `;
}

function renderPlaceFilters() {
    const container = document.getElementById('place-type-filters');
    container.innerHTML = `
        <button class="filter-btn px-4 py-2 rounded-full text-sm font-semibold ${appState.map.activeType === 'all' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600'}" data-filter="all">All</button>
        ${placeTypeConfig.map(type => `
            <button class="filter-btn px-4 py-2 rounded-full text-sm font-semibold ${appState.map.activeType === type.id ? 'bg-blue-600 text-white' : 'bg-white text-slate-600'}" data-filter="${type.id}">${type.label}</button>
        `).join('')}
    `;
}

function switchSidebarView(targetId) {
    document.querySelectorAll('.sidebar-view').forEach(view => view.classList.toggle('active', view.id === targetId));
    document.querySelectorAll('.nav-btn').forEach(btn => {
        const isActive = btn.dataset.view === targetId;
        btn.classList.toggle('active', isActive);
        btn.classList.toggle('text-slate-600', !isActive);
    });
    if (targetId === 'budget-view') {
        renderBudgetView();
        initTimeline();
    } else if (targetId === 'transactions-view') {
        renderTransactions();
    } else if (targetId === 'accounts-view') {
        renderAccountsView();
    }
}
function updateViewMode() {
    const width = window.innerWidth;
    const mode = width <= 1024 ? 'mobile' : 'desktop';
    if (appState.viewMode !== mode) {
        appState.viewMode = mode;
        document.getElementById('view-toggle-label').textContent = mode === 'mobile' ? 'Mobile view' : '';
        emit('viewport:changed', mode);
    }
}

function openCategoryModal(options = {}) {
    const modal = document.getElementById('category-modal');
    modal.classList.add('active');
    document.getElementById('category-name').value = options.name || '';
    document.getElementById('category-budget').value = options.budget || '';
    document.getElementById('category-icon').value = options.icon || '';
    const select = document.getElementById('category-parent');
    select.innerHTML = Object.values(appState.budgets.parents).map(parent => {
        return `<option value="${parent.id}" ${options.parentId === parent.id ? 'selected' : ''}>${parent.name}</option>`;
    }).join('');
    if (options.allowParentCreation) {
        select.insertAdjacentHTML('afterbegin', '<option value="__new">Create new parent</option>');
    }
    select.value = options.parentId || select.options[0]?.value;
    modal.dataset.mode = options.mode || 'sub';
    modal.dataset.parent = options.parentId || '';
}

function closeCategoryModal() {
    const modal = document.getElementById('category-modal');
    modal.classList.remove('active');
}

function openCategorizeModal(target, context = 'transaction') {
    const modal = document.getElementById('categorize-modal');
    modal.classList.add('active');
    modal.dataset.context = context;
    const select = document.getElementById('categorize-select');
    select.innerHTML = withSubCategories((child, parent) => `<option value=\"${child.id}\">${parent.name} — ${child.name}</option>`).join('');
    if (context === 'transaction') {
        modal.dataset.txn = target.id;
        modal.dataset.place = '';
        document.getElementById('categorize-modal-transaction').textContent = `${target.name} • ${formatCurrency(target.amount)}`;
        select.value = target.subCategoryId || select.options[0]?.value;
    } else {
        modal.dataset.place = target.id;
        modal.dataset.txn = '';
        document.getElementById('categorize-modal-transaction').textContent = `Assign ${target.title}`;
        select.value = target.subCategoryId || select.options[0]?.value;
    }
}

function closeCategorizeModal() {
    document.getElementById('categorize-modal').classList.remove('active');
}

function createParentCategory(name, colorKey = 'slate', icon = '') {
    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
    if (!appState.budgets.parents[id]) {
        appState.budgets.parents[id] = { id, name, gradient: `from-${colorKey}-500 to-${colorKey}-600`, colorKey, icon, children: {} };
    }
    return appState.budgets.parents[id];
}

function createSubCategory(parentId, name, budget, icon = '', type = 'expense') {
    const parent = appState.budgets.parents[parentId];
    if (!parent) return null;
    const id = `${parentId}-${name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
    parent.children[id] = { id, name, icon, budget: Number(budget), type };
    return parent.children[id];
}

function attachNewCategory({ parentId, name, budget, icon, type }) {
    if (parentId === '__new') {
        const newParentName = name;
        const paletteKeys = Object.keys(tailwindPalette);
        const colorKey = paletteKeys[Math.floor(Math.random() * paletteKeys.length)];
        const parent = createParentCategory(newParentName, colorKey, icon);
        parent.children[`${parent.id}-main`] = { id: `${parent.id}-main`, name: `${newParentName} main`, icon, budget: Number(budget), type };
    } else {
        createSubCategory(parentId, name, budget, icon, type);
    }
    emit('state:changed');
}

function applyCategoryChangesFromModal() {
    const modal = document.getElementById('category-modal');
    const parentId = document.getElementById('category-parent').value;
    const name = document.getElementById('category-name').value.trim();
    const budget = parseFloat(document.getElementById('category-budget').value);
    const icon = document.getElementById('category-icon').value.trim();
    if (!name || isNaN(budget)) return;
    attachNewCategory({ parentId, name, budget, icon, type: 'expense' });
    closeCategoryModal();
}

function saveCategorizationFromModal() {
    const modal = document.getElementById('categorize-modal');
    const select = document.getElementById('categorize-select');
    const subCategoryId = select.value;
    if (!subCategoryId) return;
    const context = modal.dataset.context || 'transaction';
    if (context === 'transaction') {
        const txnId = Number(modal.dataset.txn);
        const txn = appState.transactions.find(t => t.id === txnId);
        if (!txn) return;
        txn.subCategoryId = subCategoryId;
    } else if (context === 'place') {
        const placeId = modal.dataset.place;
        const markerEntry = appState.map.markers.find(m => m.place.id === placeId);
        if (markerEntry) {
            markerEntry.place.subCategoryId = subCategoryId;
            let matchParent = null;
            for (const parent of Object.values(appState.budgets.parents)) {
                if (parent.children[subCategoryId]) {
                    matchParent = { parent, child: parent.children[subCategoryId] };
                    break;
                }
            }
            markerEntry.place.parentId = matchParent?.parent.id || null;
            const status = markerEntry.place.subCategoryId ? placeParentColor(markerEntry.place) : 'uncategorized';
            const iconHtml = pinTemplates[markerEntry.place.iconKey] || pinTemplates.default;
            markerEntry.marker.setIcon(L.divIcon({ html: `<div class=\"pin-shell\" data-status=\"${status}\">${iconHtml}</div>`, className: '', iconSize: [40, 40], iconAnchor: [20, 40] }));
            renderPlaceDetail(markerEntry.place);
        }
    }
    closeCategorizeModal();
    emit('state:changed');
}

function loadInitialTransactions() {
    const seed = [
        { id: 1, name: 'Public House Restaurant', amount: 72.5, type: 'debit', date: '2025-10-08', subCategoryId: 'lifestyle-dining-out' },
        { id: 2, name: 'Whole Foods Chattanooga', amount: 128.33, type: 'debit', date: '2025-10-05', subCategoryId: 'living-groceries' },
        { id: 3, name: 'EPB Chattanooga', amount: 94.12, type: 'debit', date: '2025-10-02', subCategoryId: 'living-utilities' },
        { id: 4, name: 'BlueCross Premium', amount: 210.0, type: 'debit', date: '2025-10-01', subCategoryId: 'health-healthcare' },
        { id: 5, name: 'Remote salary', amount: 4200, type: 'credit', date: '2025-10-01', subCategoryId: null }
    ];
    appState.transactions = seed;
}

function generateDemoTransactions() {
    const merchants = [
        { name: 'Mean Mug Coffeehouse', type: 'debit', range: [6, 18], category: 'lifestyle-dining-out' },
        { name: 'Easy Bistro', type: 'debit', range: [32, 120], category: 'lifestyle-dining-out' },
        { name: 'Walmart Neighborhood Market', type: 'debit', range: [20, 95], category: 'living-groceries' },
        { name: 'Publix Super Market', type: 'debit', range: [25, 140], category: 'living-groceries' },
        { name: 'Fuel Center', type: 'debit', range: [28, 75], category: 'transport-gas' },
        { name: 'Orange Theory Northshore', type: 'debit', range: [19, 45], category: 'health-fitness' },
        { name: 'BlueCross Payroll', type: 'credit', range: [1800, 2200], category: null },
        { name: 'Volkswagen Credit', type: 'debit', range: [210, 420], category: 'transport-rideshare' },
        { name: 'Tennessee Aquarium', type: 'debit', range: [15, 55], category: 'lifestyle-entertainment' }
    ];
    const demo = [];
    for (let i = 0; i < 200; i++) {
        const merchant = merchants[Math.floor(Math.random() * merchants.length)];
        const amount = Number((Math.random() * (merchant.range[1] - merchant.range[0]) + merchant.range[0]).toFixed(2));
        const date = new Date();
        date.setDate(date.getDate() - Math.floor(Math.random() * 45));
        demo.push({
            id: Date.now() + i,
            name: merchant.name,
            amount,
            type: merchant.type,
            date: date.toISOString().split('T')[0],
            subCategoryId: merchant.category
        });
    }
    appState.transactions = demo;
    emit('state:changed');
}

function simulatePlaidLink() {
    appState.plaid.connected = true;
    document.getElementById('demo-data-btn').classList.add('hidden');
    document.getElementById('plaid-link-btn').textContent = 'Bank linked';
    document.getElementById('plaid-link-btn').disabled = true;
    emit('state:changed');
}

function initEventHandlers() {
    document.body.addEventListener('click', (event) => {
        if (event.target.closest('.nav-btn')) {
            const targetId = event.target.closest('.nav-btn').dataset.view;
            switchSidebarView(targetId);
        }
        if (event.target.closest('.add-parent-btn')) {
            openCategoryModal({ allowParentCreation: true, mode: 'parent' });
        }
        if (event.target.closest('.add-parent-child')) {
            const parentId = event.target.closest('.add-parent-child').dataset.parent;
            openCategoryModal({ parentId });
        }
        if (event.target.closest('.add-sub-btn')) {
            const { parent } = event.target.closest('.add-sub-btn').dataset;
            openCategoryModal({ parentId: parent });
        }
        if (event.target.closest('#category-modal-save')) {
            applyCategoryChangesFromModal();
        }
        if (event.target.closest('.close-category-modal')) {
            closeCategoryModal();
        }
        if (event.target.closest('#categorize-save')) {
            saveCategorizationFromModal();
        }
        if (event.target.closest('.close-categorize-modal')) {
            closeCategorizeModal();
        }
        if (event.target.closest('#demo-data-btn')) {
            generateDemoTransactions();
        }
        if (event.target.closest('#plaid-link-btn') && !appState.plaid.connected) {
            simulatePlaidLink();
        }
        if (event.target.closest('.txn-categorize')) {
            const txnId = Number(event.target.closest('.txn-categorize').dataset.id);
            const txn = appState.transactions.find(t => t.id === txnId);
            if (txn) openCategorizeModal(txn, 'transaction');
        }
        if (event.target.closest('.filter-btn')) {
            const filter = event.target.closest('.filter-btn').dataset.filter;
            appState.map.activeType = filter;
            renderPlaceFilters();
            fetchPlaces();
        }
        if (event.target.closest('#back-to-budget')) {
            switchSidebarView('budget-view');
        }
        if (event.target.closest('.map-add-existing')) {
            const placeId = event.target.closest('.map-add-existing').dataset.place;
            const marker = appState.map.markers.find(m => m.place.id === placeId);
            if (marker) openCategorizeModal(marker.place, 'place');
        }
        if (event.target.closest('.map-create-new')) {
            const parentId = Object.keys(appState.budgets.parents)[0];
            openCategoryModal({ parentId });
        }
    });

    document.getElementById('categorize-new-sub').addEventListener('click', () => {
        closeCategorizeModal();
        openCategoryModal({ parentId: Object.keys(appState.budgets.parents)[0] });
    });

    document.getElementById('search-input').addEventListener('input', debounce(() => {
        fetchPlaces();
    }, 400));
}

function debounce(fn, delay) {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(null, args), delay);
    };
}

function initializeApp() {
    initMap();
    renderPlaceFilters();
    loadInitialTransactions();
    switchSidebarView('budget-view');
    updateViewMode();
    initEventHandlers();
    renderPlaceDetail(null);
    emit('state:changed');
}

on('state:changed', () => {
    renderBudgetView();
    renderTransactions();
    renderAccountsView();
    initTimeline();
    if (appState.map.selectedPlace) {
        renderPlaceDetail(appState.map.selectedPlace);
    }
});

on('place:selected', (event) => {
    renderPlaceDetail(event.detail);
});

window.addEventListener('resize', () => updateViewMode());

initializeApp();
</script>
</body>
</html>
