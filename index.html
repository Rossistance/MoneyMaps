<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Maps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: light; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #f3f4f6; }
        body { overflow: hidden; }
        .main-container { height: 100vh; }
        #desktop-view { display: none; }
        #mobile-view { display: none; }
        .timeline-shell { background: linear-gradient(135deg, #111827, #1f2937); border-radius: 1rem; box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35); overflow: hidden; }
        .timeline-shell canvas { display: block; width: 100%; height: 100%; }
        .bar-chart { position: relative; height: 14px; border-radius: 9999px; background: rgba(148, 163, 184, 0.25); overflow: hidden; }
        .bar-chart .budgeted-bar { position: absolute; inset: 0; opacity: 0.25; background: var(--budget-gradient); }
        .bar-chart .spent-bar { position: absolute; inset: 0; background: var(--spent-gradient); transform-origin: left; }
        .category-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .category-card:hover { transform: translateY(-2px); }
        .leaflet-container { font-family: 'Inter', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(10px); }
        .modal-content { max-width: 420px; width: 100%; }
        .icon-button svg { transition: transform 0.2s ease; }
        .icon-button:hover svg { transform: scale(1.15); }
        .icon-pill { border-radius: 999px; background: rgba(226, 232, 240, 0.65); backdrop-filter: blur(6px); }
        .place-card { background: rgba(255,255,255,0.95); border-radius: 1.25rem; box-shadow: 0 20px 40px rgba(15,23,42,0.18); padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; min-width: 240px; }
        .place-card-actions { display: flex; align-items: center; justify-content: space-between; }
        .place-icon-button { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 999px; background: rgba(79,70,229,0.08); color: #4f46e5; }
        #mobile-view .mobile-map { height: 44vh; }
        #mobile-view .mobile-sidebar { height: 56vh; }
        @media (max-width: 1023px) { body { overflow: auto; height: auto; } }
    </style>
</head>
<body class="bg-slate-100">
<div id="desktop-view" class="main-container flex">
    <div class="flex-1 relative">
        <div id="map" class="absolute inset-0"></div>
        <div class="absolute top-0 left-0 right-0 p-4 z-30 space-y-3">
            <div class="max-w-xl mx-auto">
                <div class="relative">
                    <input id="search-input" type="text" placeholder="Search city, state, or business" class="w-full pl-11 pr-4 py-3 bg-white/90 border border-slate-200 rounded-2xl shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <div id="autocomplete-results" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-xl shadow-lg overflow-hidden hidden max-h-72 overflow-y-auto"></div>
                </div>
                <div id="category-filters-container" class="mt-2 flex items-center gap-2 overflow-x-auto p-2 bg-white/80 rounded-2xl shadow-md"></div>
                <div id="place-results" class="mt-4 flex gap-3 overflow-x-auto"></div>
            </div>
        </div>
    </div>
    <aside id="sidebar" class="w-[460px] bg-white flex flex-col border-l border-slate-200 shadow-2xl">
        <header class="px-6 py-4 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-slate-900">Money Maps</h1>
                <button id="open-category-modal" class="icon-button p-2 rounded-full bg-indigo-50 text-indigo-600" title="Add category">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
        </header>
        <nav class="grid grid-cols-3 gap-2 px-4 pt-4 pb-2 border-b border-slate-200 bg-slate-50">
            <button class="nav-btn active flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-indigo-600 bg-indigo-100" data-view="budget-view">Budget</button>
            <button class="nav-btn flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-slate-500" data-view="accounts-view">Accounts</button>
            <button class="nav-btn flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-slate-500" data-view="transactions-view">History</button>
        </nav>
        <section id="sidebar-content" class="flex-1 overflow-y-auto">
            <div id="budget-view" class="sidebar-view active px-6 py-6 space-y-6">
                <div class="timeline-shell h-64" id="budget-timeline"></div>
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-slate-800 flex items-center gap-2">Fund flows</h2>
                    <button class="icon-button p-2 rounded-full bg-indigo-50 text-indigo-600" data-trigger="category" title="Add category">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="budget-list" class="space-y-4"></div>
                <div>
                    <h2 class="text-xl font-semibold text-slate-800">Pure savings</h2>
                    <div id="pure-savings-list" class="space-y-4 mt-3"></div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-slate-800">Time targets</h2>
                    <div id="goals-list" class="space-y-4 mt-3 pb-6"></div>
                </div>
            </div>
            <div id="accounts-view" class="sidebar-view px-6 py-6 space-y-6 hidden">
                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                    <h3 class="text-lg font-semibold text-slate-800">Accounts overview</h3>
                    <p class="text-sm text-slate-500 mt-1">Balances and remaining budgets per sub-category.</p>
                </div>
                <div id="accounts-list" class="space-y-4"></div>
            </div>
            <div id="transactions-view" class="sidebar-view px-6 py-6 space-y-4 hidden">
                <div class="flex items-center justify-between gap-3">
                    <button id="demo-data-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold rounded-xl bg-slate-900 text-white shadow-lg">Use demo data</button>
                    <button id="plaid-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold rounded-xl bg-emerald-500 text-white shadow-lg">Link bank (Plaid)</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-emerald-50 text-emerald-600 rounded-2xl p-4">
                        <p class="text-xs uppercase tracking-wide font-semibold">Assets</p>
                        <p id="assets-display" class="text-2xl font-bold mt-1"></p>
                    </div>
                    <div class="bg-rose-50 text-rose-600 rounded-2xl p-4">
                        <p class="text-xs uppercase tracking-wide font-semibold">Total spent</p>
                        <p id="total-spent" class="text-2xl font-bold mt-1"></p>
                    </div>
                </div>
                <div id="transactions-list" class="space-y-4 pb-10"></div>
            </div>
        </section>
    </aside>
</div>
<div id="mobile-view" class="flex flex-col h-full">
    <div class="mobile-map relative">
        <div id="mobile-map" class="absolute inset-0"></div>
        <div class="absolute top-3 left-0 right-0 px-4 space-y-2">
            <div class="bg-white/90 rounded-2xl shadow-lg p-3">
                <input id="mobile-search-input" type="text" placeholder="Search city, state, or business" class="w-full text-sm px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="mobile-category-filters" class="flex items-center gap-2 overflow-x-auto"></div>
            <div id="mobile-place-results" class="flex gap-2 overflow-x-auto"></div>
        </div>
    </div>
    <div class="mobile-sidebar bg-white flex-1 rounded-t-3xl shadow-2xl overflow-hidden">
        <nav class="grid grid-cols-3 gap-2 px-4 pt-4 pb-2 border-b border-slate-200 bg-slate-50">
            <button class="mobile-nav-btn active flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-indigo-600 bg-indigo-100" data-target="mobile-budget-view">Budget</button>
            <button class="mobile-nav-btn flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-slate-500" data-target="mobile-accounts-view">Accounts</button>
            <button class="mobile-nav-btn flex flex-col items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold text-slate-500" data-target="mobile-transactions-view">History</button>
        </nav>
        <div id="mobile-views" class="h-full overflow-y-auto">
            <div id="mobile-budget-view" class="mobile-view active px-4 py-4 space-y-4">
                <div class="timeline-shell h-60" id="mobile-budget-timeline"></div>
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-800">Fund flows</h2>
                    <button class="icon-button p-2 rounded-full bg-indigo-50 text-indigo-600" data-trigger="category">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="mobile-budget-list" class="space-y-4"></div>
            </div>
            <div id="mobile-accounts-view" class="mobile-view hidden px-4 py-4 space-y-4">
                <div id="mobile-accounts-list" class="space-y-3"></div>
            </div>
            <div id="mobile-transactions-view" class="mobile-view hidden px-4 py-4 space-y-3">
                <div class="flex items-center justify-between gap-2">
                    <button class="flex-1 px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold" data-action="demo">Use demo data</button>
                    <button class="flex-1 px-3 py-2 rounded-xl bg-emerald-500 text-white text-sm font-semibold" data-action="plaid">Link bank</button>
                </div>
                <div id="mobile-transactions-list" class="space-y-3 pb-10"></div>
            </div>
        </div>
    </div>
</div>
<div id="category-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop bg-black/40 p-4">
    <div class="modal-content bg-white rounded-3xl shadow-2xl p-6 space-y-5">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900" id="category-modal-title">Create category</h3>
            <button data-close class="p-2 rounded-full text-slate-400 hover:text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        <form id="category-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Name</label>
                <input name="name" required type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g. Dining Out">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Parent</label>
                <select name="parent" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Monthly budget</label>
                <input name="budget" type="number" step="0.01" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">Save</button>
        </form>
    </div>
</div>
<div id="transaction-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop bg-black/40 p-4">
    <div class="modal-content bg-white rounded-3xl shadow-2xl p-6 space-y-5">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900">Categorize transaction</h3>
            <button data-close class="p-2 rounded-full text-slate-400 hover:text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        <form id="transaction-category-form" class="space-y-4">
            <input type="hidden" name="transactionId">
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Assign to sub-category</label>
                <select name="subcategory" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
            </div>
            <button type="submit" class="w-full px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">Assign</button>
        </form>
    </div>
</div>
<script>
const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';
const categoryPalette = [
    { name: 'Housing', color: '#4f46e5', spentGradient: 'linear-gradient(90deg, #6366f1, #4338ca)', budgetGradient: 'linear-gradient(90deg, rgba(99,102,241,0.4), rgba(67,56,202,0.4))' },
    { name: 'Food', color: '#ec4899', spentGradient: 'linear-gradient(90deg, #f472b6, #db2777)', budgetGradient: 'linear-gradient(90deg, rgba(244,114,182,0.4), rgba(219,39,119,0.4))' },
    { name: 'Transit', color: '#22c55e', spentGradient: 'linear-gradient(90deg, #34d399, #059669)', budgetGradient: 'linear-gradient(90deg, rgba(52,211,153,0.35), rgba(5,150,105,0.35))' },
    { name: 'Lifestyle', color: '#f97316', spentGradient: 'linear-gradient(90deg, #fb923c, #ea580c)', budgetGradient: 'linear-gradient(90deg, rgba(251,146,60,0.35), rgba(234,88,12,0.35))' },
    { name: 'Utilities', color: '#0ea5e9', spentGradient: 'linear-gradient(90deg, #38bdf8, #0284c7)', budgetGradient: 'linear-gradient(90deg, rgba(56,189,248,0.35), rgba(2,132,199,0.35))' },
    { name: 'Savings', color: '#a855f7', spentGradient: 'linear-gradient(90deg, #c084fc, #7e22ce)', budgetGradient: 'linear-gradient(90deg, rgba(192,132,252,0.35), rgba(126,34,206,0.35))' }
];
const placeTypeIcons = {
    'restaurant': 'M12 2C8.14 2 5 5.14 5 9c0 1.54.47 2.97 1.27 4.16L12 22l5.73-8.84C18.53 11.97 19 10.54 19 9c0-3.86-3.14-7-7-7z',
    'electronics-store': 'M5 8h14v10H5z M9 6h6v2H9z',
    'bus-station': 'M6 3h12a2 2 0 0 1 2 2v10h-2v3h-2v-3H8v3H6v-3H4V5a2 2 0 0 1 2-2zm0 4v3h12V7H6z',
    'grocery-or-supermarket': 'M5 4h14l-1.5 9h-11L6 6H4',
    'bank': 'M12 3l9 5v2H3V8l9-5zm-7 9h14v7H5z',
    'default': 'M12 2l7 7-7 13-7-13 7-7z'
};
function normalizePlaceType(rawType = '') {
    const type = rawType.toLowerCase();
    if (type.includes('restaurant') || type.includes('food') || type.includes('dining')) return 'restaurant';
    if (type.includes('grocery') || type.includes('market') || type.includes('supermarket')) return 'grocery-or-supermarket';
    if (type.includes('electronics') || type.includes('shopping') || type.includes('store')) return 'electronics-store';
    if (type.includes('bus') || type.includes('transit') || type.includes('transport') || type.includes('parking')) return 'bus-station';
    if (type.includes('bank') || type.includes('atm') || type.includes('finance')) return 'bank';
    return 'default';
}
function createState() {
    const listeners = new Map();
    const state = {
        plaidConnected: false,
        activePlaceType: 'all',
        budgets: { parents: [] },
        savings: [],
        goals: [],
        transactions: [],
        accounts: [],
        places: [],
        placeAssignments: {},
        manualPlaces: [],
        register(event, callback) {
            if (!listeners.has(event)) listeners.set(event, new Set());
            listeners.get(event).add(callback);
            return () => listeners.get(event).delete(callback);
        },
        emit(event, payload) {
            if (!listeners.has(event)) return;
            listeners.get(event).forEach(cb => cb(payload));
        }
    };
    return state;
}
const AppState = createState();
function seedInitialData() {
    const parentConfigs = [
        { id: 'housing', name: 'Housing & Utilities', budget: 1800 },
        { id: 'food', name: 'Food & Dining', budget: 750 },
        { id: 'transport', name: 'Transportation', budget: 420 },
        { id: 'lifestyle', name: 'Lifestyle', budget: 600 },
        { id: 'savings', name: 'Savings', budget: 900 }
    ];
    AppState.budgets.parents = parentConfigs.map((config, index) => ({
        id: config.id,
        name: config.name,
        budget: config.budget,
        spent: 0,
        paletteIndex: index % categoryPalette.length,
        subcategories: []
    }));
    const subcategorySeed = [
        { id: 'rent', parent: 'housing', name: 'Rent', budget: 1450 },
        { id: 'utilities', parent: 'housing', name: 'Utilities', budget: 220 },
        { id: 'internet', parent: 'housing', name: 'Internet', budget: 130 },
        { id: 'groceries', parent: 'food', name: 'Groceries', budget: 420 },
        { id: 'dining-out', parent: 'food', name: 'Dining Out', budget: 230 },
        { id: 'coffee', parent: 'food', name: 'Coffee & Treats', budget: 100 },
        { id: 'rideshare', parent: 'transport', name: 'Rideshare', budget: 140 },
        { id: 'fuel', parent: 'transport', name: 'Fuel', budget: 180 },
        { id: 'parking', parent: 'transport', name: 'Parking', budget: 100 },
        { id: 'fitness', parent: 'lifestyle', name: 'Fitness', budget: 120 },
        { id: 'entertainment', parent: 'lifestyle', name: 'Entertainment', budget: 210 },
        { id: 'shopping', parent: 'lifestyle', name: 'Shopping', budget: 270 },
        { id: 'emergency', parent: 'savings', name: 'Emergency fund', budget: 500 },
        { id: 'vacation', parent: 'savings', name: 'Vacation fund', budget: 250 },
        { id: 'investing', parent: 'savings', name: 'Investing', budget: 150 }
    ];
    subcategorySeed.forEach(seed => addSubcategory(seed.parent, seed));
    AppState.savings = [
        { id: 'cash-reserve', name: 'Cash reserve', current: 1200, total: 10000, paletteIndex: 4 },
        { id: 'down-payment', name: 'Down payment', current: 5400, total: 12000, paletteIndex: 0 }
    ];
    AppState.goals = [
        { id: 'trip', name: 'Autumn getaway', current: 750, total: 1800, due: 'Dec 2025', paletteIndex: 1 },
        { id: 'renovation', name: 'Kitchen refresh', current: 2600, total: 4200, due: 'Jun 2026', paletteIndex: 3 }
    ];
    AppState.accounts = [
        { id: 'checking', name: 'Checking', balance: 3250 },
        { id: 'savings', name: 'High-yield savings', balance: 8900 },
        { id: 'card', name: 'Travel credit card', balance: -640 }
    ];
}
function addParentCategory(name, budget) {
    const paletteIndex = AppState.budgets.parents.length % categoryPalette.length;
    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
    const parent = { id, name, budget: Number(budget) || 0, spent: 0, paletteIndex, subcategories: [] };
    AppState.budgets.parents.push(parent);
    AppState.emit('budgets:updated');
    return parent;
}
function addSubcategory(parentId, { id, name, budget }) {
    const parent = AppState.budgets.parents.find(p => p.id === parentId);
    if (!parent) return null;
    const subId = id || `${parentId}-${name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
    const existing = parent.subcategories.find(s => s.id === subId);
    if (existing) return existing;
    const sub = { id: subId, name, budget: Number(budget) || 0, spent: 0 };
    parent.subcategories.push(sub);
    AppState.emit('budgets:updated');
    return sub;
}
function findSubcategory(subId) {
    for (const parent of AppState.budgets.parents) {
        const match = parent.subcategories.find(s => s.id === subId);
        if (match) return { parent, subcategory: match };
    }
    return null;
}
function recalcBudgets() {
    AppState.budgets.parents.forEach(parent => {
        parent.spent = 0;
        parent.subcategories.forEach(sub => { sub.spent = 0; });
    });
    AppState.transactions.forEach(txn => {
        if (txn.type === 'credit') return;
        if (!txn.category) return;
        const found = findSubcategory(txn.category);
        if (found) {
            found.subcategory.spent += Math.abs(txn.amount);
            found.parent.spent += Math.abs(txn.amount);
        }
    });
}
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}
function createCategoryCard(parent, targetList) {
    const palette = categoryPalette[parent.paletteIndex % categoryPalette.length];
    const wrapper = document.createElement('div');
    wrapper.className = 'category-card bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md';
    const header = document.createElement('div');
    header.className = 'flex items-center justify-between mb-3';
    const nameSpan = document.createElement('div');
    nameSpan.innerHTML = `<p class="text-base font-semibold text-slate-900">${parent.name}</p><p class="text-xs text-slate-500">${parent.subcategories.length} sub-categories</p>`;
    header.appendChild(nameSpan);
    const addBtn = document.createElement('button');
    addBtn.className = 'icon-button p-2 rounded-full bg-slate-100 text-indigo-600';
    addBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
    addBtn.addEventListener('click', () => openCategoryModal({ parentId: parent.id }));
    header.appendChild(addBtn);
    wrapper.appendChild(header);
    const summary = document.createElement('div');
    summary.className = 'flex items-end justify-between';
    summary.innerHTML = `<div><p class="text-2xl font-semibold text-slate-900">${formatCurrency(parent.spent)}</p><p class="text-xs text-slate-500">spent of ${formatCurrency(parent.budget)}</p></div>`;
    wrapper.appendChild(summary);
    const bar = document.createElement('div');
    bar.className = 'bar-chart mt-4';
    bar.style.setProperty('--spent-gradient', palette.spentGradient);
    bar.style.setProperty('--budget-gradient', palette.budgetGradient);
    const spentRatio = parent.budget ? Math.min(parent.spent / parent.budget, 1) : 0;
    const budgetFill = document.createElement('div');
    budgetFill.className = 'budgeted-bar';
    bar.appendChild(budgetFill);
    const spentFill = document.createElement('div');
    spentFill.className = 'spent-bar';
    spentFill.style.transform = `scaleX(${spentRatio})`;
    bar.appendChild(spentFill);
    wrapper.appendChild(bar);
    const list = document.createElement('div');
    list.className = 'mt-4 space-y-3';
    parent.subcategories.forEach(sub => {
        const subPalette = palette;
        const subEl = document.createElement('div');
        subEl.className = 'flex items-center justify-between';
        const subInfo = document.createElement('div');
        subInfo.innerHTML = `<p class="text-sm font-semibold text-slate-800">${sub.name}</p><p class="text-xs text-slate-500">${formatCurrency(sub.spent)} / ${formatCurrency(sub.budget)}</p>`;
        const subBar = document.createElement('div');
        subBar.className = 'bar-chart w-36 h-2';
        subBar.style.setProperty('--spent-gradient', subPalette.spentGradient);
        subBar.style.setProperty('--budget-gradient', subPalette.budgetGradient);
        const ratio = sub.budget ? Math.min(sub.spent / sub.budget, 1) : 0;
        const subBudgetFill = document.createElement('div');
        subBudgetFill.className = 'budgeted-bar';
        const subSpentFill = document.createElement('div');
        subSpentFill.className = 'spent-bar';
        subSpentFill.style.transform = `scaleX(${ratio})`;
        subBar.appendChild(subBudgetFill);
        subBar.appendChild(subSpentFill);
        subEl.appendChild(subInfo);
        subEl.appendChild(subBar);
        list.appendChild(subEl);
    });
    wrapper.appendChild(list);
    targetList.appendChild(wrapper);
}
let desktopTimeline = null;
let mobileTimeline = null;
let activePlaceId = null;
class FinancialCanvas {
    constructor(containerId, data) {
        this.container = document.getElementById(containerId);
        if (!this.container) return;
        this.canvas = document.createElement('canvas');
        this.container.innerHTML = '';
        this.container.appendChild(this.canvas);
        this.ctx = this.canvas.getContext('2d');
        this.scale = 1;
        this.offsetX = 0;
        this.offsetY = 0;
        this.isPanning = false;
        this.lastX = 0;
        this.lastY = 0;
        this.sliderValue = 15;
        this.isDraggingSlider = false;
        this.sliderBounds = { x: 0, y: 0, width: 0, height: 0 };
        this.today = new Date();
        this.currentDayOfMonth = this.today.getDate();
        this.resizeObserver = new ResizeObserver(() => this.resize());
        this.resizeObserver.observe(this.container);
        this.updateData(data || { spendingData: [], savingsData: [] });
        this.addEventListeners();
    }
    updateData(data) {
        this.spendingData = (data.spendingData || []).map(item => ({ ...item }));
        this.savingsData = (data.savingsData || []).map(item => ({ ...item }));
        this.assumedIncome = data.assumedIncome || 3500;
        const totalBudgetedSpending = this.spendingData.reduce((sum, item) => sum + item.total, 0);
        this.unallocatedData = { id: 'unallocated', label: 'Unallocated', total: Math.max(this.assumedIncome - totalBudgetedSpending, 0), color: '#64748b' };
        this.sliderValue = this.currentDayOfMonth;
        this.prepareData();
        this.initializePositions();
        this.drawScene();
        this.resize();
    }
    resize() {
        const rect = this.container.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        this.canvas.width = rect.width * ratio;
        this.canvas.height = rect.height * ratio;
        this.ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        this.drawScene();
    }
    prepareData() {
        const createSnapshots = (items, key) => {
            return items.map(item => ({
                id: item.id,
                total: item.total,
                final: item[key],
                transactions: (item.timeline || []).map(point => ({ day: point.day, amount: point.amount }))
            }));
        };
        this.spendingSnapshots = createSnapshots(this.spendingData, 'finalSpent');
        this.savingsSnapshots = createSnapshots(this.savingsData, 'finalSaved');
        const totalDays = this.currentDayOfMonth;
        this.dailySnapshots = [];
        for (let day = 1; day <= totalDays; day++) {
            const spending = this.spendingSnapshots.map(item => {
                const spent = item.transactions.filter(t => t.day <= day).reduce((sum, t) => sum + t.amount, 0);
                return { id: item.id, spent };
            });
            const savings = this.savingsSnapshots.map(item => {
                const saved = item.transactions.filter(t => t.day <= day).reduce((sum, t) => sum + t.amount, 0);
                return { id: item.id, saved };
            });
            this.dailySnapshots.push({ day, spending, savings });
        }
    }
    initializePositions() {
        const rect = this.canvas.getBoundingClientRect();
        const width = rect.width;
        const padding = 32;
        const isTwoColumn = width > 720;
        const colGap = 36;
        const colWidth = isTwoColumn ? (width - padding * 2 - colGap) / 2 : width - padding * 2;
        const col1X = padding;
        const col2X = isTwoColumn ? col1X + colWidth + colGap : col1X;
        const layout = (items, startX, startY) => {
            const perRow = 3;
            const itemWidth = 96;
            const itemHeight = 180;
            const gapX = (colWidth - perRow * itemWidth) / (perRow - 1 || 1);
            const gapY = 50;
            items.forEach((item, idx) => {
                if (!item.x) {
                    const row = Math.floor(idx / perRow);
                    const col = idx % perRow;
                    item.x = startX + col * (itemWidth + gapX);
                    item.y = startY + row * (itemHeight + gapY);
                }
            });
        };
        layout(this.spendingData, col1X, padding + 120);
        layout([this.unallocatedData], col1X, padding + 360);
        layout(this.savingsData, col2X, padding + 120);
    }
    addEventListeners() {
        this.canvas.addEventListener('mousedown', e => this.startPan(e));
        this.canvas.addEventListener('mousemove', e => this.onMove(e));
        this.canvas.addEventListener('mouseup', () => this.endPan());
        this.canvas.addEventListener('mouseleave', () => this.endPan());
        this.canvas.addEventListener('wheel', e => this.onWheel(e));
        this.canvas.addEventListener('touchstart', e => this.startTouch(e));
        this.canvas.addEventListener('touchmove', e => this.moveTouch(e));
        this.canvas.addEventListener('touchend', () => this.endPan());
    }
    toCanvasCoords(e) {
        const rect = this.canvas.getBoundingClientRect();
        return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
    }
    startPan(e) {
        const pos = this.toCanvasCoords(e);
        if (this.isPointInSlider(pos)) {
            this.isDraggingSlider = true;
            this.updateSliderFromPosition(pos);
            return;
        }
        this.isPanning = true;
        this.lastX = pos.x;
        this.lastY = pos.y;
    }
    onMove(e) {
        const pos = this.toCanvasCoords(e);
        if (this.isDraggingSlider) {
            this.updateSliderFromPosition(pos);
            return;
        }
        if (!this.isPanning) return;
        const dx = pos.x - this.lastX;
        const dy = pos.y - this.lastY;
        this.offsetX += dx;
        this.offsetY += dy;
        this.lastX = pos.x;
        this.lastY = pos.y;
        this.drawScene();
    }
    endPan() {
        this.isPanning = false;
        this.isDraggingSlider = false;
    }
    onWheel(e) {
        e.preventDefault();
        const delta = Math.sign(e.deltaY) * -0.1;
        this.scale = Math.min(Math.max(this.scale + delta, 0.6), 1.5);
        this.drawScene();
    }
    startTouch(e) {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            const pos = this.toCanvasCoords(touch);
            if (this.isPointInSlider(pos)) {
                this.isDraggingSlider = true;
                this.updateSliderFromPosition(pos);
            } else {
                this.isPanning = true;
                this.lastX = pos.x;
                this.lastY = pos.y;
            }
        }
    }
    moveTouch(e) {
        if (e.touches.length !== 1) return;
        const touch = e.touches[0];
        const pos = this.toCanvasCoords(touch);
        if (this.isDraggingSlider) {
            this.updateSliderFromPosition(pos);
            return;
        }
        if (!this.isPanning) return;
        const dx = pos.x - this.lastX;
        const dy = pos.y - this.lastY;
        this.offsetX += dx;
        this.offsetY += dy;
        this.lastX = pos.x;
        this.lastY = pos.y;
        this.drawScene();
    }
    isPointInSlider(pos) {
        const { x, y, width, height } = this.sliderBounds;
        return pos.x >= x && pos.x <= x + width && pos.y >= y && pos.y <= y + height;
    }
    updateSliderFromPosition(pos) {
        const { x, width } = this.sliderBounds;
        const ratio = Math.min(Math.max((pos.x - x) / width, 0), 1);
        this.sliderValue = 1 + ratio * (this.currentDayOfMonth - 1);
        this.drawScene();
        AppState.emit('timeline:day', Math.round(this.sliderValue));
    }
    drawScene() {
        const ctx = this.ctx;
        const rect = this.canvas.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;
        ctx.clearRect(0, 0, width, height);
        ctx.save();
        ctx.translate(this.offsetX, this.offsetY);
        ctx.scale(this.scale, this.scale);
        const headerHeight = 100;
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(-this.offsetX, -this.offsetY, width / this.scale, headerHeight);
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '14px Inter';
        ctx.fillText('Timeline overview', 24 - this.offsetX, 32 - this.offsetY);
        ctx.font = '24px Inter';
        ctx.fillStyle = '#f8fafc';
        ctx.fillText('Monthly spending & savings', 24 - this.offsetX, 68 - this.offsetY);
        const sliderY = headerHeight + 20;
        const sliderX = 24 - this.offsetX;
        const sliderWidth = width / this.scale - 48;
        const sliderHeight = 12;
        this.sliderBounds = { x: sliderX, y: sliderY, width: sliderWidth, height: sliderHeight + 20 };
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(sliderX, sliderY, sliderWidth, sliderHeight);
        const ratio = (this.sliderValue - 1) / (this.currentDayOfMonth - 1 || 1);
        const thumbX = sliderX + ratio * sliderWidth;
        const gradient = ctx.createLinearGradient(sliderX, sliderY, sliderX + sliderWidth, sliderY);
        gradient.addColorStop(0, '#6366f1');
        gradient.addColorStop(1, '#f472b6');
        ctx.fillStyle = gradient;
        ctx.fillRect(sliderX, sliderY, thumbX - sliderX, sliderHeight);
        ctx.beginPath();
        ctx.arc(thumbX, sliderY + sliderHeight / 2, 10, 0, Math.PI * 2);
        ctx.fillStyle = '#f1f5f9';
        ctx.fill();
        ctx.fillStyle = '#0f172a';
        ctx.font = '12px Inter';
        ctx.fillText(`Day ${Math.round(this.sliderValue)}`, thumbX - 16, sliderY + 40);
        ctx.restore();
    }
}
function buildTimelineData() {
    const spendingData = AppState.budgets.parents.map(parent => {
        const palette = categoryPalette[parent.paletteIndex % categoryPalette.length];
        return {
            id: parent.id,
            label: parent.name,
            total: parent.budget,
            finalSpent: parent.spent,
            color: palette.color,
            timeline: parent.subcategories.map((sub, idx) => ({ day: Math.min(idx * 3 + 1, 28), amount: sub.spent / 2 || 0 }))
        };
    });
    const savingsData = AppState.savings.map(goal => {
        const palette = categoryPalette[goal.paletteIndex % categoryPalette.length];
        return {
            id: goal.id,
            label: goal.name,
            total: goal.total,
            finalSaved: goal.current,
            color: palette.color,
            timeline: [{ day: 5, amount: goal.current * 0.3 }, { day: 15, amount: goal.current * 0.5 }, { day: 22, amount: goal.current * 0.2 }]
        };
    });
    return { spendingData, savingsData, assumedIncome: AppState.accounts.reduce((sum, acct) => sum + Math.max(acct.balance, 0), 0) };
}
function renderBudgetSection() {
    recalcBudgets();
    const budgetList = document.getElementById('budget-list');
    const mobileBudgetList = document.getElementById('mobile-budget-list');
    if (budgetList) budgetList.innerHTML = '';
    if (mobileBudgetList) mobileBudgetList.innerHTML = '';
    AppState.budgets.parents.forEach(parent => {
        if (budgetList) createCategoryCard(parent, budgetList);
        if (mobileBudgetList) createCategoryCard(parent, mobileBudgetList);
    });
    const pureList = document.getElementById('pure-savings-list');
    const goalsList = document.getElementById('goals-list');
    if (pureList) pureList.innerHTML = '';
    if (goalsList) goalsList.innerHTML = '';
    AppState.savings.forEach(saving => {
        const palette = categoryPalette[saving.paletteIndex % categoryPalette.length];
        const el = document.createElement('div');
        el.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';
        el.innerHTML = `<div class="flex items-center justify-between"><div><p class="text-base font-semibold text-slate-900">${saving.name}</p><p class="text-xs text-slate-500">Target ${formatCurrency(saving.total)}</p></div><p class="text-lg font-semibold text-slate-900">${formatCurrency(saving.current)}</p></div>`;
        const bar = document.createElement('div');
        bar.className = 'bar-chart mt-3';
        bar.style.setProperty('--spent-gradient', palette.spentGradient);
        bar.style.setProperty('--budget-gradient', palette.budgetGradient);
        const ratio = saving.total ? Math.min(saving.current / saving.total, 1) : 0;
        const budgetFill = document.createElement('div');
        budgetFill.className = 'budgeted-bar';
        const spentFill = document.createElement('div');
        spentFill.className = 'spent-bar';
        spentFill.style.transform = `scaleX(${ratio})`;
        bar.appendChild(budgetFill);
        bar.appendChild(spentFill);
        pureList?.appendChild(el);
    });
    AppState.goals.forEach(goal => {
        const palette = categoryPalette[goal.paletteIndex % categoryPalette.length];
        const el = document.createElement('div');
        el.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';
        el.innerHTML = `<div class="flex items-center justify-between"><div><p class="text-base font-semibold text-slate-900">${goal.name}</p><p class="text-xs text-slate-500">Due ${goal.due}</p></div><p class="text-lg font-semibold text-slate-900">${formatCurrency(goal.current)} / ${formatCurrency(goal.total)}</p></div>`;
        const bar = document.createElement('div');
        bar.className = 'bar-chart mt-3';
        bar.style.setProperty('--spent-gradient', palette.spentGradient);
        bar.style.setProperty('--budget-gradient', palette.budgetGradient);
        const ratio = goal.total ? Math.min(goal.current / goal.total, 1) : 0;
        const budgetFill = document.createElement('div');
        budgetFill.className = 'budgeted-bar';
        const spentFill = document.createElement('div');
        spentFill.className = 'spent-bar';
        spentFill.style.transform = `scaleX(${ratio})`;
        bar.appendChild(budgetFill);
        bar.appendChild(spentFill);
        goalsList?.appendChild(el);
    });
    const timelineData = buildTimelineData();
    if (document.getElementById('budget-timeline')) {
        if (!desktopTimeline) desktopTimeline = new FinancialCanvas('budget-timeline', timelineData);
        else desktopTimeline.updateData(timelineData);
    }
    if (document.getElementById('mobile-budget-timeline')) {
        if (!mobileTimeline) mobileTimeline = new FinancialCanvas('mobile-budget-timeline', timelineData);
        else mobileTimeline.updateData(timelineData);
    }
}
function renderAccounts() {
    const list = document.getElementById('accounts-list');
    const mobileList = document.getElementById('mobile-accounts-list');
    if (list) list.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';
    const renderAccountCard = target => account => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';
        card.innerHTML = `<div class="flex items-center justify-between"><p class="text-base font-semibold text-slate-900">${account.name}</p><p class="text-lg font-semibold ${account.balance >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${formatCurrency(account.balance)}</p></div>`;
        const ul = document.createElement('ul');
        ul.className = 'mt-3 space-y-2';
        AppState.budgets.parents.forEach(parent => {
            parent.subcategories.forEach(sub => {
                const remaining = sub.budget - sub.spent;
                const item = document.createElement('li');
                item.className = 'flex items-center justify-between text-sm text-slate-600';
                item.innerHTML = `<span>${sub.name}</span><span class="font-semibold ${remaining >= 0 ? 'text-emerald-500' : 'text-rose-500'}">${formatCurrency(remaining)}</span>`;
                ul.appendChild(item);
            });
        });
        card.appendChild(ul);
        target.appendChild(card);
    };
    if (list) AppState.accounts.forEach(renderAccountCard(list));
    if (mobileList) AppState.accounts.forEach(renderAccountCard(mobileList));
}
function renderTransactions() {
    const list = document.getElementById('transactions-list');
    const mobileList = document.getElementById('mobile-transactions-list');
    if (list) list.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';
    const renderItem = target => txn => {
        const item = document.createElement('div');
        item.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm';
        item.innerHTML = `<div class="flex items-center justify-between"><div><p class="font-semibold text-slate-900">${txn.name}</p><p class="text-xs text-slate-500">${new Date(txn.date).toLocaleDateString()}</p></div><p class="text-base font-semibold ${txn.amount < 0 ? 'text-rose-500' : 'text-emerald-500'}">${formatCurrency(txn.amount)}</p></div>`;
        const controlRow = document.createElement('div');
        controlRow.className = 'mt-3 flex items-center gap-3';
        const select = document.createElement('select');
        select.className = 'flex-1 px-3 py-2 rounded-xl border border-slate-200 text-sm';
        select.innerHTML = `<option value="">${txn.category ? 'Change sub-category' : 'Assign sub-category'}</option>`;
        AppState.budgets.parents.forEach(parent => {
            parent.subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `${parent.name} / ${sub.name}`;
                if (txn.category === sub.id) option.selected = true;
                select.appendChild(option);
            });
        });
        select.addEventListener('change', () => {
            if (select.value === '') return;
            txn.category = select.value;
            AppState.emit('transactions:updated');
        });
        const createBtn = document.createElement('button');
        createBtn.className = 'icon-button p-2 rounded-full bg-indigo-50 text-indigo-600';
        createBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
        createBtn.addEventListener('click', () => openCategoryModal({ transactionId: txn.id }));
        controlRow.appendChild(select);
        controlRow.appendChild(createBtn);
        item.appendChild(controlRow);
        target.appendChild(item);
    };
    if (list) AppState.transactions.forEach(renderItem(list));
    if (mobileList) AppState.transactions.forEach(renderItem(mobileList));
    const assetsDisplay = document.getElementById('assets-display');
    const totalSpentDisplay = document.getElementById('total-spent');
    const assets = AppState.accounts.reduce((sum, acct) => sum + acct.balance, 0);
    const spent = AppState.transactions.filter(txn => txn.amount < 0).reduce((sum, txn) => sum + Math.abs(txn.amount), 0);
    if (assetsDisplay) assetsDisplay.textContent = formatCurrency(assets);
    if (totalSpentDisplay) totalSpentDisplay.textContent = formatCurrency(spent);
    if (AppState.plaidConnected) {
        document.getElementById('demo-data-btn')?.classList.add('hidden');
        document.querySelector('[data-action="demo"]')?.classList.add('hidden');
    }
}
function generateDemoTransactions() {
    const transactionCount = 210;
    const merchants = [
        { name: 'Bluegrass Grill', type: 'restaurant', category: 'dining-out' },
        { name: 'Goodman Coffee', type: 'restaurant', category: 'coffee' },
        { name: 'Public House', type: 'restaurant', category: 'dining-out' },
        { name: 'City Cafe Diner', type: 'restaurant', category: 'dining-out' },
        { name: 'Whole Foods Market', type: 'grocery-or-supermarket', category: 'groceries' },
        { name: 'Publix Chattanooga', type: 'grocery-or-supermarket', category: 'groceries' },
        { name: 'Food City #122', type: 'grocery-or-supermarket', category: 'groceries' },
        { name: 'Chatt Smokehouse', type: 'restaurant', category: 'dining-out' },
        { name: 'Signal Mountain Coffee', type: 'restaurant', category: 'coffee' },
        { name: 'EPB Fiber Optics', type: 'bank', category: 'utilities' },
        { name: 'Chattanooga Gas', type: 'bank', category: 'utilities' },
        { name: 'Chattanooga Transit', type: 'bus-station', category: 'rideshare' },
        { name: 'Downtown Parking Garage', type: 'bus-station', category: 'parking' },
        { name: 'Pilates of Chattanooga', type: 'restaurant', category: 'fitness' },
        { name: 'REI Co-op Chattanooga', type: 'electronics-store', category: 'shopping' },
        { name: 'Warehouse Row Shops', type: 'electronics-store', category: 'shopping' },
        { name: 'Tivoli Theatre', type: 'restaurant', category: 'entertainment' },
        { name: 'Songbirds Guitar Museum', type: 'restaurant', category: 'entertainment' },
        { name: 'Chattanooga Climbing Center', type: 'restaurant', category: 'fitness' },
        { name: 'Lyft Chattanooga', type: 'bus-station', category: 'rideshare' },
        { name: 'Shell Brainerd Rd', type: 'bus-station', category: 'fuel' },
        { name: 'Mapco Market St', type: 'bus-station', category: 'fuel' }
    ];
    const now = new Date();
    const transactions = [];
    for (let i = 0; i < transactionCount; i++) {
        const merchant = merchants[Math.floor(Math.random() * merchants.length)];
        const daysAgo = Math.floor(Math.random() * 28);
        const date = new Date(now);
        date.setDate(now.getDate() - daysAgo);
        const amount = -(Math.random() * 90 + 10).toFixed(2);
        transactions.push({
            id: `demo-${i}`,
            name: merchant.name,
            amount: Number(amount),
            type: 'debit',
            date: date.toISOString(),
            category: merchant.category,
            placeType: merchant.type
        });
    }
    return transactions;
}
function handleDemoData() {
    AppState.transactions = generateDemoTransactions();
    AppState.placeAssignments = {};
    AppState.manualPlaces = [];
    AppState.emit('transactions:updated');
    AppState.emit('map:refresh');
}
function mockPlaidFlow() {
    AppState.plaidConnected = true;
    document.getElementById('demo-data-btn')?.classList.add('hidden');
    document.querySelector('[data-action="demo"]')?.classList.add('hidden');
    alert('Plaid connection simulated.');
}
function openCategoryModal({ parentId = '', transactionId = '', placeId = '' } = {}) {
    const modal = document.getElementById('category-modal');
    const form = document.getElementById('category-form');
    const parentSelect = form.querySelector('select[name="parent"]');
    parentSelect.innerHTML = '<option value="">New parent category</option>';
    AppState.budgets.parents.forEach(parent => {
        const option = document.createElement('option');
        option.value = parent.id;
        option.textContent = parent.name;
        if (parent.id === parentId) option.selected = true;
        parentSelect.appendChild(option);
    });
    form.dataset.transactionId = transactionId;
    form.dataset.placeId = placeId;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
function closeModal(modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (modal.id === 'transaction-modal') {
        const form = document.getElementById('transaction-category-form');
        form.dataset.context = '';
        activePlaceId = null;
    } else if (modal.id === 'category-modal') {
        const form = document.getElementById('category-form');
        form.dataset.transactionId = '';
        form.dataset.placeId = '';
    }
}
function initCategoryModal() {
    const modal = document.getElementById('category-modal');
    modal.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(modal); });
    const form = document.getElementById('category-form');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const data = new FormData(form);
        const name = data.get('name');
        const parent = data.get('parent');
        const budget = parseFloat(data.get('budget'));
        let subcategory;
        if (!parent) {
            const newParent = addParentCategory(name, budget);
            subcategory = addSubcategory(newParent.id, { name: `${name} - general`, budget });
        } else {
            subcategory = addSubcategory(parent, { name, budget });
        }
        AppState.emit('budgets:updated');
        const txnId = form.dataset.transactionId;
        const placeId = form.dataset.placeId;
        if (txnId) {
            const txn = AppState.transactions.find(t => t.id == txnId);
            if (txn && subcategory) {
                txn.category = subcategory.id;
                AppState.emit('transactions:updated');
            }
        }
        if (placeId && subcategory) {
            AppState.placeAssignments[placeId] = subcategory.id;
            const place = AppState.places.find(p => p.id === placeId);
            const found = findSubcategory(subcategory.id);
            if (place && found) place.parent = found.parent;
            AppState.emit('map:refresh');
        }
        form.reset();
        form.dataset.transactionId = '';
        form.dataset.placeId = '';
        closeModal(modal);
    });
}
function initTransactionModal() {
    const modal = document.getElementById('transaction-modal');
    modal.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(modal); });
    const form = document.getElementById('transaction-category-form');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const subId = form.querySelector('select[name="subcategory"]').value;
        const context = form.dataset.context;
        if (context === 'place' && activePlaceId) {
            AppState.placeAssignments[activePlaceId] = subId;
            const found = findSubcategory(subId);
            const place = AppState.places.find(p => p.id === activePlaceId);
            if (place && found) place.parent = found.parent;
            AppState.emit('map:refresh');
        } else {
            const txnId = form.querySelector('input[name="transactionId"]').value;
            const txn = AppState.transactions.find(t => t.id == txnId);
            if (txn) {
                txn.category = subId;
                AppState.emit('transactions:updated');
            }
        }
        closeModal(modal);
    });
}
function renderTransactionModalOptions() {
    const form = document.getElementById('transaction-category-form');
    const select = form.querySelector('select[name="subcategory"]');
    select.innerHTML = '';
    AppState.budgets.parents.forEach(parent => {
        parent.subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = `${parent.name} / ${sub.name}`;
            select.appendChild(option);
        });
    });
}
function openPlaceAssignment(place) {
    activePlaceId = place.id;
    renderTransactionModalOptions();
    const modal = document.getElementById('transaction-modal');
    const form = document.getElementById('transaction-category-form');
    form.dataset.context = 'place';
    form.querySelector('input[name="transactionId"]').value = '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
function initNav() {
    const navBtns = document.querySelectorAll('.nav-btn');
    navBtns.forEach(btn => btn.addEventListener('click', () => {
        navBtns.forEach(b => b.classList.remove('active', 'text-indigo-600', 'bg-indigo-100'));
        btn.classList.add('active', 'text-indigo-600', 'bg-indigo-100');
        document.querySelectorAll('.sidebar-view').forEach(view => view.classList.add('hidden'));
        const viewId = btn.dataset.view;
        document.getElementById(viewId).classList.remove('hidden');
    }));
    const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
    mobileNavBtns.forEach(btn => btn.addEventListener('click', () => {
        mobileNavBtns.forEach(b => b.classList.remove('active', 'text-indigo-600', 'bg-indigo-100'));
        btn.classList.add('active', 'text-indigo-600', 'bg-indigo-100');
        document.querySelectorAll('.mobile-view').forEach(view => view.classList.add('hidden'));
        const target = document.getElementById(btn.dataset.target);
        target.classList.remove('hidden');
    }));
}
function initActions() {
    document.querySelectorAll('[data-trigger="category"]').forEach(btn => btn.addEventListener('click', () => openCategoryModal()));
    document.getElementById('open-category-modal').addEventListener('click', () => openCategoryModal());
    document.getElementById('demo-data-btn').addEventListener('click', handleDemoData);
    document.getElementById('plaid-btn').addEventListener('click', () => { mockPlaidFlow(); handleDemoData(); });
    document.querySelector('[data-action="demo"]').addEventListener('click', handleDemoData);
    document.querySelector('[data-action="plaid"]').addEventListener('click', () => { mockPlaidFlow(); handleDemoData(); });
}
function renderCategoryFilters() {
    const filters = [
        { id: 'all', label: 'All' },
        { id: 'restaurant', label: 'Dining' },
        { id: 'grocery-or-supermarket', label: 'Groceries' },
        { id: 'electronics-store', label: 'Shopping' },
        { id: 'bus-station', label: 'Transit' },
        { id: 'bank', label: 'Finance' }
    ];
    const container = document.getElementById('category-filters-container');
    const mobileContainer = document.getElementById('mobile-category-filters');
    container.innerHTML = '';
    mobileContainer.innerHTML = '';
    filters.forEach(filter => {
        const btn = document.createElement('button');
        btn.className = 'icon-pill flex items-center gap-2 px-3 py-2 text-sm text-slate-600';
        btn.dataset.filter = filter.id;
        btn.innerHTML = `<span>${filter.label}</span>`;
        btn.addEventListener('click', () => {
            AppState.activePlaceType = filter.id;
            AppState.emit('map:refresh');
        });
        const desktopBtn = btn.cloneNode(true);
        desktopBtn.addEventListener('click', () => {
            AppState.activePlaceType = filter.id;
            renderCategoryFilters();
            AppState.emit('map:refresh');
        });
        if (filter.id === AppState.activePlaceType) {
            desktopBtn.classList.add('bg-indigo-100', 'text-indigo-600');
        }
        container.appendChild(desktopBtn);
        const mobileBtn = btn.cloneNode(true);
        mobileBtn.addEventListener('click', () => {
            AppState.activePlaceType = filter.id;
            renderCategoryFilters();
            AppState.emit('map:refresh');
        });
        if (filter.id === AppState.activePlaceType) {
            mobileBtn.classList.add('bg-indigo-100', 'text-indigo-600');
        }
        mobileContainer.appendChild(mobileBtn);
    });
}
function renderPlaceCards() {
    const desktopList = document.getElementById('place-results');
    const mobileList = document.getElementById('mobile-place-results');
    if (desktopList) desktopList.innerHTML = '';
    if (mobileList) mobileList.innerHTML = '';
    const renderCard = target => place => {
        const card = document.createElement('div');
        card.className = 'place-card min-w-[220px]';
        const paletteColor = place.parent ? categoryPalette[place.parent.paletteIndex % categoryPalette.length].color : '#22c55e';
        card.style.border = `1px solid ${paletteColor}22`;
        const iconPath = placeTypeIcons[place.type] || placeTypeIcons.default;
        card.innerHTML = `<div class="flex items-start gap-3"><span class="flex items-center justify-center w-10 h-10 rounded-full bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5" fill="${paletteColor}" stroke="none"><path d="${iconPath}"/></svg></span><div><p class="text-sm font-semibold text-slate-900">${place.name}</p><p class="text-xs text-slate-500">${place.address || 'Chattanooga, TN'}</p></div></div>`;
        const assignment = AppState.placeAssignments[place.id];
        if (assignment) {
            const found = findSubcategory(assignment);
            if (found) {
                const badge = document.createElement('span');
                badge.className = 'inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-600';
                badge.textContent = `${found.parent.name} / ${found.subcategory.name}`;
                card.appendChild(badge);
            }
        }
        const actions = document.createElement('div');
        actions.className = 'place-card-actions';
        const addBtn = document.createElement('button');
        addBtn.className = 'place-icon-button';
        addBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>';
        addBtn.title = 'Assign to sub-category';
        addBtn.addEventListener('click', () => openPlaceAssignment(place));
        const createBtn = document.createElement('button');
        createBtn.className = 'place-icon-button';
        createBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/><path d="M5 5h14v14H5z" opacity="0.3"/></svg>';
        createBtn.title = 'Create sub-category';
        createBtn.addEventListener('click', () => openCategoryModal({ placeId: place.id }));
        actions.appendChild(addBtn);
        actions.appendChild(createBtn);
        card.appendChild(actions);
        target.appendChild(card);
    };
    const places = AppState.places.filter(place => AppState.activePlaceType === 'all' || place.type === AppState.activePlaceType);
    places.slice(0, 6).forEach(place => {
        if (desktopList) renderCard(desktopList)(place);
        if (mobileList) renderCard(mobileList)(place);
    });
}
let mapInstance;
let mobileMapInstance;
let mapMarkers = [];
function clearMarkers(map) {
    mapMarkers = mapMarkers.filter(markerObj => {
        if (markerObj.map === map) {
            markerObj.marker.remove();
            return false;
        }
        return true;
    });
}
function createSvgIcon(color, type) {
    const path = placeTypeIcons[type] || placeTypeIcons.default;
    return L.divIcon({
        className: '',
        html: `<svg class="pin-shadow" width="38" height="48" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 31c-3-5-9-10-9-16a9 9 0 1 1 18 0c0 6-6 11-9 16z" fill="url(#grad)" stroke="white" stroke-width="2"/><defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="${color}"/><stop offset="100%" stop-color="${color}" stop-opacity="0.7"/></linearGradient></defs><path d="${path}" fill="white" transform="translate(4 5) scale(0.6)"/></svg>`,
        iconSize: [38, 48],
        iconAnchor: [19, 46]
    });
}
function addMarker(map, place) {
    const palette = place.parent ? categoryPalette[place.parent.paletteIndex % categoryPalette.length] : { color: '#22c55e' };
    const icon = createSvgIcon(palette.color, place.type || 'default');
    const marker = L.marker([place.lat, place.lng], { icon }).addTo(map);
    marker.bindPopup(`<strong>${place.name}</strong><br>${place.address || ''}`);
    mapMarkers.push({ map, marker });
}
function refreshMap(map) {
    clearMarkers(map);
    const active = AppState.activePlaceType;
    AppState.places.filter(place => active === 'all' || place.type === active).forEach(place => addMarker(map, place));
}
function setupMap(mapId) {
    const map = L.map(mapId, { zoomControl: false }).setView([35.0456, -85.3097], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    return map;
}
async function searchPlaces(query) {
    if (!query) return [];
    const url = new URL('https://discover.search.hereapi.com/v1/discover');
    url.searchParams.set('apikey', HERE_API_KEY);
    url.searchParams.set('q', query);
    url.searchParams.set('at', '35.0456,-85.3097');
    const response = await fetch(url);
    const data = await response.json();
    return (data.items || []).map(item => ({
        id: item.id,
        name: item.title,
        lat: item.position.lat,
        lng: item.position.lng,
        type: normalizePlaceType(item.categories?.[0]?.id || item.categories?.[0]?.name || ''),
        address: item.address?.label,
        hereCategories: item.categories || []
    }));
}
function mapPlaceToBudget(place) {
    for (const parent of AppState.budgets.parents) {
        const sub = parent.subcategories.find(s => place.category && place.category.includes(s.id));
        if (sub) return { parent, sub };
    }
    return null;
}
function updatePlacesFromTransactions() {
    const places = [];
    AppState.transactions.forEach(txn => {
        if (!txn.placeType) return;
        const found = findSubcategory(txn.category || '');
        places.push({
            id: txn.id,
            name: txn.name,
            lat: 35.0456 + (Math.random() - 0.5) * 0.02,
            lng: -85.3097 + (Math.random() - 0.5) * 0.02,
            type: txn.placeType,
            address: 'Chattanooga, TN',
            parent: found?.parent || null
        });
    });
    const combined = [...places, ...AppState.manualPlaces];
    Object.entries(AppState.placeAssignments).forEach(([id, subId]) => {
        const place = combined.find(p => p.id === id);
        const found = findSubcategory(subId);
        if (place && found) place.parent = found.parent;
    });
    AppState.places = combined;
}
function attachSearchHandlers(inputId, map) {
    const input = document.getElementById(inputId);
    if (!input) return;
    const resultsContainer = inputId === 'search-input' ? document.getElementById('autocomplete-results') : null;
    input.addEventListener('input', async () => {
        const results = await searchPlaces(input.value);
        if (resultsContainer) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.toggle('hidden', results.length === 0);
            results.slice(0, 10).forEach(result => {
                const item = document.createElement('button');
                item.className = 'w-full text-left px-4 py-2 hover:bg-slate-100';
                item.textContent = result.name;
                item.addEventListener('click', () => {
                    map.setView([result.lat, result.lng], 15);
                    AppState.manualPlaces = AppState.manualPlaces.filter(p => p.id !== result.id);
                    AppState.manualPlaces.push({ ...result, parent: null });
                    AppState.emit('map:refresh');
                    resultsContainer.classList.add('hidden');
                });
                resultsContainer.appendChild(item);
            });
        }
    });
}
function initResponsive() {
    function updateView() {
        const isMobile = window.innerWidth < 1024;
        document.getElementById('desktop-view').style.display = isMobile ? 'none' : 'flex';
        document.getElementById('mobile-view').style.display = isMobile ? 'flex' : 'none';
        setTimeout(() => {
            desktopTimeline?.resize();
            mobileTimeline?.resize();
        }, 200);
    }
    window.addEventListener('resize', updateView);
    updateView();
}
function initStateListeners() {
    AppState.register('budgets:updated', () => {
        renderBudgetSection();
        renderAccounts();
        renderTransactionModalOptions();
        AppState.emit('map:refresh');
    });
    AppState.register('transactions:updated', () => {
        renderTransactions();
        renderBudgetSection();
        renderAccounts();
        updatePlacesFromTransactions();
        AppState.emit('map:refresh');
    });
    AppState.register('map:refresh', () => {
        updatePlacesFromTransactions();
        if (mapInstance) refreshMap(mapInstance);
        if (mobileMapInstance) refreshMap(mobileMapInstance);
        renderPlaceCards();
    });
}
function initMaps() {
    mapInstance = setupMap('map');
    mobileMapInstance = setupMap('mobile-map');
    attachSearchHandlers('search-input', mapInstance);
    attachSearchHandlers('mobile-search-input', mobileMapInstance);
    AppState.emit('map:refresh');
}
function initApp() {
    seedInitialData();
    initNav();
    initActions();
    initCategoryModal();
    initTransactionModal();
    initStateListeners();
    renderCategoryFilters();
    renderPlaceCards();
    renderBudgetSection();
    renderAccounts();
    renderTransactions();
    renderTransactionModalOptions();
    updatePlacesFromTransactions();
    initMaps();
    initResponsive();
}
window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
