<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Maps - Web</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script src="https://unpkg.com/feather-icons@4.29.0/dist/feather.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .main-container { display: flex; height: 100vh; }
        #map-container { flex-grow: 1; position: relative; }
        #sidebar { width: 450px; flex-shrink: 0; background-color: #ffffff; box-shadow: -5px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        #sidebar-content { flex-grow: 1; overflow-y: auto; }
        .sidebar-view { display: none; }
        .sidebar-view.active { display: block; }
        #map { width: 100%; height: 100%; z-index: 10; }
        .custom-pin { background: linear-gradient(135deg, #22c55e, #15803d); border-radius: 50% 50% 50% 0; transform: rotate(-45deg); width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25); cursor: pointer; transition: transform 0.1s ease-in-out; border: none; }
        .custom-pin:hover { transform: rotate(-45deg) scale(1.05); }
        .custom-pin .pin-inner { transform: rotate(45deg); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .custom-pin .pin-inner svg { width: 20px; height: 20px; }
        .icon-circle { display: inline-flex; align-items: center; justify-content: center; border-radius: 14px; padding: 0.45rem; background: linear-gradient(135deg, #e0f2fe, #3b82f6); box-shadow: inset 0 1px 0 rgba(255,255,255,0.4); }
        .icon-circle svg { width: 20px; height: 20px; stroke-width: 2; }
        .icon-circle.sm { padding: 0.35rem; }
        .icon-circle.lg { padding: 0.6rem; }
        .gradient-text { background: linear-gradient(135deg, #0f172a, #475569); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .place-type-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.55rem 0.85rem; border-radius: 9999px; background-color: rgba(255,255,255,0.92); box-shadow: inset 0 1px 0 rgba(255,255,255,0.55); border: 1px solid rgba(15, 23, 42, 0.08); color: #1f2937; font-weight: 600; transition: all 0.2s ease; backdrop-filter: blur(10px); white-space: nowrap; }
        .place-type-btn svg { width: 18px; height: 18px; stroke-width: 2; }
        .place-type-btn:hover { transform: translateY(-1px); border-color: rgba(59,130,246,0.25); box-shadow: 0 6px 12px rgba(30, 64, 175, 0.12); }
        .place-type-btn.active { background: linear-gradient(135deg, #dbeafe, #60a5fa); color: #1e3a8a; border-color: rgba(59,130,246,0.4); box-shadow: 0 10px 24px rgba(59, 130, 246, 0.25); }
        .place-type-scroll { overflow-x: auto; padding-bottom: 0.2rem; }
        .place-type-scroll::-webkit-scrollbar { height: 6px; }
        .place-type-scroll::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.45); border-radius: 9999px; }
        .map-card-control { position: relative; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(37, 99, 235, 0.25); background: #ffffff; color: #2563eb; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08); }
        .map-card-control svg { width: 18px; height: 18px; }
        .map-card-control:hover { background: #eff6ff; box-shadow: 0 6px 18px rgba(37, 99, 235, 0.2); }
        .map-card-control.primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #ffffff; border-color: transparent; box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35); }
        .map-card-control.primary:hover { background: linear-gradient(135deg, #1d4ed8, #1e40af); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .leaflet-control-attribution { font-size: 11px !important; }
        .nav-btn.active { background-color: #eef2ff; color: #3b82f6; }
        .keypad-btn:active { background-color: #dbeafe; }
        /* Scrollbar styles */
        #sidebar-content::-webkit-scrollbar, .category-filters::-webkit-scrollbar, #autocomplete-results::-webkit-scrollbar { width: 4px; height: 4px; }
        #sidebar-content::-webkit-scrollbar-thumb, .category-filters::-webkit-scrollbar-thumb, #autocomplete-results::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sankey-link { fill: none; stroke-opacity: 0.3; } .sankey-link:hover { stroke-opacity: 0.6; } .sankey-node rect { stroke: #fff; stroke-width: 2px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="map-container">
            <div id="map"></div>
            <div class="absolute top-0 left-0 right-0 p-4 z-20 space-y-2">
                <div class="max-w-xl mx-auto">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search city, state, or business..." class="w-full pl-10 pr-12 py-3 bg-white rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        <div class="absolute top-1/2 left-3 -translate-y-1/2 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <button id="search-submit" class="absolute top-1/2 right-3 -translate-y-1/2 bg-blue-600 text-white rounded-full p-2 shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Search places">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        </button>
                        <div id="autocomplete-results" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg z-30 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
                    </div>
                    <div id="category-filters-container" class="category-filters place-type-scroll flex items-center space-x-2 overflow-x-auto p-2 bg-white/80 backdrop-blur-sm rounded-xl mt-2 shadow-md"></div>
                </div>
            </div>
            <div id="map-loader" class="absolute inset-0 bg-white/50 z-30 items-center justify-center hidden"><div class="loader"></div></div>
        </div>

        <div id="sidebar">
            <div class="p-4 border-b">
                <h1 class="text-2xl font-bold text-gray-900">Money Maps</h1>
            </div>
            <div id="sidebar-nav" class="grid grid-cols-2 gap-2 p-2 border-b bg-gray-50">
                <button class="nav-btn active flex items-center justify-center p-2 rounded-lg font-semibold text-sm" data-view="budget-view"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" x2="12" y1="20" y2="10"></line><line x1="18" x2="18" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="16"></line></svg>Budget</button>
                <button class="nav-btn flex items-center justify-center p-2 rounded-lg font-semibold text-gray-600 text-sm" data-view="transactions-view"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>History</button>
            </div>

            <div id="sidebar-content">
                <!-- Budget View -->
                <div id="budget-view" class="sidebar-view active p-4">
                    <div id="sankey-hero-container" class="mt-2 p-2 h-48 cursor-pointer flex items-center justify-center bg-gray-50 rounded-xl"><svg id="sankey-hero" class="w-full h-full"></svg></div>
                    <h2 class="text-xl font-bold text-gray-800 px-2 mt-6 flex justify-between items-center"><span>Fund Flows</span></h2>
                    <div id="budget-list" class="mt-2 space-y-3 px-2"></div>
                    <h2 class="text-xl font-bold text-gray-800 px-2 mt-8">Pure Savings</h2>
                    <div id="pure-savings-list" class="mt-2 space-y-3 px-2"></div>
                    <h2 class="text-xl font-bold text-gray-800 px-2 mt-8 flex justify-between items-center"><span>Time Targets</span></h2>
                    <div id="goals-list" class="mt-2 space-y-3 px-2 pb-4"></div>
                </div>

                <!-- Transactions View -->
                <div id="transactions-view" class="sidebar-view">
                     <div class="p-4 bg-white border-b sticky top-0">
                        <div class="flex justify-between items-end mt-2">
                            <div><p class="text-sm text-gray-500">Assets</p><p id="assets-display" class="text-2xl font-bold text-green-600"></p></div>
                             <div class="text-right"><p class="text-sm text-gray-500">Total Spent</p><p id="total-spent" class="text-2xl font-bold text-red-600"></p></div>
                        </div>
                    </div>
                    <div id="transactions-list" class="p-4 space-y-3"></div>
                </div>

                <!-- Place Detail View -->
                <div id="place-detail-view" class="sidebar-view"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="sankey-modal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 hidden items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col overflow-hidden">
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">Savings &amp; Time Targets Flow</h2>
                <button id="sankey-modal-close" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Close Sankey details">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
            </div>
            <div class="flex-1 overflow-hidden p-4">
                <div id="sankey-expanded-wrapper" class="w-full h-full min-h-[320px]">
                    <svg id="sankey-expanded" class="w-full h-full"></svg>
                </div>
            </div>
            <div id="sankey-details" class="px-6 py-4 border-t bg-gray-50 overflow-y-auto max-h-72 text-sm text-gray-700"></div>
        </div>
    </div>
    <div id="log-purchase-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-50 hidden items-center justify-center"></div>
    <div id="add-category-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>

    <script>
        // --- API & DATA CONFIG ---

        const HERE_API_KEY = '6iHV0y797UXNMW3TZlJX6gXy67xGh2uEIX77Q7tHdjU';

        const STORAGE_KEYS = {
            budget: 'mm_budget_categories_v2',
            places: 'mm_categorized_places_v2'
        };

        const paletteCatalog = [
            { id: 'azure', start: '#60a5fa', end: '#2563eb' },
            { id: 'emerald', start: '#86efac', end: '#22c55e' },
            { id: 'sunset', start: '#fcd34d', end: '#f97316' },
            { id: 'violet', start: '#c4b5fd', end: '#7c3aed' },
            { id: 'rose', start: '#fda4af', end: '#ec4899' },
            { id: 'teal', start: '#5eead4', end: '#14b8a6' },
            { id: 'slate', start: '#cbd5f5', end: '#6366f1' }
        ];

        const defaultBudgetCategories = {
            'living-essentials': {
                id: 'living-essentials',
                name: 'Living Essentials',
                icon: 'home',
                palette: paletteCatalog[0],
                subcategories: {
                    'groceries': { id: 'groceries', name: 'Groceries', budgeted: 500, icon: 'shopping-cart' },
                    'utilities': { id: 'utilities', name: 'Utilities', budgeted: 200, icon: 'zap' },
                    'home-improvement': { id: 'home-improvement', name: 'Home Projects', budgeted: 250, icon: 'tool' }
                }
            },
            'mobility-travel': {
                id: 'mobility-travel',
                name: 'Mobility & Travel',
                icon: 'navigation',
                palette: paletteCatalog[2],
                subcategories: {
                    'transportation': { id: 'transportation', name: 'Fuel & Transit', budgeted: 150, icon: 'truck' }
                }
            },
            'lifestyle-leisure': {
                id: 'lifestyle-leisure',
                name: 'Lifestyle & Leisure',
                icon: 'smile',
                palette: paletteCatalog[4],
                subcategories: {
                    'dining-out': { id: 'dining-out', name: 'Dining Out', budgeted: 250, icon: 'coffee' },
                    'shopping': { id: 'shopping', name: 'Shopping', budgeted: 200, icon: 'shopping-bag' },
                    'entertainment': { id: 'entertainment', name: 'Entertainment', budgeted: 150, icon: 'film' }
                }
            },
            'wellness': {
                id: 'wellness',
                name: 'Wellness',
                icon: 'heart',
                palette: paletteCatalog[1],
                subcategories: {
                    'health': { id: 'health', name: 'Health', budgeted: 100, icon: 'activity' },
                    'fitness': { id: 'fitness', name: 'Fitness', budgeted: 50, icon: 'heart' }
                }
            },
            'financial': {
                id: 'financial',
                name: 'Financial Ops',
                icon: 'briefcase',
                palette: paletteCatalog[6],
                subcategories: {
                    'income': { id: 'income', name: 'Income', budgeted: 0, icon: 'trending-up' },
                    'transfers': { id: 'transfers', name: 'Transfers', budgeted: 0, icon: 'refresh-cw' }
                }
            }
        };

        const pureSavingsData = {
            'cash-reserve': { name: 'Cash Reserve', current: 1200.00, total: 10000.00, color: 'lime-500' }
        };

        const goalsData = {
            'emergency-fund': { name: 'Emergency Fund', current: 750.00, total: 3000.00, color: 'blue-500' },
            'vacation': { name: 'Vacation', current: 250.00, total: 1500.00, color: 'cyan-500' }
        };

        const defaultTransactionsData = [
            { id: 1, name: 'Axis Energy', amount: 2145.67, type: 'credit', date: '2025-10-10', category: 'income', source: 'Bank Sync (Payroll)', isInternalTransfer: false },
            { id: 100, name: 'Check Deposit', amount: 150.00, type: 'credit', date: '2025-10-01', category: 'income', source: 'Check #8812', isInternalTransfer: false },
            { id: 2, name: 'Whole Foods Market', amount: 142.33, type: 'debit', date: '2025-10-12', category: 'groceries', source: 'Bank Sync', isInternalTransfer: false },
            { id: 3, name: 'Trader Joe's', amount: 98.22, type: 'debit', date: '2025-10-05', category: 'groceries', source: 'Bank Sync', isInternalTransfer: false },
            { id: 4, name: 'Whole Foods Market', amount: 70.00, type: 'debit', date: '2025-10-01', category: 'groceries', source: 'Bank Sync', isInternalTransfer: false },
            { id: 5, name: 'The Flying Squirrel', amount: 78.50, type: 'debit', date: '2025-10-11', category: 'dining-out', source: 'Bank Sync', isInternalTransfer: false },
            { id: 6, name: "Rembrandt's Coffee House", amount: 18.75, type: 'debit', date: new Date().toISOString().split('T')[0], category: 'dining-out', source: 'Manual Log', isInternalTransfer: false },
            { id: 7, name: 'Public House Restaurant', amount: 67.25, type: 'debit', date: '2025-10-08', category: 'dining-out', source: 'Bank Sync', isInternalTransfer: false },
            { id: 8, name: 'Shell', amount: 48.12, type: 'debit', date: '2025-10-09', category: 'transportation', source: 'Bank Sync', isInternalTransfer: false },
            { id: 9, name: 'Shell', amount: 46.78, type: 'debit', date: '2025-10-02', category: 'transportation', source: 'Bank Sync', isInternalTransfer: false },
            { id: 10, name: 'Target', amount: 80.00, type: 'debit', date: '2025-10-04', category: 'shopping', source: 'Bank Sync', isInternalTransfer: false },
            { id: 11, name: 'Target Refund', amount: 24.50, type: 'credit', date: '2025-10-06', category: 'shopping', source: 'Bank Sync', isInternalTransfer: false },
            { id: 12, name: 'Regal Hamilton Place', amount: 75.00, type: 'debit', date: '2025-10-05', category: 'entertainment', source: 'Bank Sync', isInternalTransfer: false },
            { id: 13, name: 'EPB Headquarters', amount: 20.00, type: 'debit', date: '2025-10-08', category: 'utilities', source: 'Check #2045', isInternalTransfer: false },
            { id: 14, name: 'CVS', amount: 35.00, type: 'debit', date: '2025-10-07', category: 'health', source: 'Bank Sync', isInternalTransfer: false },
            { id: 15, name: 'Erlanger Baroness Hospital', amount: 20.00, type: 'debit', date: '2025-10-03', category: 'health', source: 'Bank Sync', isInternalTransfer: false },
            { id: 16, name: 'Orangetheory Fitness', amount: 15.00, type: 'debit', date: '2025-10-01', category: 'fitness', source: 'Bank Sync', isInternalTransfer: false },
            { id: 17, name: 'The Home Depot', amount: 100.00, type: 'debit', date: '2025-09-30', category: 'home-improvement', source: 'Bank Sync', isInternalTransfer: false },
            { id: 18, name: 'Transfer to Savings', amount: 500.00, type: 'debit', date: '2025-10-10', category: 'transfers', source: 'Checking', isInternalTransfer: true },
            { id: 19, name: 'Transfer from Checking', amount: 500.00, type: 'credit', date: '2025-10-10', category: 'transfers', source: 'Savings', isInternalTransfer: true }
        ];

        const tailwindColors = {
            'red-500': '#ef4444',
            'green-500': '#22c55e',
            'yellow-500': '#eab308',
            'purple-500': '#8b5cf6',
            'blue-500': '#3b82f6',
            'cyan-500': '#06b6d4',
            'indigo-500': '#6366f1',
            'pink-500': '#ec4899',
            'teal-500': '#14b8a6',
            'amber-500': '#f59e0b',
            'emerald-500': '#10b981',
            'gray-500': '#6b7280',
            'green-600': '#16a34a',
            'lime-500': '#84cc16'
        };

        const placeTypeDefinitions = [
            { key: 'airport', label: 'Airport', icon: 'navigation' },
            { key: 'amusement-park', label: 'Amusement Park', icon: 'smile' },
            { key: 'aquarium', label: 'Aquarium', icon: 'droplet' },
            { key: 'art-gallery', label: 'Art Gallery', icon: 'image' },
            { key: 'atm', label: 'ATM', icon: 'credit-card' },
            { key: 'bakery', label: 'Bakery', icon: 'coffee' },
            { key: 'bank', label: 'Bank', icon: 'briefcase' },
            { key: 'bar', label: 'Bar', icon: 'coffee' },
            { key: 'beauty-salon', label: 'Beauty Salon', icon: 'scissors' },
            { key: 'bicycle-store', label: 'Bicycle Store', icon: 'activity' },
            { key: 'book-store', label: 'Book Store', icon: 'book' },
            { key: 'bowling-alley', label: 'Bowling Alley', icon: 'target' },
            { key: 'bus-station', label: 'Bus Station', icon: 'map' },
            { key: 'cafe', label: 'Cafe', icon: 'coffee' },
            { key: 'campground', label: 'Campground', icon: 'sunrise' },
            { key: 'car-dealer', label: 'Car Dealer', icon: 'truck' },
            { key: 'car-rental', label: 'Car Rental', icon: 'navigation' },
            { key: 'car-repair', label: 'Car Repair', icon: 'tool' },
            { key: 'car-wash', label: 'Car Wash', icon: 'droplet' },
            { key: 'casino', label: 'Casino', icon: 'star' },
            { key: 'cemetery', label: 'Cemetery', icon: 'feather' },
            { key: 'church', label: 'Church', icon: 'umbrella' },
            { key: 'city-hall', label: 'City Hall', icon: 'columns' },
            { key: 'clothing-store', label: 'Clothing Store', icon: 'shopping-bag' },
            { key: 'convenience-store', label: 'Convenience Store', icon: 'shopping-cart' },
            { key: 'courthouse', label: 'Courthouse', icon: 'layers' },
            { key: 'dentist', label: 'Dentist', icon: 'smile' },
            { key: 'department-store', label: 'Department Store', icon: 'grid' },
            { key: 'doctor', label: 'Doctor', icon: 'activity' },
            { key: 'drugstore', label: 'Drugstore', icon: 'package' },
            { key: 'electrician', label: 'Electrician', icon: 'zap' },
            { key: 'electronics-store', label: 'Electronics Store', icon: 'cpu' },
            { key: 'embassy', label: 'Embassy', icon: 'flag' },
            { key: 'fire-station', label: 'Fire Station', icon: 'sun' },
            { key: 'florist', label: 'Florist', icon: 'sun' },
            { key: 'funeral-home', label: 'Funeral Home', icon: 'home' },
            { key: 'furniture-store', label: 'Furniture Store', icon: 'box' },
            { key: 'gas-station', label: 'Gas Station', icon: 'droplet' },
            { key: 'gym', label: 'Gym', icon: 'activity' },
            { key: 'hair-care', label: 'Hair Care', icon: 'scissors' },
            { key: 'hardware-store', label: 'Hardware Store', icon: 'tool' },
            { key: 'hindu-temple', label: 'Hindu Temple', icon: 'aperture' },
            { key: 'home-goods-store', label: 'Home Goods Store', icon: 'box' },
            { key: 'hospital', label: 'Hospital', icon: 'heart' },
            { key: 'insurance-agency', label: 'Insurance Agency', icon: 'shield' },
            { key: 'jewelry-store', label: 'Jewelry Store', icon: 'hexagon' },
            { key: 'laundry', label: 'Laundry', icon: 'droplet' },
            { key: 'lawyer', label: 'Lawyer', icon: 'briefcase' },
            { key: 'library', label: 'Library', icon: 'book-open' },
            { key: 'light-rail-station', label: 'Light Rail Station', icon: 'map' },
            { key: 'liquor-store', label: 'Liquor Store', icon: 'package' },
            { key: 'local-government-office', label: 'Local Government Office', icon: 'columns' },
            { key: 'locksmith', label: 'Locksmith', icon: 'key' },
            { key: 'lodging', label: 'Lodging', icon: 'home' },
            { key: 'meal-delivery', label: 'Meal Delivery', icon: 'truck' },
            { key: 'meal-takeaway', label: 'Meal Takeaway', icon: 'coffee' },
            { key: 'mosque', label: 'Mosque', icon: 'hexagon' },
            { key: 'movie-rental', label: 'Movie Rental', icon: 'film' },
            { key: 'movie-theater', label: 'Movie Theater', icon: 'film' },
            { key: 'moving-company', label: 'Moving Company', icon: 'truck' },
            { key: 'museum', label: 'Museum', icon: 'image' },
            { key: 'night-club', label: 'Night Club', icon: 'music' },
            { key: 'painter', label: 'Painter', icon: 'edit-3' },
            { key: 'park', label: 'Park', icon: 'sun' },
            { key: 'parking', label: 'Parking', icon: 'square' },
            { key: 'pet-store', label: 'Pet Store', icon: 'heart' },
            { key: 'pharmacy', label: 'Pharmacy', icon: 'package' },
            { key: 'physiotherapist', label: 'Physiotherapist', icon: 'activity' },
            { key: 'plumber', label: 'Plumber', icon: 'tool' },
            { key: 'police', label: 'Police', icon: 'shield' },
            { key: 'post-office', label: 'Post Office', icon: 'mail' },
            { key: 'primary-school', label: 'Primary School', icon: 'book-open' },
            { key: 'real-estate-agency', label: 'Real Estate Agency', icon: 'home' },
            { key: 'restaurant', label: 'Restaurant', icon: 'coffee' },
            { key: 'roofing-contractor', label: 'Roofing Contractor', icon: 'tool' },
            { key: 'rv-park', label: 'RV Park', icon: 'sunrise' },
            { key: 'school', label: 'School', icon: 'book' },
            { key: 'secondary-school', label: 'Secondary School', icon: 'book-open' },
            { key: 'shoe-store', label: 'Shoe Store', icon: 'shopping-bag' },
            { key: 'shopping-mall', label: 'Shopping Mall', icon: 'grid' },
            { key: 'spa', label: 'Spa', icon: 'feather' },
            { key: 'stadium', label: 'Stadium', icon: 'target' },
            { key: 'storage', label: 'Storage', icon: 'box' },
            { key: 'store', label: 'Store', icon: 'shopping-cart' },
            { key: 'subway-station', label: 'Subway Station', icon: 'map' },
            { key: 'supermarket', label: 'Supermarket', icon: 'shopping-cart' },
            { key: 'synagogue', label: 'Synagogue', icon: 'aperture' },
            { key: 'taxi-stand', label: 'Taxi Stand', icon: 'navigation' },
            { key: 'tourist-attraction', label: 'Tourist Attraction', icon: 'map-pin' },
            { key: 'train-station', label: 'Train Station', icon: 'map' },
            { key: 'transit-station', label: 'Transit Station', icon: 'navigation' },
            { key: 'travel-agency', label: 'Travel Agency', icon: 'globe' },
            { key: 'university', label: 'University', icon: 'book-open' },
            { key: 'veterinary-care', label: 'Veterinary Care', icon: 'heart' },
            { key: 'zoo', label: 'Zoo', icon: 'smile' }
        ];


        const placeTypeIndex = placeTypeDefinitions.reduce((acc, definition) => {
            acc.byKey[definition.key] = definition;
            acc.byLabel[definition.label.toLowerCase()] = definition;
            return acc;
        }, { byKey: {}, byLabel: {} });

        let budgetCategories = loadBudgetCategories();
        let transactionsData = [...defaultTransactionsData];
        let categorizedPlaces = loadCategorizedPlaces();
        let map;
        let mapMarkers = [];
        let currentPlace = null;
        let activePlaceType = null;
        let searchTimeout;
        let pendingPlaceForSubcategory = null;

        function deepCopy(value) {
            return JSON.parse(JSON.stringify(value));
        }

        function loadBudgetCategories() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.budget);
                if (!raw) return deepCopy(defaultBudgetCategories);
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : deepCopy(defaultBudgetCategories);
            } catch (error) {
                console.error('Failed to load stored budget categories:', error);
                return deepCopy(defaultBudgetCategories);
            }
        }

        function persistBudgetCategories() {
            try {
                localStorage.setItem(STORAGE_KEYS.budget, JSON.stringify(budgetCategories));
            } catch (error) {
                console.error('Failed to persist budget categories:', error);
            }
        }

        function loadCategorizedPlaces() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.places);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (error) {
                console.error('Failed to load categorized places:', error);
                return {};
            }
        }

        function persistCategorizedPlaces() {
            try {
                localStorage.setItem(STORAGE_KEYS.places, JSON.stringify(categorizedPlaces));
            } catch (error) {
                console.error('Failed to persist categorized places:', error);
            }
        }

        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);

        function findSubcategoryById(subcategoryId) {
            if (!subcategoryId) return { parent: null, subcategory: null };
            for (const parent of Object.values(budgetCategories)) {
                if (parent.subcategories && parent.subcategories[subcategoryId]) {
                    return { parent, subcategory: parent.subcategories[subcategoryId] };
                }
            }
            return { parent: null, subcategory: null };
        }

        function getIconSvg(iconName, options = {}) {
            const icon = feather.icons[iconName] || feather.icons['map-pin'];
            const size = options.size || 20;
            const stroke = options.stroke || '#0f172a';
            const strokeWidth = options.strokeWidth || 2;
            return icon.toSvg({ width: size, height: size, stroke, color: stroke, 'stroke-width': strokeWidth });
        }

        function createIconBadge(iconName, palette, size = 'md') {
            const paletteStyle = palette ? `background: linear-gradient(135deg, ${palette.start}, ${palette.end});` : '';
            const sizeClass = size === 'lg' ? 'lg' : size === 'sm' ? 'sm' : '';
            const svg = getIconSvg(iconName, { size: size === 'lg' ? 24 : size === 'sm' ? 16 : 20, stroke: '#ffffff' });
            return `<span class="icon-circle ${sizeClass}" style="${paletteStyle}">${svg}</span>`;
        }

        function markerIconForPlace(place) {
            const { parent, subcategory } = findSubcategoryById(place.subcategoryId);
            const palette = parent?.palette || (place.isCategorized ? paletteCatalog[0] : { start: '#bbf7d0', end: '#22c55e' });
            const iconName = place.iconName || subcategory?.icon || placeTypeIndex.byKey[place.placeTypeKey]?.icon || 'map-pin';
            const svg = getIconSvg(iconName, { size: 20, stroke: '#ffffff', strokeWidth: 2 });
            const gradient = `linear-gradient(135deg, ${palette.start}, ${palette.end})`;
            return L.divIcon({
                html: `<div class="custom-pin" style="background:${gradient}"><div class="pin-inner">${svg}</div></div>`,
                className: '',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
        }

        function calculateBudgetState() {
            for (const parent of Object.values(budgetCategories)) {
                parent.totalBudgeted = 0;
                parent.totalSpent = 0;
                parent.totalRemaining = 0;
                for (const sub of Object.values(parent.subcategories || {})) {
                    const budgeted = Number(sub.budgeted) || 0;
                    let spent = 0;
                    let credits = 0;
                    for (const txn of transactionsData) {
                        if (txn.category === sub.id) {
                            if (txn.type === 'debit' && !txn.isInternalTransfer) spent += txn.amount;
                            if (txn.type === 'credit' && !txn.isInternalTransfer) credits += txn.amount;
                        }
                    }
                    sub.spent = spent;
                    sub.credited = credits;
                    sub.remaining = budgeted - spent + credits;
                    parent.totalBudgeted += budgeted;
                    parent.totalSpent += spent;
                }
                parent.totalRemaining = Object.values(parent.subcategories || {}).reduce((acc, sub) => acc + (sub.remaining ?? 0), 0);
            }
        }

        function renderPlaceTypeFilters() {
            const container = document.getElementById('category-filters-container');
            if (!container) return;
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            placeTypeDefinitions.forEach(definition => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'place-type-btn';
                button.dataset.placeType = definition.key;
                button.setAttribute('title', `Search ${definition.label}`);
                button.setAttribute('aria-label', `Search ${definition.label}`);
                const icon = getIconSvg(definition.icon, { size: 16, stroke: '#1f2937', strokeWidth: 2 });
                button.innerHTML = `${icon}<span>${definition.label}</span>`;
                fragment.appendChild(button);
            });
            container.appendChild(fragment);
        }

        function getCategorizedPlaceMatches(query, placeTypeKey, center, radiusMeters) {
            const matches = [];
            const normalizedQuery = query ? query.toLowerCase() : '';
            Object.values(categorizedPlaces || {}).forEach(saved => {
                if (!saved) return;
                const matchesQuery = normalizedQuery ? saved.name.toLowerCase().includes(normalizedQuery) : true;
                const matchesType = placeTypeKey ? saved.placeTypeKey === placeTypeKey : true;
                if (!matchesQuery || !matchesType) return;
                if (center && radiusMeters && map) {
                    const distance = map.distance([saved.lat, saved.lng], [center.lat, center.lng]);
                    if (distance > radiusMeters + 50) return;
                }
                matches.push(normalizeSavedPlace(saved));
            });
            return matches;
        }

        function determinePlaceType(item, context) {
            if (context?.placeTypeKey) return context.placeTypeKey;
            if (item?.categories) {
                for (const category of item.categories) {
                    const key = category?.name ? placeTypeIndex.byLabel[category.name.toLowerCase()] : null;
                    if (key) return key.key;
                }
            }
            return null;
        }

        function normalizeHereItem(item, context = {}) {
            if (!item) return null;
            const position = item.position || item?.access?.[0]?.position;
            if (!position || typeof position.lat !== 'number' || typeof position.lng !== 'number') return null;
            const placeTypeKey = determinePlaceType(item, context);
            const saved = categorizedPlaces[item.id];
            const fromSaved = saved ? normalizeSavedPlace(saved) : null;
            return {
                id: item.id,
                name: item.title,
                address: item.address?.label || '',
                lat: position.lat,
                lng: position.lng,
                placeTypeKey: fromSaved?.placeTypeKey || placeTypeKey,
                typeLabel: item.categories?.[0]?.name || fromSaved?.typeLabel || placeTypeIndex.byKey[placeTypeKey]?.label || 'Place',
                subcategoryId: fromSaved?.subcategoryId || null,
                parentId: fromSaved?.parentId || null,
                iconName: fromSaved?.iconName || null,
                isCategorized: Boolean(fromSaved?.subcategoryId),
                source: 'here',
                hereItem: item
            };
        }

        function normalizeSavedPlace(saved) {
            const { parent, subcategory } = findSubcategoryById(saved.subcategoryId);
            return {
                id: saved.id,
                name: saved.name,
                address: saved.address || '',
                lat: saved.lat,
                lng: saved.lng,
                placeTypeKey: saved.placeTypeKey || null,
                typeLabel: saved.typeLabel || placeTypeIndex.byKey[saved.placeTypeKey]?.label || 'Place',
                subcategoryId: saved.subcategoryId,
                parentId: saved.parentId,
                iconName: saved.iconName || subcategory?.icon || null,
                isCategorized: true,
                source: 'saved'
            };
        }

        function clearMarkers() {
            mapMarkers.forEach(entry => entry.marker.removeFrom(map));
            mapMarkers = [];
        }

        function addPlacesToMap(places) {
            clearMarkers();
            places.forEach(place => {
                const icon = markerIconForPlace(place);
                const marker = L.marker([place.lat, place.lng], { icon });
                marker.on('click', (event) => {
                    L.DomEvent.stopPropagation(event);
                    showPlaceView({ ...place });
                    map.flyTo([place.lat, place.lng], 15);
                });
                marker.addTo(map);
                mapMarkers.push({ marker, placeId: place.id, place: { ...place } });
            });
        }

        async function searchPlaces({ queryOverride } = {}) {
            if (HERE_API_KEY === 'YOUR_HERE_API_KEY') {
                console.error("API Key is not set. Replace 'YOUR_HERE_API_KEY' with your actual key.");
                return;
            }
            const loader = document.getElementById('map-loader');
            if (loader) loader.style.display = 'flex';
            const searchInput = document.getElementById('search-input');
            const query = (queryOverride ?? searchInput?.value ?? '').trim();
            const center = map.getCenter();
            const radiusMeters = 64373; // ~40 miles
            const context = { placeTypeKey: activePlaceType };
            const savedMatches = getCategorizedPlaceMatches(query, activePlaceType, center, radiusMeters);
            let hereItems = [];
            if (query || activePlaceType) {
                const searchTerm = query || placeTypeIndex.byKey[activePlaceType]?.label || '';
                const url = `https://discover.search.hereapi.com/v1/discover?q=${encodeURIComponent(searchTerm)}&limit=50&in=circle:${center.lat},${center.lng};r=${radiusMeters}&apiKey=${HERE_API_KEY}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HERE request failed: ${response.status}`);
                    const data = await response.json();
                    hereItems = (data.items || []).map(item => normalizeHereItem(item, context)).filter(Boolean);
                } catch (error) {
                    console.error('Error fetching places from HERE:', error);
                }
            }
            const combinedMap = new Map();
            savedMatches.forEach(place => combinedMap.set(place.id, place));
            hereItems.forEach(place => {
                if (!place) return;
                if (combinedMap.has(place.id)) {
                    const existing = combinedMap.get(place.id);
                    combinedMap.set(place.id, {
                        ...place,
                        ...existing,
                        subcategoryId: existing.subcategoryId || place.subcategoryId || null,
                        parentId: existing.parentId || place.parentId || null,
                        iconName: existing.iconName || place.iconName || null,
                        isCategorized: existing.isCategorized || place.isCategorized,
                        placeTypeKey: existing.placeTypeKey || place.placeTypeKey
                    });
                } else {
                    combinedMap.set(place.id, place);
                }
            });
            const combined = Array.from(combinedMap.values());
            addPlacesToMap(combined);
            if (loader) loader.style.display = 'none';
        }

        function renderBudgetView() {
            const budgetList = document.getElementById('budget-list');
            if (!budgetList) return;
            calculateBudgetState();
            budgetList.innerHTML = Object.values(budgetCategories).map(parent => {
                const parentIcon = createIconBadge(parent.icon || 'folder', parent.palette, 'md');
                const totalBudget = parent.totalBudgeted || 0;
                const totalSpent = parent.totalSpent || 0;
                const progress = totalBudget > 0 ? Math.min(100, Math.max(0, (totalSpent / totalBudget) * 100)) : 0;
                const subcategoriesHtml = Object.values(parent.subcategories || {}).map(sub => {
                    const subProgress = (sub.budgeted || 0) > 0 ? Math.min(100, Math.max(0, (sub.spent || 0) / sub.budgeted * 100)) : 0;
                    const paletteStyle = `background: linear-gradient(135deg, ${parent.palette.start}, ${parent.palette.end});`;
                    return `<div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between text-sm mb-1">
                            <div class="flex items-center gap-2">
                                ${createIconBadge(sub.icon || 'map-pin', parent.palette, 'sm')}
                                <span class="font-semibold text-gray-700">${sub.name}</span>
                            </div>
                            <span class="text-gray-500">${formatCurrency(sub.spent || 0)} of ${formatCurrency(sub.budgeted || 0)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="h-2 rounded-full" style="${paletteStyle}width:${subProgress}%"></div>
                        </div>
                    </div>`;
                }).join('');
                return `<div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            ${parentIcon}
                            <div>
                                <p class="text-sm font-semibold text-slate-600">${parent.name}</p>
                                <p class="text-xs text-slate-500">${formatCurrency(totalSpent)} of ${formatCurrency(totalBudget)} spent</p>
                            </div>
                        </div>
                        <button class="text-xs font-semibold text-blue-600 hover:text-blue-700" data-action="add-subcategory" data-parent="${parent.id}">+ Add subcategory</button>
                    </div>
                    <div class="mt-3 space-y-3">
                        ${subcategoriesHtml || '<p class=\"text-sm text-gray-500\">No subcategories yet.</p>'}
                    </div>
                </div>`;
            }).join('');
            createSankey(document.getElementById('sankey-hero'));
        }

        function renderTransactionsView() {
            const listEl = document.getElementById('transactions-list');
            const totalSpentEl = document.getElementById('total-spent');
            const assetsEl = document.getElementById('assets-display');
            if (!listEl || !totalSpentEl || !assetsEl) return;
            const sorted = [...transactionsData].sort((a, b) => new Date(b.date) - new Date(a.date));
            const totalSpent = sorted.filter(t => t.type === 'debit' && !t.isInternalTransfer).reduce((sum, t) => sum + t.amount, 0);
            const totalCredits = sorted.filter(t => t.type === 'credit' && !t.isInternalTransfer).reduce((sum, t) => sum + t.amount, 0);
            const totalAssets = totalCredits - totalSpent;
            totalSpentEl.textContent = formatCurrency(totalSpent);
            assetsEl.textContent = formatCurrency(totalAssets);

            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            const grouped = sorted.reduce((acc, txn) => {
                const date = txn.date;
                let groupName;
                if (date === todayStr) groupName = 'Today';
                else if (date === yesterdayStr) groupName = 'Yesterday';
                else groupName = new Date(date.replace(/-/g, '/')).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                acc[groupName] = acc[groupName] || [];
                acc[groupName].push(txn);
                return acc;
            }, {});

            listEl.innerHTML = Object.entries(grouped).map(([date, txns]) => {
                const items = txns.map(txn => {
                    const { parent, subcategory } = findSubcategoryById(txn.category);
                    const icon = createIconBadge(subcategory?.icon || 'map-pin', parent?.palette, 'sm');
                    const amountClass = txn.type === 'credit' ? 'text-green-600' : 'text-gray-800';
                    const categoryLabel = subcategory?.name || 'Uncategorized';
                    return `<div class="flex items-center bg-gray-50 p-3 rounded-lg">
                        <div class="mr-3">${icon}</div>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900">${txn.name}</p>
                            <p class="text-xs text-gray-500">${categoryLabel}</p>
                        </div>
                        <div class="font-semibold ${amountClass}">${txn.type === 'credit' ? '+' : ''}${formatCurrency(txn.amount)}</div>
                    </div>`;
                }).join('');
                return `<div><h3 class="font-bold text-gray-700 text-sm mb-2">${date}</h3><div class="space-y-2">${items}</div></div>`;
            }).join('');
        }

        function renderPlaceDetailView(place) {
            if (!place) return;
            const placeViewEl = document.getElementById('place-detail-view');
            if (!placeViewEl) return;
            const { parent, subcategory } = findSubcategoryById(place.subcategoryId);
            const palette = parent?.palette || { start: '#bbf7d0', end: '#22c55e' };
            const iconName = place.iconName || subcategory?.icon || placeTypeIndex.byKey[place.placeTypeKey]?.icon || 'map-pin';
            const iconBadge = createIconBadge(iconName, palette, 'lg');
            const addControlIcon = getIconSvg('plus', { size: 18, stroke: '#2563eb', strokeWidth: 3 });
            const createControlIcon = getIconSvg('plus', { size: 18, stroke: '#ffffff', strokeWidth: 3 });
            const merchantTransactions = transactionsData.filter(t => t.name === place.name && t.type === 'debit').sort((a, b) => new Date(b.date) - new Date(a.date));
            let hintText = '';
            if (merchantTransactions.length === 1) {
                hintText = `Last spent here: ${formatCurrency(merchantTransactions[0].amount)}`;
            } else if (merchantTransactions.length >= 2) {
                const recent = merchantTransactions.slice(0, 3);
                const avg = recent.reduce((acc, txn) => acc + txn.amount, 0) / recent.length;
                hintText = `Avg. spent per visit: ${formatCurrency(avg)}`;
            }
            const categorySection = subcategory ? `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg my-4">
                    <div class="flex justify-between items-baseline">
                        <p class="text-sm font-medium text-blue-800">${subcategory.name}</p>
                        <div class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">${parent?.name || 'Budget'}</div>
                    </div>
                    <p class="text-3xl font-extrabold text-blue-900">${formatCurrency(subcategory.remaining)}</p>
                    <p class="text-xs text-blue-600 h-4 mt-1">${hintText}</p>
                    <button id="log-purchase-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition mt-4">Log Purchase</button>
                </div>` : `<div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-lg my-4">
                    <h3 class="font-bold text-emerald-900">New Place Category</h3>
                    <p class="text-sm text-emerald-800 mt-1">This place is not assigned to your budget yet. Add it to an existing subcategory or create a new one.</p>
                </div>`;
            placeViewEl.innerHTML = `<div class="p-4">
                <button id="back-to-main-btn" class="text-sm font-semibold text-blue-600 mb-4">&larr; Back to Budget</button>
                <div class="flex items-center mb-3">
                    <div class="mr-4">${iconBadge}</div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">${place.name}</h2>
                        <p class="text-sm text-gray-500">${place.typeLabel || ''}</p>
                        ${place.address ? `<p class=\"text-xs text-gray-400 mt-1\">${place.address}</p>` : ''}
                    </div>
                </div>
                ${categorySection}
                <div class="flex items-center gap-3 mt-4">
                    <button type="button" class="map-card-control" data-place-action="assign-subcategory" title="Add to existing sub category">${addControlIcon}<span class="sr-only">Add to existing sub category</span></button>
                    <button type="button" class="map-card-control primary" data-place-action="create-subcategory" title="Create new sub category">${createControlIcon}<span class="sr-only">Create new sub category</span></button>
                </div>
            </div>
            <div class="border-t p-4 mt-4">
                <h3 class="font-bold text-gray-800 mb-2">Recent Activity Here</h3>
                <div class="space-y-2">${merchantTransactions.length === 0 ? '<p class=\"text-sm text-gray-500\">No transactions recorded here yet.</p>' : merchantTransactions.map(txn => `<div class=\"flex justify-between items-center text-sm\"><span class=\"text-gray-600\">${new Date(txn.date.replace(/-/g, '/')).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span><span class=\"font-semibold text-gray-800\">${formatCurrency(txn.amount)}</span></div>`).join('')}</div>
            </div>`;
        }

        function showPlaceView(place) {
            currentPlace = { ...place };
            renderPlaceDetailView(currentPlace);
            switchSidebarView('place-detail-view');
        }

        function switchSidebarView(targetViewId) {
            const sidebarViews = document.querySelectorAll('.sidebar-view');
            const navBtns = document.querySelectorAll('.nav-btn');
            sidebarViews.forEach(view => view.classList.toggle('active', view.id === targetViewId));
            navBtns.forEach(button => {
                button.classList.toggle('active', button.dataset.view === targetViewId);
                button.classList.toggle('text-gray-600', button.dataset.view !== targetViewId);
            });
            if (targetViewId === 'budget-view') renderBudgetView();
            if (targetViewId === 'transactions-view') renderTransactionsView();
            if (targetViewId === 'place-detail-view' && currentPlace) renderPlaceDetailView(currentPlace);
        }

        const logPurchaseModalEl = document.getElementById('log-purchase-modal');
        let currentAmountString = "0";

        function showLogPurchaseModal() {
            if (!currentPlace?.subcategoryId) return;
            logPurchaseModalEl.classList.remove('hidden');
            logPurchaseModalEl.classList.add('flex');
            logPurchaseModalEl.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
                <h2 class="text-2xl font-bold text-gray-900 text-center mb-2">Log Purchase</h2>
                <p class="text-center text-gray-600 mb-4">${currentPlace.name}</p>
                <div class="my-6"><p class="text-6xl font-bold text-center text-gray-800" id="log-amount-display">$0.00</p></div>
                <div class="grid grid-cols-3 gap-2">${[1,2,3,4,5,6,7,8,9,'.',0,'del'].map(k => `<button class=\"keypad-btn text-2xl font-semibold rounded-xl h-16 transition-colors bg-gray-100 text-gray-800\">${k === 'del' ? '&larr;' : k}</button>`).join('')}</div>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button id="cancel-log-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-300">Cancel</button>
                    <button id="save-log-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700">Save</button>
                </div>
            </div>`;
        }

        function hideLogPurchaseModal() {
            logPurchaseModalEl.classList.add('hidden');
            logPurchaseModalEl.classList.remove('flex');
            currentAmountString = "0";
        }

        function saveTransaction() {
            const saveBtn = logPurchaseModalEl.querySelector('#save-log-btn');
            if (!saveBtn) return;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loader mx-auto" style="width:24px; height:24px; border-width: 2px;"></div>';
            const amount = parseFloat(currentAmountString);
            if (amount > 0 && currentPlace) {
                const newTransaction = {
                    id: Date.now(),
                    name: currentPlace.name,
                    amount,
                    type: 'debit',
                    date: new Date().toISOString().split('T')[0],
                    category: currentPlace.subcategoryId,
                    source: 'Manual Log',
                    isInternalTransfer: false
                };
                transactionsData.push(newTransaction);
                hideLogPurchaseModal();
                renderPlaceDetailView(currentPlace);
                renderTransactionsView();
                renderBudgetView();
            } else {
                const display = logPurchaseModalEl.querySelector('#log-amount-display');
                display.classList.add('shake', 'text-red-500');
                setTimeout(() => {
                    display.classList.remove('shake', 'text-red-500');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save';
                }, 500);
            }
        }

        const addCategoryModalEl = document.getElementById('add-category-modal');

        function closeActionModal() {
            addCategoryModalEl.classList.add('hidden');
            addCategoryModalEl.classList.remove('flex');
            addCategoryModalEl.innerHTML = '';
            pendingPlaceForSubcategory = null;
        }

        function openAssignSubcategoryModal(place) {
            const options = Object.values(budgetCategories).map(parent => {
                const subs = Object.values(parent.subcategories || {});
                if (!subs.length) return '';
                return `<optgroup label="${parent.name}">${subs.map(sub => `<option value=\"${sub.id}\">${sub.name}</option>`).join('')}</optgroup>`;
            }).join('');
            addCategoryModalEl.classList.remove('hidden');
            addCategoryModalEl.classList.add('flex');
            addCategoryModalEl.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Add to Budget</h2>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="existing-subcategory-select">Choose a subcategory</label>
                <select id="existing-subcategory-select" class="mt-1 block w-full border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Select --</option>
                    ${options}
                </select>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-300" data-modal-action="cancel">Cancel</button>
                    <button class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700" data-modal-action="assign-subcategory">Save</button>
                </div>
            </div>`;
        }

        function openCreateSubcategoryModal(place, initialParentId = '') {
            pendingPlaceForSubcategory = place || null;
            const parentOptions = Object.values(budgetCategories).map(parent => `<option value="${parent.id}" ${parent.id === initialParentId ? 'selected' : ''}>${parent.name}</option>`).join('');
            addCategoryModalEl.classList.remove('hidden');
            addCategoryModalEl.classList.add('flex');
            addCategoryModalEl.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Create sub category</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-subcategory-parent">Parent category</label>
                    <select id="new-subcategory-parent" class="mt-1 block w-full border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${parentOptions}</select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-subcategory-name">Name</label>
                    <input type="text" id="new-subcategory-name" class="mt-1 block w-full shadow-sm border-gray-300 rounded-md" placeholder="e.g. Local Cafs" value="${place ? (placeTypeIndex.byKey[place.placeTypeKey]?.label || place.name) : ''}">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-subcategory-slider">Budget amount</label>
                    <input type="range" id="new-subcategory-slider" min="10" max="5000" step="10" value="200" class="w-full">
                    <p class="text-sm text-gray-600 mt-1">Monthly budget: <span id="new-subcategory-amount">${formatCurrency(200)}</span></p>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-300" data-modal-action="cancel">Cancel</button>
                    <button class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700" data-modal-action="create-subcategory">Create</button>
                </div>
            </div>`;
        }

        function openCreateParentCategoryModal() {
            const paletteOptions = paletteCatalog.map(p => `<option value="${p.id}">${p.id.charAt(0).toUpperCase() + p.id.slice(1)}</option>`).join('');
            const iconOptions = ['home', 'globe', 'grid', 'layers', 'briefcase', 'map', 'target', 'sun'];
            const iconSelectOptions = iconOptions.map(icon => `<option value="${icon}">${icon}</option>`).join('');
            addCategoryModalEl.classList.remove('hidden');
            addCategoryModalEl.classList.add('flex');
            addCategoryModalEl.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Create parent category</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-parent-name">Name</label>
                    <input type="text" id="new-parent-name" class="mt-1 block w-full shadow-sm border-gray-300 rounded-md" placeholder="e.g. Kids" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-parent-icon">Icon</label>
                    <select id="new-parent-icon" class="mt-1 block w-full border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${iconSelectOptions}</select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" for="new-parent-palette">Color theme</label>
                    <select id="new-parent-palette" class="mt-1 block w-full border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${paletteOptions}</select>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-300" data-modal-action="cancel">Cancel</button>
                    <button class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700" data-modal-action="create-parent">Create</button>
                </div>
            </div>`;
        }

        function assignPlaceToSubcategory(place, subcategoryId) {
            const { parent, subcategory } = findSubcategoryById(subcategoryId);
            if (!subcategory || !parent) return;
            const placeId = place.id || `place-${Date.now()}`;
            const placeTypeKey = place.placeTypeKey || activePlaceType || null;
            categorizedPlaces[placeId] = {
                id: placeId,
                name: place.name,
                address: place.address || '',
                lat: place.lat,
                lng: place.lng,
                placeTypeKey,
                subcategoryId,
                parentId: parent.id,
                iconName: subcategory.icon,
                typeLabel: place.typeLabel || subcategory.name
            };
            persistCategorizedPlaces();
            currentPlace = {
                ...place,
                id: placeId,
                subcategoryId,
                parentId: parent.id,
                iconName: subcategory.icon,
                placeTypeKey,
                isCategorized: true
            };
            renderPlaceDetailView(currentPlace);
            renderBudgetView();
            addPlacesToMap(mapMarkers.map(entry => entry.placeId === place.id ? { ...currentPlace } : entry.place));
            pendingPlaceForSubcategory = null;
        }

        function createSubcategory() {
            const parentSelect = document.getElementById('new-subcategory-parent');
            const nameInput = document.getElementById('new-subcategory-name');
            const slider = document.getElementById('new-subcategory-slider');
            if (!parentSelect || !nameInput || !slider) return;
            const parentId = parentSelect.value;
            const name = nameInput.value.trim();
            const budgetAmount = parseFloat(slider.value || '0');
            if (!parentId || !name || budgetAmount <= 0) return;
            const parent = budgetCategories[parentId];
            if (!parent) return;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const uniqueId = parent.subcategories[slug] ? `${slug}-${Date.now()}` : slug;
            parent.subcategories[uniqueId] = {
                id: uniqueId,
                name,
                budgeted: budgetAmount,
                icon: pendingPlaceForSubcategory ? (placeTypeIndex.byKey[pendingPlaceForSubcategory.placeTypeKey]?.icon || 'map-pin') : 'map-pin'
            };
            persistBudgetCategories();
            if (pendingPlaceForSubcategory) {
                assignPlaceToSubcategory(pendingPlaceForSubcategory, uniqueId);
            } else {
                renderBudgetView();
            }
            closeActionModal();
        }

        function createParentCategory() {
            const nameInput = document.getElementById('new-parent-name');
            const iconSelect = document.getElementById('new-parent-icon');
            const paletteSelect = document.getElementById('new-parent-palette');
            if (!nameInput || !iconSelect || !paletteSelect) return;
            const name = nameInput.value.trim();
            const icon = iconSelect.value;
            const paletteId = paletteSelect.value;
            const palette = paletteCatalog.find(p => p.id === paletteId) || paletteCatalog[0];
            if (!name) return;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const id = budgetCategories[slug] ? `${slug}-${Date.now()}` : slug;
            budgetCategories[id] = { id, name, icon, palette, subcategories: {} };
            persistBudgetCategories();
            renderBudgetView();
            closeActionModal();
        }

        function initializeMap() {
            const fallbackCenter = [35.7915, -77.9153];
            map = L.map('map', { center: fallbackCenter, zoom: 11, zoomControl: false, attributionControl: false });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
            setMapToRadius(fallbackCenter, 64373);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const center = [pos.coords.latitude, pos.coords.longitude];
                    setMapToRadius(center, 64373);
                }, () => {}, { enableHighAccuracy: true, timeout: 5000 });
            }
        }

        function setMapToRadius(center, radiusMeters) {
            if (!map) return;
            const circle = L.circle(center, { radius: radiusMeters });
            map.fitBounds(circle.getBounds(), { padding: [32, 32] });
        }

        function handlePlaceTypeClick(target) {
            const alreadyActive = target.classList.contains('active');
            document.querySelectorAll('.place-type-btn').forEach(btn => btn.classList.remove('active'));
            if (alreadyActive) {
                activePlaceType = null;
                clearMarkers();
                if (currentPlace) {
                    currentPlace = null;
                    const placeViewEl = document.getElementById('place-detail-view');
                    if (placeViewEl) {
                        placeViewEl.innerHTML = '';
                        if (placeViewEl.classList.contains('active')) {
                            switchSidebarView('budget-view');
                        }
                    }
                }
                return;
            }
            target.classList.add('active');
            activePlaceType = target.dataset.placeType;
            searchPlaces({});
        }

        function handleSearchSubmit() {
            activePlaceType = null;
            document.querySelectorAll('.place-type-btn').forEach(btn => btn.classList.remove('active'));
            searchPlaces({});
        }

        function renderAll() {
            renderBudgetView();
            renderTransactionsView();
            if (currentPlace) renderPlaceDetailView(currentPlace);
        }

        function getSankeyFlowData() {
            const savingsEntries = Object.entries(pureSavingsData || {});
            const goalEntries = Object.entries(goalsData || {});
            const nodes = [];
            const links = [];
            const details = [];
            const addNode = (name, meta = {}) => {
                nodes.push({ name, ...meta });
                return nodes.length - 1;
            };
            const ensureValue = (value) => {
                const numeric = Number(value);
                return Math.max(Number.isFinite(numeric) ? numeric : 0, 0.01);
            };
            let savingsRootIndex = null;
            if (savingsEntries.length) {
                savingsRootIndex = addNode('Pure Savings', { type: 'root', color: '#0ea5e9' });
            }
            let goalsRootIndex = null;
            if (goalEntries.length) {
                goalsRootIndex = addNode('Time Targets', { type: 'root', color: '#6366f1' });
            }
            savingsEntries.forEach(([key, saving]) => {
                if (!saving) return;
                const current = Number(saving.current) || 0;
                const total = Number(saving.total) || 0;
                const color = tailwindColors[saving.color] || '#0ea5e9';
                const remaining = Math.max(total - current, 0);
                const nodeIndex = addNode(saving.name, {
                    type: 'saving',
                    color,
                    detail: { group: 'Pure Savings', name: saving.name, current, total, remaining }
                });
                if (savingsRootIndex !== null) {
                    links.push({
                        source: savingsRootIndex,
                        target: nodeIndex,
                        value: ensureValue(Math.max(total, current)),
                        color,
                        detail: { group: 'Pure Savings', name: saving.name, current, total }
                    });
                }
                details.push({ group: 'Pure Savings', name: saving.name, current, total, remaining, color });
            });
            goalEntries.forEach(([key, goal]) => {
                if (!goal) return;
                const current = Number(goal.current) || 0;
                const total = Number(goal.total) || 0;
                const color = tailwindColors[goal.color] || '#6366f1';
                const remaining = Math.max(total - current, 0);
                const nodeIndex = addNode(goal.name, {
                    type: 'goal',
                    color,
                    detail: { group: 'Time Targets', name: goal.name, current, total, remaining }
                });
                if (goalsRootIndex !== null) {
                    links.push({
                        source: goalsRootIndex,
                        target: nodeIndex,
                        value: ensureValue(Math.max(total, current)),
                        color,
                        detail: { group: 'Time Targets', name: goal.name, current, total }
                    });
                }
                details.push({ group: 'Time Targets', name: goal.name, current, total, remaining, color });
            });
            return { nodes, links, details };
        }

        function createSankey(svgElement, options = {}) {
            if (!svgElement) return;
            const data = getSankeyFlowData();
            const parentWidth = svgElement.clientWidth || svgElement.parentElement?.clientWidth || 0;
            const parentHeight = svgElement.clientHeight || svgElement.parentElement?.clientHeight || 0;
            const width = options.width || Math.max(parentWidth, 300);
            const height = options.height || Math.max(parentHeight, 240);
            svgElement.innerHTML = '';
            const svg = d3.select(svgElement).attr('viewBox', `0 0 ${width} ${height}`);
            if (!data.links.length) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('fill', '#6b7280')
                    .style('font-size', '13px')
                    .text('Add Pure Savings or Time Targets to view flow.');
                return;
            }
            const sankey = d3.sankey()
                .nodeWidth(options.nodeWidth || 18)
                .nodePadding(options.nodePadding || 18)
                .extent([[1, 1], [width - 1, height - 6]]);
            const { nodes: graphNodes, links: graphLinks } = sankey({
                nodes: data.nodes.map(d => ({ ...d })),
                links: data.links.map(d => ({ ...d }))
            });
            const linkSelection = svg.append('g')
                .selectAll('.sankey-link')
                .data(graphLinks)
                .enter()
                .append('path')
                .attr('class', 'sankey-link')
                .attr('d', d3.sankeyLinkHorizontal())
                .style('stroke', d => d.color || '#94a3b8')
                .style('stroke-width', d => Math.max(1, d.width));
            linkSelection.append('title')
                .text(d => d.detail ? `${d.detail.group}: ${d.detail.name}
Funded: ${formatCurrency(d.detail.current)}
Target: ${formatCurrency(d.detail.total)}` : `${d.source.name}  ${d.target.name}`);
            svg.append('g')
                .selectAll('.sankey-link-progress')
                .data(graphLinks)
                .enter()
                .append('path')
                .attr('class', 'sankey-link-progress')
                .attr('d', d3.sankeyLinkHorizontal())
                .style('fill', 'none')
                .style('stroke', d => d.color || '#2563eb')
                .style('stroke-opacity', 0.85)
                .style('stroke-linecap', 'round')
                .style('stroke-width', d => {
                    const total = Number(d.detail?.total) || Number(d.value) || 0;
                    const current = Number(d.detail?.current) || 0;
                    const ratio = total > 0 ? Math.min(1, Math.max(0, current / total)) : 0;
                    return ratio > 0 ? Math.max(1, d.width * ratio) : 0;
                })
                .style('pointer-events', 'none');
            const node = svg.append('g')
                .selectAll('.sankey-node')
                .data(graphNodes)
                .enter()
                .append('g')
                .attr('class', 'sankey-node')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);
            node.append('rect')
                .attr('height', d => Math.max(1, d.y1 - d.y0))
                .attr('width', sankey.nodeWidth())
                .style('fill', d => d.color || '#94a3b8');
            node.append('title')
                .text(d => {
                    if (d.type === 'root') return d.name;
                    if (!d.detail) return d.name;
                    return `${d.detail.group}: ${d.detail.name}
Funded: ${formatCurrency(d.detail.current)}
Target: ${formatCurrency(d.detail.total)}
Remaining: ${formatCurrency(d.detail.remaining)}`;
                });
            const labels = node.append('text')
                .attr('x', d => d.x0 < width / 2 ? sankey.nodeWidth() + 6 : -6)
                .attr('y', d => (d.y1 - d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .style('font-size', '12px')
                .style('font-weight', d => d.type === 'root' ? '600' : '500')
                .style('fill', '#1f2937')
                .text(d => d.name);
            labels.filter(d => d.type !== 'root' && d.detail)
                .append('tspan')
                .attr('x', d => d.x0 < width / 2 ? sankey.nodeWidth() + 6 : -6)
                .attr('dy', '1.2em')
                .style('fill', '#6b7280')
                .style('font-weight', '400')
                .text(d => `${formatCurrency(d.detail.current)}  ${formatCurrency(d.detail.total)}`);
        }

        function renderSankeyDetails() {
            const container = document.getElementById('sankey-details');
            if (!container) return;
            const { details } = getSankeyFlowData();
            if (!details.length) {
                container.innerHTML = '<p class="text-sm text-gray-500">No savings or time targets to display yet.</p>';
                return;
            }
            const grouped = details.reduce((acc, item) => {
                acc[item.group] = acc[item.group] || [];
                acc[item.group].push(item);
                return acc;
            }, {});
            container.innerHTML = Object.entries(grouped).map(([group, items]) => {
                const sorted = items.slice().sort((a, b) => a.name.localeCompare(b.name));
                return `<div class="mb-5"><h3 class="text-xs font-semibold uppercase tracking-widest text-gray-500 mb-2">${group}</h3><div class="grid gap-3 md:grid-cols-2">${sorted.map(item => {
                    const percent = item.total > 0 ? Math.min(100, (item.current / item.total) * 100) : 0;
                    return `<div class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm"><div class="flex justify-between text-sm font-semibold text-gray-700"><span>${item.name}</span><span class="text-gray-600">${formatCurrency(item.current)} / ${formatCurrency(item.total)}</span></div><div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden"><div class="h-1.5 rounded-full" style="width:${percent}%; background-color:${item.color};"></div></div><p class="text-xs text-gray-500 mt-2">Remaining: ${formatCurrency(item.remaining)}</p></div>`;
                }).join('')}</div></div>`;
            }).join('');
        }

        async function getAutocompleteSuggestions() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim();
            const resultsContainer = document.getElementById('autocomplete-results');
            if (query.length < 3) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                return;
            }
            const center = map.getCenter();
            const url = `https://autosuggest.search.hereapi.com/v1/autosuggest?q=${encodeURIComponent(query)}&at=${center.lat},${center.lng}&limit=7&apiKey=${HERE_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                renderAutocomplete(data.items || []);
            } catch (error) {
                console.error('Autocomplete error:', error);
                resultsContainer.classList.add('hidden');
            }
        }

        function renderAutocomplete(items) {
            const resultsContainer = document.getElementById('autocomplete-results');
            if (!items || !items.length) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                return;
            }
            resultsContainer.innerHTML = items.map(item => `
                <div class="p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0" data-id="${item.id}" data-type="${item.resultType}">
                    <p class="font-semibold text-gray-800">${item.title}</p>
                    <p class="text-sm text-gray-500">${item.address?.label || 'Search suggestion'}</p>
                </div>
            `).join('');
            resultsContainer.classList.remove('hidden');
        }

        async function selectSuggestion(id, type) {
            const resultsContainer = document.getElementById('autocomplete-results');
            resultsContainer.classList.add('hidden');
            resultsContainer.innerHTML = '';
            const loader = document.getElementById('map-loader');
            if (loader) loader.style.display = 'flex';
            const url = `https://lookup.search.hereapi.com/v1/lookup?id=${id}&apiKey=${HERE_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.position && data.position.lat && data.position.lng) {
                    if (['locality', 'administrativeArea', 'county', 'state', 'city'].includes(data.resultType)) {
                        setMapToRadius([data.position.lat, data.position.lng], 64373);
                        document.getElementById('search-input').value = data.title || '';
                        handleSearchSubmit();
                    } else {
                        map.flyTo([data.position.lat, data.position.lng], 15);
                        const normalized = normalizeHereItem(data, { placeTypeKey: activePlaceType });
                        const savedMatches = getCategorizedPlaceMatches('', activePlaceType, map.getCenter(), 64373);
                        const combined = normalized ? [normalized, ...savedMatches.filter(p => p.id !== normalized.id)] : savedMatches;
                        addPlacesToMap(combined);
                        if (normalized) showPlaceView(normalized);
                    }
                }
            } catch (error) {
                console.error('Lookup error:', error);
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            renderPlaceTypeFilters();
            renderAll();

            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-submit');

            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleSearchSubmit();
                }
            });

            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(getAutocompleteSuggestions, 300);
            });

            searchButton.addEventListener('click', (event) => {
                event.preventDefault();
                handleSearchSubmit();
            });

            document.getElementById('autocomplete-results').addEventListener('click', (event) => {
                const selection = event.target.closest('[data-id]');
                if (selection) {
                    selectSuggestion(selection.dataset.id, selection.dataset.type);
                }
            });

            document.getElementById('category-filters-container').addEventListener('click', (event) => {
                const button = event.target.closest('.place-type-btn');
                if (button) {
                    handlePlaceTypeClick(button);
                }
            });

            document.body.addEventListener('click', (event) => {
                const navBtn = event.target.closest('.nav-btn');
                if (navBtn) {
                    switchSidebarView(navBtn.dataset.view);
                    return;
                }
                if (event.target.closest('#back-to-main-btn')) {
                    switchSidebarView('budget-view');
                    return;
                }
                if (event.target.closest('#log-purchase-btn')) {
                    showLogPurchaseModal();
                    return;
                }
                if (event.target.closest('#cancel-log-btn') || event.target.id === 'log-purchase-modal') {
                    hideLogPurchaseModal();
                    return;
                }
                if (event.target.closest('#save-log-btn')) {
                    saveTransaction();
                    return;
                }
                if (event.target.closest('#create-parent-category-btn')) {
                    openCreateParentCategoryModal();
                    return;
                }
                const addSubcategory = event.target.closest('[data-action="add-subcategory"]');
                if (addSubcategory) {
                    const parentId = addSubcategory.dataset.parent;
                    openCreateSubcategoryModal(null, parentId);
                    return;
                }
                const placeAction = event.target.closest('[data-place-action]');
                if (placeAction && currentPlace) {
                    if (placeAction.dataset.placeAction === 'assign-subcategory') {
                        openAssignSubcategoryModal(currentPlace);
                    } else if (placeAction.dataset.placeAction === 'create-subcategory') {
                        openCreateSubcategoryModal(currentPlace, currentPlace.parentId || '');
                    }
                    return;
                }
                const modalAction = event.target.closest('[data-modal-action]');
                if (modalAction) {
                    const action = modalAction.dataset.modalAction;
                    if (action === 'cancel') {
                        closeActionModal();
                    } else if (action === 'assign-subcategory') {
                        const select = document.getElementById('existing-subcategory-select');
                        if (select && select.value) {
                            assignPlaceToSubcategory(currentPlace, select.value);
                            closeActionModal();
                        }
                    } else if (action === 'create-subcategory') {
                        createSubcategory();
                    } else if (action === 'create-parent') {
                        createParentCategory();
                    }
                    return;
                }
                if (event.target.id === 'add-category-modal') {
                    closeActionModal();
                }
            });

            document.body.addEventListener('input', (event) => {
                if (event.target.id === 'new-subcategory-slider') {
                    const display = document.getElementById('new-subcategory-amount');
                    if (display) display.textContent = formatCurrency(parseFloat(event.target.value || '0'));
                }
            });

            const sankeyHeroContainer = document.getElementById('sankey-hero-container');
            const sankeyModalEl = document.getElementById('sankey-modal');
            const sankeyModalCloseBtn = document.getElementById('sankey-modal-close');
            const sankeyExpandedWrapper = document.getElementById('sankey-expanded-wrapper');
            const sankeyExpandedSvg = document.getElementById('sankey-expanded');

            const openSankeyModal = () => {
                if (!sankeyModalEl) return;
                sankeyModalEl.classList.remove('hidden');
                sankeyModalEl.classList.add('flex');
                const expandedHeight = sankeyExpandedWrapper?.clientHeight || 360;
                createSankey(sankeyExpandedSvg, { height: expandedHeight, nodePadding: 28 });
                renderSankeyDetails();
                setTimeout(() => sankeyModalCloseBtn?.focus(), 50);
            };

            const closeSankeyModal = () => {
                if (!sankeyModalEl) return;
                sankeyModalEl.classList.add('hidden');
                sankeyModalEl.classList.remove('flex');
            };

            sankeyHeroContainer?.addEventListener('click', openSankeyModal);
            sankeyModalCloseBtn?.addEventListener('click', closeSankeyModal);
            sankeyModalEl?.addEventListener('click', (event) => { if (event.target === sankeyModalEl) closeSankeyModal(); });
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && sankeyModalEl && !sankeyModalEl.classList.contains('hidden')) closeSankeyModal(); });

            window.addEventListener('resize', (() => {
                let resizeTimeout;
                return () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (document.getElementById('budget-view').classList.contains('active')) {
                            createSankey(document.getElementById('sankey-hero'));
                        }
                        if (sankeyModalEl && !sankeyModalEl.classList.contains('hidden')) {
                            const expandedHeight = sankeyExpandedWrapper?.clientHeight || 360;
                            createSankey(sankeyExpandedSvg, { height: expandedHeight, nodePadding: 28 });
                        }
                    }, 200);
                };
            })());

            const fundFlowsHeading = document.querySelector('#budget-view h2.flex');
            if (fundFlowsHeading && !document.getElementById('create-parent-category-btn')) {
                const addParentBtn = document.createElement('button');
                addParentBtn.id = 'create-parent-category-btn';
                addParentBtn.className = 'text-sm font-semibold text-blue-600 hover:text-blue-700';
                addParentBtn.textContent = '+ New parent';
                fundFlowsHeading.appendChild(addParentBtn);
            }
        });

    </script>
</body>
</html>

